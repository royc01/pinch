<template>
  <div class="Pinch-habit-container">
    <!-- ç•ªèŒ„é’Ÿç‹¬ç«‹é¡µé¢ -->
    <div v-if="activePomodoroHabit" class="pomodoro-page">
      <div class="pomodoro-display">
        <h2>{{ activePomodoroHabit.name }}</h2>
        <div class="timer" :class="pomodoroStateClass(activePomodoroHabit.pomodoroState)">{{ formatPomodoroTime(activePomodoroHabit.pomodoroRemaining || 25 * 60) }}</div>
        <div class="pomodoro-controls">
          <button @click="stopCurrentPomodoro" class="stop-btn">åœæ­¢</button>
        </div>
      </div>
    </div>
    
    <!-- ä¹ æƒ¯åˆ—è¡¨é¡µé¢ (å½“æ²¡æœ‰æ¿€æ´»çš„ç•ªèŒ„é’Ÿæ—¶æ˜¾ç¤º) -->
    <div v-else class="habit-list-container">
      <div class="Pinch-habit-header">
        <div class="header-content">
          <div class="date-display">{{ currentDateString.split('/')[0] }}<span>/</span>{{ currentDateString.split('/')[1] }}<span>/</span>{{ currentDateString.split('/')[2] }}</div>
          <SyButton @click="showAddHabitModal = true" id="add-habit-btn">
            <svg t="1767249216319" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1606" width="16" height="16">
              <path d="M512.67794 65.291029C265.701966 65.004503 66.200236 263.518742 65.293587 510.472204c-0.916882 247.286036 198.739367 447.915449 446.048939 448.236767 247.38632 0.322341 447.196065-199.272509 447.366957-446.883957C958.882422 265.25734 759.426741 65.579601 512.67794 65.291029zM772.621251 544.93204c-0.64059 26.420743-15.491833 41.562605-41.989323 41.606607-47.989991 0.080841-95.982028 0.124843-143.972019 0.151449 0.01228 45.808302 0.017396 91.615581-0.026606 137.418766-0.033769 35.107589-13.380752 48.577369-48.030923 48.683792-19.839861 0.061398-39.694047 0.370437-59.528791-0.11154-26.414603-0.642636-41.552371-15.495926-41.596374-41.999556-0.079818-47.998177-0.12382-95.996354-0.150426-143.993508-47.941895-0.027629-95.882767-0.072655-143.826709-0.154519-26.546609-0.044002-41.48381-15.205307-42.060955-41.548278-0.478907-21.701255-0.385786-43.417859-0.038886-65.119113 0.438998-27.465538 15.230889-42.333154 42.967604-42.441625 47.653323-0.176009 95.307669-0.155543 142.959969-0.122797 0.027629-47.950082 0.072655-95.89914 0.154519-143.851269 0.041956-26.552749 15.20019-41.49302 41.537022-42.070164 21.694091-0.477884 43.408649-0.385786 65.103764-0.037862 27.460422 0.438998 42.323944 15.233959 42.432415 42.977837 0.176009 47.667649 0.155543 95.335299 0.122797 143.001925 45.796022-0.01228 91.591021-0.017396 137.38295 0.026606 35.100426 0.033769 48.565089 13.382798 48.671513 48.039109C772.796236 505.231853 773.105275 525.093203 772.621251 544.93204z" p-id="1607"></path>
            </svg>
          </SyButton>
        </div>
      </div>

      <div class="habit-list">
        <div v-if="habits.length === 0" class="empty-state">
          {{ t('habitTracker.noHabits') }}
        </div>
        <div v-else class="habits-grid">
          <div v-for="habit in sortedHabits" :key="habit.id" class="habit-card">
            <div class="habit-week-view">
              <div class="week-habit-item">
                <div class="emoji-section" @click="showHabitStats(habit)">
                  <span class="habit-emoji">{{ habit.emoji || 'ğŸ“' }}</span>
                </div>
                <div class="habit-info" @click="showHabitStats(habit)">
                  <div class="habit-title">{{ habit.usePomodoro ? 'ğŸ… ' : '' }}{{ habit.name }}</div>
                  <div class="week-checkboxes">
                    <div 
                      v-for="(day, index) in getCalendarViewData(habit)" 
                      :key="index" 
                      :class="['day-checkbox', { completed: day.completed, today: day.isToday, past: day.isPast, future: day.isFuture, 'completed-by-weekly-rule': day.isCompletedByWeeklyRule }]"
                      :title="day.date"
                      @click="toggleDayCompletion(habit, day.date)"
                    >
                      <svg
                        class="day-checkbox-icon"
                        :class="{ completed: day.completed }"
                        :viewBox="day.completed ? '0 0 1024 1024' : '0 0 1024 1024'"
                        :width="16"
                        :height="16"
                        xmlns="http://www.w3.org/2000/svg"
                        :fill="day.completed ? `var(--b3-theme-on-background)` : `var(--b3-theme-on-background)`">
                        <path 
                          v-if="!day.completed"
                          d="M950.848 237.728l0 548.576q0 68-48.288 116.288t-116.288 48.288l-548.576 0q-68 0-116.288-48.288t-48.288-116.288l0-548.576q0-68 48.288-116.288t116.288-48.288l548.576 0q68 0 116.288 48.288t48.288 116.288z"
                        ></path>
                        <path 
                          v-else
                          d="M796.16 133.12h-568.32C175.616 133.12 133.12 175.616 133.12 227.84v568.32c0 52.224 42.496 94.72 94.72 94.72h568.32c52.224 0 94.72-42.496 94.72-94.72v-568.32c0-52.224-42.496-94.72-94.72-94.72z m-75.776 306.176l-238.592 238.592c-15.872 15.872-42.496 15.872-59.904 0l-118.272-118.272c-15.872-15.872-15.872-42.496 0-59.904 15.872-15.872 42.496-15.872 59.904 0l90.112 90.112 208.384-208.384c15.872-15.872 42.496-15.872 59.904 0 14.336 15.36 14.336 41.984-1.536 57.856z"
                        ></path>
                      </svg>
                    </div>
                  </div>
                </div>
                <div class="habit-actions">
                  <SyButton @click="toggleHabit(habit.id)" :type="habit.completedToday || (habit.frequency && habit.frequency.startsWith('weekly') && getWeeklyCompletionStatus(habit)) ? 'success' : 'default'" size="small" class="check-in-btn">
                    <svg v-if="habit.usePomodoro && habit.pomodoroRemaining !== undefined" :class="{'completed': habit.completedToday}" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      <path d="M417.79639 1024c-31.740625 0-62.423229-12.901028-85.153612-36.177486l-297.372113-305.324334a125.972738 125.972738 0 0 1 0.03413-174.812345 118.293555 118.293555 0 0 1 170.307224 0l191.60416 196.826004L802.165119 56.968961C838.103697-0.471331 912.608842-17.194886 968.547427 19.733454c55.972715 36.860081 72.218454 113.310618 36.279876 170.68265L519.161612 967.139913a120.170689 120.170689 0 0 1-88.464194 56.211623 130.37547 130.37547 0 0 1-12.901028 0.648464z"></path>
                    </svg>
                    <svg v-else-if="!habit.usePomodoro && (habit.completedToday || (habit.timesPerDay && habit.timesPerDay > 1 && getTodayCompletionCount(habit) === 0) || !habit.timesPerDay || habit.timesPerDay <= 1)" :class="{'completed': habit.completedToday}" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      <path d="M417.79639 1024c-31.740625 0-62.423229-12.901028-85.153612-36.177486l-297.372113-305.324334a125.972738 125.972738 0 0 1 0.03413-174.812345 118.293555 118.293555 0 0 1 170.307224 0l191.60416 196.826004L802.165119 56.968961C838.103697-0.471331 912.608842-17.194886 968.547427 19.733454c55.972715 36.860081 72.218454 113.310618 36.279876 170.68265L519.161612 967.139913a120.170689 120.170689 0 0 1-88.464194 56.211623 130.37547 130.37547 0 0 1-12.901028 0.648464z"></path>
                    </svg>
                    <span class="check-in-count" v-else-if="habit.timesPerDay && habit.timesPerDay > 1 && getTodayCompletionCount(habit) > 0 && getTodayCompletionCount(habit) < habit.timesPerDay">
                      {{ getTodayCompletionCount(habit) }}
                    </span>
                    <span class="pomodoro-timer" v-else-if="habit.usePomodoro && habit.pomodoroRemaining !== undefined">
                      {{ formatPomodoroTime(habit.pomodoroRemaining) }}
                    </span>
                    <svg v-else :class="{'completed': habit.completedToday}" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      <path d="M417.79639 1024c-31.740625 0-62.423229-12.901028-85.153612-36.177486l-297.372113-305.324334a125.972738 125.972738 0 0 1 0.03413-174.812345 118.293555 118.293555 0 0 1 170.307224 0l191.60416 196.826004L802.165119 56.968961C838.103697-0.471331 912.608842-17.194886 968.547427 19.733454c55.972715 36.860081 72.218454 113.310618 36.279876 170.68265L519.161612 967.139913a120.170689 120.170689 0 0 1-88.464194 56.211623 130.37547 130.37547 0 0 1-12.901028 0.648464z"></path>
                    </svg>
                  </SyButton>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¹ æƒ¯ç»Ÿè®¡é¢æ¿ -->
    <div v-if="selectedHabit" class="stats-panel">
      <div class="stats-header">
        <div class="stats-emoji">{{ selectedHabit.emoji || 'ğŸ“' }}</div>
        <div class="stats-title">{{ selectedHabit.name }}</div>
        <div class="stats-header-buttons">
          <button @click="openEditHabitModal" class="icon-button">
            <svg class="icon" viewBox="0 0 200 200" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M0,190c0-5.5,4.5-10,10-10h0h180c5.5,0,10,4.5,10,10c0,5.5-4.5,10-10,10c0,0,0,0,0,0H10C4.5,200,0,195.5,0,190 L0,190L0,190z M133.5,0c2.7,0,5.2,1.1,7.1,2.9l36.5,36.5c3.9,3.9,3.9,10.2,0,14.1L73.7,157.1c-1.9,1.9-4.4,2.9-7.1,2.9H30 c-5.5,0-10-4.5-10-10l0,0v-36.4c0-2.7,1-5.2,2.9-7.1L126.4,2.9C128.3,1.1,130.8,0,133.5,0z" fill="var(--b3-theme-on-background)"></path>
            </svg>
          </button>
          <button @click="closeHabitStats" class="icon-button">
            <svg class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M39.156558 39.219619a133.725281 133.725281 0 0 1 189.221272 0L984.594293 795.703532a133.725281 133.725281 0 0 1-189.221272 189.087547L39.156558 228.307166a133.725281 133.725281 0 0 1 0-189.087547z m0 756.483913L795.373021 39.219619a133.725281 133.725281 0 0 1 189.221272 189.087547L228.37783 984.791079a133.792143 133.792143 0 1 1-189.221272-189.288135z" :fill="`var(--b3-theme-on-background)`" ></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="stats-content">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">{{ calculateCurrentMonthStreak(selectedHabit) }}</div>
            <div class="stat-label">{{ t('habitTracker.currentStreak') }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ calculateTotalMonthCompletions(selectedHabit) }}</div>
            <div class="stat-label">{{ t('habitTracker.totalCompletions') }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ calculateCompletionRate(selectedHabit) }}%</div>
            <div class="stat-label">{{ t('habitTracker.completionRate') }}</div>
          </div>
        </div>
        
        <!-- æ—¥å†æ§ä»¶ -->
        <div class="calendar-controls">
          <div class="calendar-navigation">
            <button @click="changeStatsCalendarPeriod(selectedHabit, -1)" class="nav-btn">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                <path d="M747.245 81.064c-28.497-29.315-74.739-29.315-103.307 0l-367.236 378.011c-28.483 29.367-28.483 76.982 0 106.291l367.236 377.997c28.562 29.367 74.806 29.367 103.307 0 28.546-29.325 28.546-76.929 0-106.304l-315.6-324.841 315.599-324.803c28.545-29.367 28.544-76.973 0-106.356l0 0z" :fill="`var(--b3-theme-on-background)`"></path>
              </svg>
            </button>
            <span class="current-period">{{ getCurrentPeriodText(selectedHabit) }}</span>
            <button @click="changeStatsCalendarPeriod(selectedHabit, 1)" class="nav-btn">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                <path d="M276.755 942.936c28.497 29.315 74.739 29.315 103.307 0l367.236-378.011c28.483-29.367 28.483-76.982 0-106.291l-367.236-377.997c-28.562-29.367-74.806-29.367-103.307 0-28.546 29.325-28.546 76.929 0 106.304l315.6 324.841-315.599 324.803c-28.545 29.367-28.544 76.973 0 106.356l0 0z" :fill="`var(--b3-theme-on-background)`"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- æœˆè§†å›¾ -->
        <div class="calendar-view">
          <div class="month-view">
            <div class="weekdays-header">
              <div v-for="(day, index) in weekdaysForCalendar" :key="index" class="weekday">{{ day }}</div>
            </div>
            <div class="month-grid">
              <div 
                v-for="(day, index) in getStatsMonthViewData(selectedHabit)" 
                :key="index" 
                :class="['day', { completed: day.completed, today: day.date === new Date().toISOString().split('T')[0], 'not-current-month': !day.isCurrentMonth }]"
                @click="toggleDayCompletion(selectedHabit, day.date)"
              >
                <span class="day-number">{{ day.date.split('-')[2] }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="stats-actions">
          <SyButton @click="deleteHabit(selectedHabit.id)" class="confirm-button" icon="iconTrashcan">
            {{ t('habitTracker.delete') }}
          </SyButton>
        </div>
      </div>
    </div>
    
    <!-- ç¼–è¾‘ä¹ æƒ¯æ¨¡æ€æ¡† -->
    <div v-show="showEditHabitModal" class="modal-overlay" @click.self="closeEditHabitModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>ç¼–è¾‘ä¹ æƒ¯</h3>
          <button @click="closeEditHabitModal" class="icon-button">
            <svg class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M39.156558 39.219619a133.725281 133.725281 0 0 1 189.221272 0L984.594293 795.703532a133.725281 133.725281 0 0 1-189.221272 189.087547L39.156558 228.307166a133.725281 133.725281 0 0 1 0-189.087547z m0 756.483913L795.373021 39.219619a133.725281 133.725281 0 0 1 189.221272 189.087547L228.37783 984.791079a133.792143 133.792143 0 1 1-189.221272-189.288135z" :fill="`var(--b3-theme-on-background)`"></path>
            </svg>
          </button>
        </div>
        <div class="modal-body" v-if="editedHabit">
          <div class="form-group">
            <label>ä¹ æƒ¯åç§°</label>
            <SyInput v-model="editedHabit.name" placeholder="è¾“å…¥ä¹ æƒ¯åç§°" />
          </div>
          <div class="form-group">
            <label>é€‰æ‹©å›¾æ ‡</label>
            <div class="emoji-selector">
              <SyInput v-model="editedHabit.emoji" placeholder="é€‰æ‹©æˆ–è¾“å…¥emoji" />
              <SyButton 
                @click="showEmojiPicker = !showEmojiPicker" 
                type="default" 
                size="small" 
                class="emoji-picker-btn">
                {{ editedHabit.emoji || 'ğŸ“' }}
              </SyButton>
              <div class="emoji-picker" v-if="showEmojiPicker">
                <div class="emoji-categories">
                  <div 
                    v-for="(emojis, category) in emojiCategories" 
                    :key="category" 
                    class="emoji-category">
                    <h4>{{ category }}</h4>
                    <div class="emoji-options-grid">
                      <div class="emoji-option" v-for="emoji in emojis" :key="emoji" @click="selectEmojiForEdit(emoji)">
                        {{ emoji }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>{{ t('habitTracker.frequency') }}</label>
            <SySelect v-model="editedHabit.frequency" :options="frequencyOptions" />
          </div>
          <div class="form-group">
            <label>{{ t('habitTracker.timesPerDay') }}</label>
            <SySelect :modelValue="editedHabit.timesPerDay?.toString()" @update:modelValue="onTimesPerDayChange" :options="timesPerDayOptions" />
          </div>
          
          <div class="form-group">
            <label>
              <input 
                type="checkbox" 
                v-model="editedHabit.usePomodoro" 
                class="pomodoro-checkbox"
              >
              å¯ç”¨ç•ªèŒ„é’ŸåŠŸèƒ½
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <SyButton @click="saveEditedHabit" class="confirm-button">ä¿å­˜</SyButton>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ ä¹ æƒ¯æ¨¡æ€æ¡† -->
    <div v-show="showAddHabitModal" class="modal-overlay" @click.self="showAddHabitModal = false">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>{{ t('habitTracker.addHabit') }}</h3>
          <button @click="showAddHabitModal = false" class="icon-button">
                      <svg class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                        <path d="M39.156558 39.219619a133.725281 133.725281 0 0 1 189.221272 0L984.594293 795.703532a133.725281 133.725281 0 0 1-189.221272 189.087547L39.156558 228.307166a133.725281 133.725281 0 0 1 0-189.087547z m0 756.483913L795.373021 39.219619a133.725281 133.725281 0 0 1 189.221272 189.087547L228.37783 984.791079a133.792143 133.792143 0 1 1-189.221272-189.288135z" :fill="`var(--b3-theme-on-background)`" p-id="23336"></path>
                      </svg>
                    </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>{{ t('habitTracker.habitName') }}</label>
            <SyInput v-model="newHabit.name" :placeholder="t('habitTracker.habitNamePlaceholder')" />
          </div>
          <div class="form-group">
            <label>é€‰æ‹©å›¾æ ‡</label>
            <div class="emoji-selector">
              <SyInput v-model="newHabit.emoji" placeholder="é€‰æ‹©æˆ–è¾“å…¥emoji" />
              <SyButton 
                @click="showEmojiPicker = !showEmojiPicker" 
                type="default" 
                size="small" 
                class="emoji-picker-btn">
                ğŸ“
              </SyButton>
              <div class="emoji-picker" v-if="showEmojiPicker">
                <div class="emoji-categories">
                  <div 
                    v-for="(emojis, category) in emojiCategories" 
                    :key="category" 
                    class="emoji-category">

                    <h4>{{ category }}</h4>
                    <div class="emoji-options-grid">
                      <div class="emoji-option" v-for="emoji in emojis" :key="emoji" @click="selectEmoji(emoji)">
                        {{ emoji }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>{{ t('habitTracker.frequency') }}</label>
            <SySelect v-model="newHabit.frequency" :options="frequencyOptions" />
          </div>
          <div class="form-group">
            <label>{{ t('habitTracker.timesPerDay') }}</label>
            <SySelect v-model="newHabit.timesPerDay" :options="timesPerDayOptions" />
          </div>
          
          <div class="form-group">
            <label>
              <input 
                type="checkbox" 
                v-model="newHabit.usePomodoro" 
                class="pomodoro-checkbox"
              >
              å¯ç”¨ç•ªèŒ„é’ŸåŠŸèƒ½
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <SyButton @click="addHabit" class="confirm-button">{{ t('OK') }}</SyButton>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.emoji-selector {
  position: relative;
  display: flex;
  align-items: center;
}

.emoji-picker-btn {
  margin-left: 8px;
  border: none;
  border-radius: 6px;
  height: 28px;
  width: 30px;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.pomodoro-checkbox {
  margin-right: 8px;
}

.pomodoro-timer {
  font-family: monospace;
  font-weight: bold;
  color: #e74c3c;
}



.pomodoro-label {
  font-size: 12px;
  color: #3498db;
}

.date-display {
  font-weight: bold;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.date-display span {
  color: oklch(68.98% 0.161 30.76 / 0.3);
}

.emoji-picker {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 1000;
  background: white;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  overflow-y: auto;
  width: 480px;
}

.emoji-categories {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 300px;
  overflow-y: auto;
}

.emoji-category {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.emoji-category .emoji-option {
  display: inline-block;
  font-size: 20px;
  padding: 4px;
  cursor: pointer;
  border-radius: 4px;
  margin: 2px;
}

.emoji-category .emoji-options-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
  gap: 4px;
}

.emoji-category h4 {
  margin: 0 0 4px 0;
  font-size: 12px;
  color: #666;
  padding: 0 4px;
}

.emoji-option {
  display: inline-block;
  font-size: 20px;
  padding: 4px;
  cursor: pointer;
  border-radius: 4px;
}

.emoji-option:hover {
  background-color: #f0f0f0;
}

.icon-button {
  width: 28px;
  height: 28px;
  border: none;
  background: none;
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.icon-button .icon {
  width: 16px;
  height: 16px;
  color: var(--b3-theme-on-background);
  fill: var(--b3-theme-on-background);
}

.icon-button:hover {
  background-color: var(--b3-list-hover);
  border-radius: 4px;
}

.day-checkbox {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 4px;
}

.day-checkbox-icon {
  width: 16px;
  height: 16px;
}

.day-checkbox.past:not(.completed) .day-checkbox-icon,
.day-checkbox.today:not(.completed) .day-checkbox-icon,
.day-checkbox.past.completed-by-weekly-rule .day-checkbox-icon,
.day-checkbox.future.completed-by-weekly-rule .day-checkbox-icon{
  color: oklch(68.98% 0.161 30.76 / 0.3);
}

.day-checkbox.completed .day-checkbox-icon {
  color: oklch(68.98% 0.161 30.76 );
}

.day-checkbox.future .day-checkbox-icon {
  color: var(--b3-list-hover) 
}

.week-habit-item {
  display: flex;
  align-items: center;
  padding: 6px;
}

.confirm-button {
  background-color: #ee6f5b;
  color: var(--b3-theme-background);
  font-weight: bold;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
}

.confirm-button:hover {
  background-color: #e55a47;
}

.confirm-button:active {
  background-color: #dc4a38;
}

.emoji-section {
  text-align: center;
  font-size: 32px;
  width: 50px;
  height: 50px;
  border-radius: 10px;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: var(--b3-list-hover);
}

.habit-info {
  flex: 1;
  margin: 0 6px;
}

.habit-title {
  font-weight: bold;
  margin-bottom: 8px;
  margin-left: 2px;
}

.week-checkboxes {
  display: flex;
}

.day-checkbox {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  padding: 1px;
  transition: background-color 0.2s;
}

.day-checkbox-input {
  margin: 0 0 4px 0;
}

.day-label {
  font-size: 12px;
}

.check-in-btn {
  background-color: var(--b3-list-hover);
  border-radius: 8px;
  border: none;
  padding: 0;
  min-width: auto;
  width: 26px;
  height: 26px;
  margin-right: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.check-in-btn .icon {
  width: 12px;
  height: 12px;
  color: var(--b3-theme-background);
  transition: color 0.3s, fill 0.3s;
}

.check-in-btn[type="success"] {
  background-color: oklch(68.98% 0.161 30.76);
}

.check-in-count {
  font-weight: bold;
  font-size: 16px;
}

</style>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, computed } from 'vue';
import SyButton from '@/components/SiyuanTheme/SyButton.vue';
import SyInput from '@/components/SiyuanTheme/SyInput.vue';
import SySelect from '@/components/SiyuanTheme/SySelect.vue';
import { getHabits, saveHabits, Habit, getEmojiConf } from '@/api';

// å½“å¤©æ—¥å†ç›¸å…³
const currentDayInfo = ref({
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  date: `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(new Date().getDate()).padStart(2, '0')}`,
  dayOfWeek: new Date().getDay(),
  dayOfMonth: new Date().getDate(),
  month: new Date().getMonth() + 1,
  year: new Date().getFullYear(),
});

// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD æ ¼å¼
const formatDate = (date: Date): string => {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
};

// è·å–ä»Šå¤©æ—¥æœŸçš„å‡½æ•°
const getToday = () => {
  const today = new Date();
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  return formatDate(today);
};

// æ£€æŸ¥æ˜¯å¦ä¸ºä»Šå¤©
const isToday = (dateString: string) => {
  return dateString === getToday();
};

// const plugin = usePlugin(); // Removed unused plugin variable

// è¡¨æƒ…é€‰æ‹©ç›¸å…³
const showEmojiPicker = ref(false);

// ä»æ€æºç¬”è®°è·å–å†…ç½®emojié…ç½®
const emojiCategories = ref<Record<string, string[]>>({});
const commonEmojis = ref<string[]>([]);

// å°†åå…­è¿›åˆ¶ä»£ç è½¬æ¢ä¸ºemojiå­—ç¬¦
const convertHexToEmoji = (hexCode: string): string => {
  try {
    // å¦‚æœå·²ç»æ˜¯emojiå­—ç¬¦ï¼Œç›´æ¥è¿”å›
    if (/[^\u0000-\u00ff]/.test(hexCode)) {
      return hexCode;
    }
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ–‡ä»¶æ‰©å±•åï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›åŸå€¼
    if (typeof hexCode === 'string' && (hexCode.includes('.') || hexCode.includes('/'))) {
      // è¿™æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œä¸æ˜¯emojiä»£ç ï¼Œç›´æ¥è¿”å›
      return hexCode;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯åå…­è¿›åˆ¶ä»£ç 
    if (typeof hexCode === 'string') {
      // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„emojiåå…­è¿›åˆ¶ä»£ç æ ¼å¼
      // é€šå¸¸emojiä»£ç ç”±åå…­è¿›åˆ¶æ•°å­—å’Œå¯èƒ½çš„è¿å­—ç¬¦ç»„æˆï¼Œå¦‚'1f600'æˆ–'1f1f7-1f1f8'
      const hexPattern = /^[0-9a-fA-F]+(-[0-9a-fA-F]+)*$/;
      if (hexPattern.test(hexCode)) {
        // ç§»é™¤å¯èƒ½çš„å‰ç¼€
        let cleanHex = hexCode.replace(/^U\+|0x|\\u/g, '').replace(/-/g, ' ');
        
        // å°†åå…­è¿›åˆ¶ä»£ç è½¬æ¢ä¸ºå­—ç¬¦
        const codePoints = cleanHex.split(' ').map(h => parseInt(h, 16));
        
        // æ£€æŸ¥codePointsæ•°ç»„æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„æ•°å€¼
        if (codePoints.some(isNaN)) {
          // å¦‚æœåŒ…å«NaNå€¼ï¼Œè¿”å›åŸå€¼
          return hexCode;
        }
        
        return String.fromCodePoint(...codePoints);
      }
    }
    
    // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„åå…­è¿›åˆ¶ä»£ç æ ¼å¼ï¼Œç›´æ¥è¿”å›åŸå€¼
    return hexCode;
  } catch (error) {
    console.warn('æ— æ³•è½¬æ¢åå…­è¿›åˆ¶ä»£ç åˆ°emoji:', hexCode, error);
    return hexCode;
  }
};

// è·å–æ€æºç¬”è®°å†…ç½®emoji
const loadSiyuanEmojis = async () => {
  try {
    const emojiConf: any = await getEmojiConf();
    if (emojiConf) {
      // æŒ‰ç±»åˆ«ç»„ç»‡emoji
      const categories: Record<string, string[]> = {};
      
      // æ£€æŸ¥emojiConfæ˜¯å¦ä¸ºæ•°ç»„ï¼ˆæ€æºAPIè¿”å›çš„æ˜¯å¯¹è±¡æ•°ç»„ï¼‰
      if (Array.isArray(emojiConf)) {
        // éå†æ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡
        for (const emojiCategory of emojiConf) {
          if (emojiCategory && typeof emojiCategory === 'object') {
            // æ£€æŸ¥æ˜¯å¦æœ‰itemså±æ€§ï¼ˆè¿™æ˜¯æ€æºAPIå®é™…è¿”å›çš„æ ¼å¼ï¼‰
            if (emojiCategory.items && Array.isArray(emojiCategory.items)) {
              // éå†itemsæ•°ç»„ï¼Œå°è¯•è·å–emojiå­—ç¬¦
              const emojis = [];
              for (const item of emojiCategory.items) {
                // æ€æºç¬”è®°APIçš„emojié…ç½®é€šå¸¸åŒ…å«å¤šä¸ªå±æ€§ï¼Œå…¶ä¸­å¯èƒ½æœ‰unicodeã€chã€emojiç­‰
                if (item && typeof item === 'object') {
                  // ä¼˜å…ˆå°è¯•è·å–emojiå­—ç¬¦çš„å„ç§å¯èƒ½å±æ€§
                  if (item.ch) {
                    emojis.push(item.ch);
                  } else if (item.unicode) {
                    // å¦‚æœæ˜¯åå…­è¿›åˆ¶ä»£ç ï¼Œè½¬æ¢ä¸ºemojiå­—ç¬¦
                    emojis.push(convertHexToEmoji(item.unicode));
                  } else if (item.emoji) {
                    emojis.push(item.emoji);
                  } else if (item.text) {
                    emojis.push(item.text);
                  } else {
                    // ä½œä¸ºæœ€åçš„å°è¯•ï¼Œéå†å¯¹è±¡çš„å€¼ï¼Œå¯»æ‰¾å¯èƒ½çš„emojiå­—ç¬¦ä¸²
                    const values = Object.values(item);
                    for (const val of values) {
                      if (typeof val === 'string' && val.length <= 5) { // emojié€šå¸¸å¾ˆçŸ­
                        // æ£€æŸ¥æ˜¯å¦ä¸ºemojiå­—ç¬¦ï¼Œä½¿ç”¨æ›´é€šç”¨çš„æ­£åˆ™è¡¨è¾¾å¼
                        const emojiRegex = /(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|\ud83c[\udde6-\uddff]|\ud83c[\udff0-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|\ud83e[\udd10-\uddff])|[^ -Ã¿]/u;
                        if (emojiRegex.test(val)) {
                          emojis.push(val);
                          break; // æ‰¾åˆ°ä¸€ä¸ªå°±è·³å‡º
                        }
                      }
                    }
                  }
                } else if (typeof item === 'string') {
                  // å¦‚æœé¡¹ç›®æœ¬èº«å°±æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
                  emojis.push(item);
                }
              }
              // ä½¿ç”¨titleä½œä¸ºåˆ†ç±»åç§°ï¼Œå¦‚æœæ²¡æœ‰titleåˆ™ä½¿ç”¨id
              const categoryName = emojiCategory.title_zh_cn || emojiCategory.title || emojiCategory.id;
              // å¦‚æœåˆ†ç±»åç§°æ˜¯'è‡ªå®šä¹‰'æˆ–'Custom'ï¼Œåˆ™è·³è¿‡è¿™ä¸ªåˆ†ç±»
              if (categoryName && categoryName !== 'è‡ªå®šä¹‰' && categoryName !== 'Custom') {
                categories[categoryName] = emojis;
              }
            }
          }
        }
      } else {
        // å¦‚æœä¸æ˜¯æ•°ç»„ï¼ŒæŒ‰åŸæ¥çš„é€»è¾‘å¤„ç†
        for (const category in emojiConf) {
          if (Array.isArray(emojiConf[category])) {
            // æ ¹æ®æ€æºAPIçš„è¿”å›æ ¼å¼ï¼Œè·å–æ¯ä¸ªemojiçš„å­—ç¬¦
            const emojis = emojiConf[category].map((item: any) => item.ch);
            categories[category] = emojis;
          } else {
            // å°è¯•ä»itemså±æ€§è·å–emoji
            
            if (emojiConf[category] && typeof emojiConf[category] === 'object') {
              // æ£€æŸ¥æ˜¯å¦æœ‰itemså±æ€§ï¼ˆè¿™æ˜¯æ€æºAPIå®é™…è¿”å›çš„æ ¼å¼ï¼‰
              if (emojiConf[category].items && Array.isArray(emojiConf[category].items)) {
                // éå†itemsæ•°ç»„ï¼Œå°è¯•è·å–emojiå­—ç¬¦
                const emojis = [];
                for (const item of emojiConf[category].items) {
                  // æ€æºç¬”è®°APIçš„emojié…ç½®é€šå¸¸åŒ…å«å¤šä¸ªå±æ€§ï¼Œå…¶ä¸­å¯èƒ½æœ‰unicodeã€chã€emojiç­‰
                  if (item && typeof item === 'object') {
                    // ä¼˜å…ˆå°è¯•è·å–emojiå­—ç¬¦çš„å„ç§å¯èƒ½å±æ€§
                    if (item.ch) {
                      emojis.push(item.ch);
                    } else if (item.unicode) {
                      // å¦‚æœæ˜¯åå…­è¿›åˆ¶ä»£ç ï¼Œè½¬æ¢ä¸ºemojiå­—ç¬¦
                      emojis.push(convertHexToEmoji(item.unicode));
                    } else if (item.emoji) {
                      emojis.push(item.emoji);
                    } else if (item.text) {
                      emojis.push(item.text);
                    } else {
                      // ä½œä¸ºæœ€åçš„å°è¯•ï¼Œéå†å¯¹è±¡çš„å€¼ï¼Œå¯»æ‰¾å¯èƒ½çš„emojiå­—ç¬¦ä¸²
                      const values = Object.values(item);
                      for (const val of values) {
                        if (typeof val === 'string' && val.length <= 5) { // emojié€šå¸¸å¾ˆçŸ­
                          // æ£€æŸ¥æ˜¯å¦ä¸ºemojiå­—ç¬¦ï¼Œä½¿ç”¨æ›´é€šç”¨çš„æ­£åˆ™è¡¨è¾¾å¼
                          const emojiRegex = /(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|\ud83c[\udde6-\uddff]|\ud83c[\udff0-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|\ud83e[\udd10-\uddff])|[^ -Ã¿]/u;
                          if (emojiRegex.test(val)) {
                            emojis.push(val);
                            break; // æ‰¾åˆ°ä¸€ä¸ªå°±è·³å‡º
                          }
                        }
                      }
                    }
                  } else if (typeof item === 'string') {
                    // å¦‚æœé¡¹ç›®æœ¬èº«å°±æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
                    emojis.push(item);
                  }
                }
                // ä½¿ç”¨titleä½œä¸ºåˆ†ç±»åç§°ï¼Œå¦‚æœæ²¡æœ‰titleåˆ™ä½¿ç”¨id
                const categoryName = emojiConf[category].title_zh_cn || emojiConf[category].title || emojiConf[category].id || category;
                // å¦‚æœåˆ†ç±»åç§°æ˜¯'è‡ªå®šä¹‰'æˆ–'Custom'ï¼Œåˆ™è·³è¿‡è¿™ä¸ªåˆ†ç±»
                if (categoryName !== 'è‡ªå®šä¹‰' && categoryName !== 'Custom') {
                  categories[categoryName] = emojis;
                }
              } else if (emojiConf[category].ch) {
                // å¦‚æœç›´æ¥æœ‰chå±æ€§
                categories[category] = [emojiConf[category].ch];
              } else {
                // å¦‚æœæ²¡æœ‰itemså±æ€§ï¼Œå°è¯•è·å–å¯¹è±¡ä¸­çš„æ‰€æœ‰å¯èƒ½çš„emojiå€¼
                const emojiValues = Object.values(emojiConf[category]).filter(value => typeof value === 'string');
                categories[category] = emojiValues as string[];
              }
            } else {
              // å¦‚æœæ˜¯å…¶ä»–ç±»å‹ï¼Œè·³è¿‡è¿™ä¸ªç±»åˆ«
              categories[category] = [];
            }
          }
        }
      }
      
      emojiCategories.value = categories;
      
      // å°†æ‰€æœ‰emojiåˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„
      const allEmojis: string[] = [];
      for (const category in categories) {
        allEmojis.push(...categories[category]);
      }
      commonEmojis.value = allEmojis;
    }
  } catch (error) {
    console.error('è·å–æ€æºç¬”è®°emojié…ç½®å¤±è´¥:', error);
  }
};

// ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ€æºç¬”è®°emoji
onMounted(() => {
  loadSiyuanEmojis();
});

// é€‰æ‹©emoji
const selectEmoji = (emoji: string) => {
  newHabit.value.emoji = emoji;
  showEmojiPicker.value = false;
};


// å›½é™…åŒ–å‡½æ•°
const t = (key: string) => {
  // ä»æ€æºç¬”è®°è·å–è¯­è¨€èµ„æº
  const lang = window.siyuan?.languages || {};
  
  // å¦‚æœæ€æºç¬”è®°è¯­è¨€èµ„æºä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¿”å›é»˜è®¤ä¸­æ–‡æ–‡æœ¬
  const defaultLang = {
    'habitTracker.title': 'ä¹ æƒ¯æ‰“å¡',
    'habitTracker.addHabit': 'æ·»åŠ ä¹ æƒ¯',
    'habitTracker.habitName': 'ä¹ æƒ¯åç§°',
    'habitTracker.habitNamePlaceholder': 'ä¾‹å¦‚ï¼šæ™¨è·‘ã€è¯»ä¹¦ã€å–æ°´',
    'habitTracker.frequency': 'æ‰“å¡å‘¨æœŸ',
    'habitTracker.customFrequency': 'æ¯å‘¨å¤©æ•°',
    'habitTracker.customFrequencyPlaceholder': 'è¾“å…¥æ¯å‘¨è¦æ‰“å¡çš„å¤©æ•°',
    'habitTracker.timesPerDay': 'æ¯å¤©é¢‘ç‡',
    'habitTracker.timesPerDayPlaceholder': 'è¾“å…¥æ¯å¤©è¦å®Œæˆçš„æ¬¡æ•°',
    'habitTracker.reminderTime': 'æé†’æ—¶é—´',
    'habitTracker.daily': 'æ¯å¤©',
    'habitTracker.weekly': 'æ¯å‘¨6å¤©',
    'habitTracker.custom': 'è‡ªå®šä¹‰',
    'habitTracker.checkIn': 'æ‰“å¡',
    'habitTracker.checkedIn': 'å·²æ‰“å¡',
    'habitTracker.delete': 'åˆ é™¤',
    'habitTracker.currentStreak': 'è¿ç»­å¤©æ•°',
    'habitTracker.totalCompletions': 'æœ¬æœˆæ‰“å¡',
    'habitTracker.completionRate': 'æœ¬æœˆå®Œæˆç‡',
    'habitTracker.days': 'å¤©',
    'habitTracker.times': 'æ¬¡',
    'habitTracker.noHabits': 'æš‚æ— ä¹ æƒ¯ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ–°ä¹ æƒ¯',
    'habitTracker.confirmDelete': 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿ',
    'habitTracker.weekView': 'å‘¨è§†å›¾',
    'habitTracker.monthView': 'æœˆè§†å›¾',
    'Cancel': 'å–æ¶ˆ',
    'OK': 'ç¡®å®š',
  };
  
  return lang[key] || defaultLang[key] || key;
};

// ä¹ æƒ¯æ•°æ®
const habits = ref<Habit[]>([]);
const showAddHabitModal = ref(false);
// const weekdays = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥']; // å·²æ³¨é‡Šï¼šæ­¤å˜é‡æœªè¢«ä½¿ç”¨ï¼Œä½¿ç”¨çš„æ˜¯ weekdaysForCalendar è®¡ç®—å±æ€§

// å½“å‰æ—¥æœŸè¿½è¸ªï¼ˆç”¨äºç¡®ä¿æ—¥æœŸç›¸å…³è®¡ç®—èƒ½å¤Ÿå“åº”æ—¥æœŸå˜åŒ–ï¼‰
const currentDate = ref(new Date().toISOString().split('T')[0]);

// ç•ªèŒ„é’Ÿç›¸å…³æ•°æ®
const activePomodoroHabit = ref<Habit | null>(null);

// æ£€æŸ¥å‘¨ç›®æ ‡æ˜¯å¦å·²å®Œæˆ
const getWeeklyCompletionStatus = (habit: Habit) => {
  if (!habit.frequency || !habit.frequency.startsWith('weekly')) {
    return false;
  }
  
  // ç¡®å®šæ¯å‘¨éœ€è¦å®Œæˆçš„æ¬¡æ•°
  let requiredWeekCompletions = 1; // é»˜è®¤ä¸º1æ¬¡
  if (habit.frequency === 'weekly2') requiredWeekCompletions = 2;
  else if (habit.frequency === 'weekly3') requiredWeekCompletions = 3;
  else if (habit.frequency === 'weekly4') requiredWeekCompletions = 4;
  else if (habit.frequency === 'weekly5') requiredWeekCompletions = 5;
  else if (habit.frequency === 'weekly6') requiredWeekCompletions = 6;
  
  // è®¡ç®—æœ¬å‘¨çš„å‘¨ä¸€å’Œå‘¨æ—¥
  const today = new Date();
  const todayWeekday = today.getDay();
  const daysToMonday = todayWeekday === 0 ? -6 : 1 - todayWeekday; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨6å¤©åˆ°å‘¨ä¸€
  const thisWeekMonday = new Date(today);
  thisWeekMonday.setDate(today.getDate() + daysToMonday);
  
  const daysToSunday = todayWeekday === 0 ? 0 : 6 - todayWeekday;
  const thisWeekSunday = new Date(today);
  thisWeekSunday.setDate(today.getDate() + daysToSunday);
  
  // è®¡ç®—æœ¬å‘¨å·²å®Œæˆçš„æ‰“å¡æ¬¡æ•°
  const completedThisWeek = habit.calendar.filter(day => {
    const dayDate = new Date(day.date);
    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœ¬å‘¨å†…
    return day.completed && 
           dayDate >= thisWeekMonday && 
           dayDate <= thisWeekSunday;
  }).length;
  
  // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæœ¬å‘¨æ‰€éœ€çš„æ‰“å¡æ¬¡æ•°
  return completedThisWeek >= requiredWeekCompletions;
};

// è®¡ç®—å±æ€§ï¼šæŒ‰å½“å¤©å®ŒæˆçŠ¶æ€å’Œå‘¨ç›®æ ‡å®ŒæˆçŠ¶æ€æ’åºçš„ä¹ æƒ¯åˆ—è¡¨ï¼ˆæœªå®Œæˆçš„åœ¨å‰ï¼‰
const sortedHabits = computed(() => {
  return [...habits.value].sort((a, b) => {
    // æ£€æŸ¥ a å’Œ b æ˜¯å¦å·²å®Œæˆå‘¨ç›®æ ‡
    const aWeeklyCompleted = a.frequency && a.frequency.startsWith('weekly') && getWeeklyCompletionStatus(a);
    const bWeeklyCompleted = b.frequency && b.frequency.startsWith('weekly') && getWeeklyCompletionStatus(b);
    
    // å¦‚æœ a å·²å®Œæˆå‘¨ç›®æ ‡è€Œ b æœªå®Œæˆå‘¨ç›®æ ‡ï¼Œåˆ™ b æ’åœ¨å‰é¢
    if (aWeeklyCompleted && !bWeeklyCompleted) {
      return 1; // a æ’åœ¨ b åé¢
    } else if (!aWeeklyCompleted && bWeeklyCompleted) {
      return -1; // a æ’åœ¨ b å‰é¢
    } else {
      // å¦‚æœ a å’Œ b éƒ½æ˜¯å‘¨ç›®æ ‡ä¹ æƒ¯ä¸”çŠ¶æ€ç›¸åŒï¼Œæˆ–éƒ½ä¸æ˜¯å‘¨ç›®æ ‡ä¹ æƒ¯ï¼Œåˆ™æŒ‰å½“å¤©å®ŒæˆçŠ¶æ€æ’åº
      const aNotCompleted = !a.completedToday;
      const bNotCompleted = !b.completedToday;
      
      if (aNotCompleted && !bNotCompleted) {
        return -1; // a æ’åœ¨ b å‰é¢
      } else if (!aNotCompleted && bNotCompleted) {
        return 1;  // b æ’åœ¨ a å‰é¢
      } else {
        return 0;  // ä¿æŒåŸæœ‰é¡ºåº
      }
    }
  });
});

// æ–°ä¹ æƒ¯è¡¨å•æ•°æ®
const newHabit = ref({
  name: '',
  emoji: '',
  frequency: 'daily' as 'daily' | 'weekly6' | 'weekly5' | 'weekly4' | 'weekly3' | 'weekly2' | 'weekly1',
  timesPerDay: '1', // æ¯å¤©æ¬¡æ•°
  usePomodoro: false // æ˜¯å¦ä½¿ç”¨ç•ªèŒ„é’Ÿ
});

const frequencyOptions = ref([
  { value: 'daily', text: t('habitTracker.daily') },
  { value: 'weekly6', text: 'æ¯å‘¨6å¤©' },
  { value: 'weekly5', text: 'æ¯å‘¨5å¤©' },
  { value: 'weekly4', text: 'æ¯å‘¨4å¤©' },
  { value: 'weekly3', text: 'æ¯å‘¨3å¤©' },
  { value: 'weekly2', text: 'æ¯å‘¨2å¤©' },
  { value: 'weekly1', text: 'æ¯å‘¨1å¤©' }
]);

// æ¯æ—¥æ‰“å¡æ¬¡æ•°é€‰é¡¹
const timesPerDayOptions = ref([
  { value: '1', text: '1æ¬¡' },
  { value: '2', text: '2æ¬¡' },
  { value: '3', text: '3æ¬¡' },
  { value: '4', text: '4æ¬¡' },
  { value: '5', text: '5æ¬¡' },
  { value: '6', text: '6æ¬¡' },
  { value: '7', text: '7æ¬¡' },
  { value: '8', text: '8æ¬¡' },
  { value: '9', text: '9æ¬¡' },
  { value: '10', text: '10æ¬¡' },
  { value: '11', text: '11æ¬¡' },
  { value: '12', text: '12æ¬¡' },
  { value: '13', text: '13æ¬¡' },
  { value: '14', text: '14æ¬¡' },
  { value: '15', text: '15æ¬¡' },
  { value: '16', text: '16æ¬¡' },
  { value: '17', text: '17æ¬¡' },
  { value: '18', text: '18æ¬¡' },
  { value: '19', text: '19æ¬¡' },
  { value: '20', text: '20æ¬¡' }
]);

// åˆå§‹åŒ–æ•°æ®
onMounted(async () => {
  try {
    habits.value = await getHabits();
    
    // æ¯æ¬¡ç»„ä»¶æŒ‚è½½æ—¶æ›´æ–°currentDayInfoä¸ºå½“å‰æ—¥æœŸ
    const today = new Date();
    console.log('Component mounted - full date object:', today.toString());
    console.log('Component mounted - timezone offset:', today.getTimezoneOffset());
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
    const localDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    currentDayInfo.value.date = localDate;
    currentDayInfo.value.dayOfWeek = today.getDay();
    currentDayInfo.value.dayOfMonth = today.getDate();
    currentDayInfo.value.month = today.getMonth() + 1;
    currentDayInfo.value.year = today.getFullYear();
    
    // æ›´æ–°currentDateå˜é‡
    currentDate.value = localDate;
    
    // åˆå§‹åŒ–æ¯ä¸ªä¹ æƒ¯çš„completedTodayå±æ€§
    const todayStr = localDate;
    habits.value.forEach(habit => {
      const todayRecord = habit.calendar.find(day => day.date === todayStr);
      habit.completedToday = todayRecord ? todayRecord.completed : false;
    });
    
    console.log('Setting up timer, initial date:', currentDate.value);
    
    // æ³¨é‡Šæ‰å®šæ—¶å™¨é¢‘ç‡æ£€æŸ¥ï¼ŒåŠ è½½çš„æ—¶å€™è·å–æ—¥æœŸå°±è¡Œ
    /*
    const timer = setInterval(() => {
      const now = new Date();
      // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
      const newTodayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
      console.log('Timer check - current date:', newTodayStr, 'currentDate ref:', currentDate.value);
      if (currentDate.value !== newTodayStr) {
        console.log('Date changed - updating currentDate from', currentDate.value, 'to', newTodayStr);
        currentDate.value = newTodayStr;
        
        // æ›´æ–°currentDayInfoä¸ºæ–°æ—¥æœŸ
        currentDayInfo.value.date = newTodayStr;
        currentDayInfo.value.dayOfWeek = now.getDay();
        currentDayInfo.value.dayOfMonth = now.getDate();
        currentDayInfo.value.month = now.getMonth() + 1;
        currentDayInfo.value.year = now.getFullYear();
        
        // ä¸ºæ¯ä¸ªä¹ æƒ¯æ›´æ–°completedTodayçŠ¶æ€
        habits.value.forEach(habit => {
          const todayRecord = habit.calendar.find(day => day.date === newTodayStr);
          habit.completedToday = todayRecord ? todayRecord.completed : false;
        });
      }
    }, 300000); // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œç¡®ä¿å½“å‰æ—¥æœŸæ­£ç¡®
    setTimeout(() => {
      const now = new Date();
      // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
      const newTodayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
      console.log('Initial timer check - current date:', newTodayStr, 'currentDate ref:', currentDate.value);
      console.log('Initial timer check - full date object:', now.toString());
      console.log('Initial timer check - timezone offset:', now.getTimezoneOffset());
      if (currentDate.value !== newTodayStr) {
        console.log('Initial date changed - updating currentDate from', currentDate.value, 'to', newTodayStr);
        currentDate.value = newTodayStr;
        
        // æ›´æ–°currentDayInfoä¸ºæ–°æ—¥æœŸ
        currentDayInfo.value.date = newTodayStr;
        currentDayInfo.value.dayOfWeek = now.getDay();
        currentDayInfo.value.dayOfMonth = now.getDate();
        currentDayInfo.value.month = now.getMonth() + 1;
        currentDayInfo.value.year = now.getFullYear();
        
        // ä¸ºæ¯ä¸ªä¹ æƒ¯æ›´æ–°completedTodayçŠ¶æ€
        habits.value.forEach(habit => {
          const todayRecord = habit.calendar.find(day => day.date === newTodayStr);
          habit.completedToday = todayRecord ? todayRecord.completed : false;
        });
      }
    }, 1000); // 1ç§’åæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
    
    // å°†å®šæ—¶å™¨IDå­˜å‚¨åˆ°ç»„ä»¶å®ä¾‹ä¸Šï¼Œä»¥ä¾¿åç»­æ¸…ç†
    (window as any).habitTrackerTimer = timer;
    
    // æ¯5åˆ†é’Ÿä¹Ÿæ£€æŸ¥ä¸€æ¬¡æ—¥æœŸå˜åŒ–ï¼Œä½œä¸ºå¤‡ç”¨æœºåˆ¶
    const backupTimer = setInterval(() => {
      const now = new Date();
      // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
      const newTodayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
      if (currentDate.value !== newTodayStr) {
        console.log('Backup timer: Date changed - updating currentDate from', currentDate.value, 'to', newTodayStr);
        currentDate.value = newTodayStr;
        
        // æ›´æ–°currentDayInfoä¸ºæ–°æ—¥æœŸ
        currentDayInfo.value.date = newTodayStr;
        currentDayInfo.value.dayOfWeek = now.getDay();
        currentDayInfo.value.dayOfMonth = now.getDate();
        currentDayInfo.value.month = now.getMonth() + 1;
        currentDayInfo.value.year = now.getFullYear();
        
        // ä¸ºæ¯ä¸ªä¹ æƒ¯æ›´æ–°completedTodayçŠ¶æ€
        habits.value.forEach(habit => {
          const todayRecord = habit.calendar.find(day => day.date === newTodayStr);
          habit.completedToday = todayRecord ? todayRecord.completed : false;
        });
      }
    }, 300000); // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    
    // å¤‡ç”¨å®šæ—¶å™¨ä¹Ÿç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
    setTimeout(() => {
      const now = new Date();
      // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
      const newTodayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
      console.log('Backup timer initial check - current date:', newTodayStr, 'currentDate ref:', currentDate.value);
      console.log('Backup timer initial check - full date object:', now.toString());
      console.log('Backup timer initial check - timezone offset:', now.getTimezoneOffset());
      if (currentDate.value !== newTodayStr) {
        console.log('Backup timer initial check: Date changed - updating currentDate from', currentDate.value, 'to', newTodayStr);
        currentDate.value = newTodayStr;
        
        // æ›´æ–°currentDayInfoä¸ºæ–°æ—¥æœŸ
        currentDayInfo.value.date = newTodayStr;
        currentDayInfo.value.dayOfWeek = now.getDay();
        currentDayInfo.value.dayOfMonth = now.getDate();
        currentDayInfo.value.month = now.getMonth() + 1;
        currentDayInfo.value.year = now.getFullYear();
        
        // ä¸ºæ¯ä¸ªä¹ æƒ¯æ›´æ–°completedTodayçŠ¶æ€
        habits.value.forEach(habit => {
          const todayRecord = habit.calendar.find(day => day.date === newTodayStr);
          habit.completedToday = todayRecord ? todayRecord.completed : false;
        });
      }
    }, 2000); // 2ç§’åæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
    
    // å°†å¤‡ç”¨å®šæ—¶å™¨IDä¹Ÿå­˜å‚¨åˆ°ç»„ä»¶å®ä¾‹ä¸Š
    (window as any).habitTrackerBackupTimer = backupTimer;
    */
    
    // ä¸å†åˆå§‹åŒ–æ—¥å†æ•°æ®ï¼Œå› ä¸ºåªè®°å½•å·²æ‰“å¡çš„æ—¥æœŸ
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¹ æƒ¯çš„ç•ªèŒ„é’Ÿå‰©ä½™æ—¶é—´ï¼Œå¹¶æ¢å¤è®¡æ—¶å™¨
    // æ³¨æ„ï¼šè¿™é‡Œä¸è‡ªåŠ¨å¯åŠ¨è®¡æ—¶å™¨ï¼Œåªä¿ç•™æ•°æ®ï¼Œè®©ç”¨æˆ·ç‚¹å‡»æ‰“å¡æŒ‰é’®æ—¶æ‰å¯åŠ¨
    // habits.value.forEach(habit => {
    //   if (habit.usePomodoro && habit.pomodoroRemaining !== undefined && habit.pomodoroRemaining > 0) {
    //     // å¦‚æœæœ‰å‰©ä½™æ—¶é—´ï¼Œå¯åŠ¨è®¡æ—¶å™¨
    //     startPomodoroTimer(habit);
    //   }
    // });
  } catch (error) {
    console.error('Error initializing habits:', error);
    // åˆå§‹åŒ–å¤±è´¥æ—¶ï¼Œä½¿ç”¨ç©ºæ•°ç»„ï¼Œç¡®ä¿ç•Œé¢ä»èƒ½æ˜¾ç¤º
    habits.value = [];
  }
});

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
onUnmounted(() => {
  // æ¸…ç†ä¸»å®šæ—¶å™¨
  if ((window as any).habitTrackerTimer) {
    clearInterval((window as any).habitTrackerTimer);
    delete (window as any).habitTrackerTimer;
  }
  
  // æ¸…ç†å¤‡ç”¨å®šæ—¶å™¨
  if ((window as any).habitTrackerBackupTimer) {
    clearInterval((window as any).habitTrackerBackupTimer);
    delete (window as any).habitTrackerBackupTimer;
  }
  
  // æ¸…ç†ç•ªèŒ„é’Ÿå®šæ—¶å™¨
  for (const habitId in pomodoroTimers) {
    clearInterval(pomodoroTimers[habitId]);
    delete pomodoroTimers[habitId];
  }
});

// ç”Ÿæˆæ—¥å†æ•°æ®
const generateCalendarData = (_targetCount: number = 1): any[] => { // eslint-disable-line @typescript-eslint/no-unused-vars
  // åªè¿”å›ç©ºæ•°ç»„ï¼Œå› ä¸ºåªè®°å½•å·²æ‰“å¡çš„æ—¥æœŸ
  // ä¹‹å‰çš„å®ç°å¯èƒ½ä¼šåˆå§‹åŒ–å…¨å¹´çš„æ—¥å†æ•°æ®ï¼Œä½†ç°åœ¨æ”¹ä¸ºåªåœ¨æ‰“å¡æ—¶åˆ›å»ºè®°å½•
  // _targetCount åœ¨åˆ›å»ºæ—¥å†è®°å½•æ—¶ä¼šå•ç‹¬å¤„ç†ï¼Œå› æ­¤æ­¤å¤„ä¸éœ€è¦ä½¿ç”¨è¯¥å‚æ•°
  return [];
};

// æ·»åŠ ä¹ æƒ¯
const addHabit = async () => {
  if (!newHabit.value.name.trim()) {
    alert('è¯·è¾“å…¥ä¹ æƒ¯åç§°');
    return;
  }
  
  // é™åˆ¶ timesPerDay æœ€å¤§å€¼ä¸º 20
  const inputTimesPerDay = parseInt(newHabit.value.timesPerDay) || 1;
  if (inputTimesPerDay > 20) {
    alert('æ¯æ—¥æ‰“å¡æ¬¡æ•°ä¸èƒ½è¶…è¿‡20æ¬¡');
    return;
  }
  
  const timesPerDay = Math.min(inputTimesPerDay, 20);
  
  const habit: Habit = {
    id: Date.now().toString(),
    name: newHabit.value.name,
    emoji: newHabit.value.emoji,
    frequency: newHabit.value.frequency,
    timesPerDay: timesPerDay,
    completedToday: false,
    currentStreak: 0,
    totalCompletions: 0,
    calendar: generateCalendarData(timesPerDay),
    createdAt: new Date().toISOString(),
    usePomodoro: newHabit.value.usePomodoro || false // æ˜¯å¦ä½¿ç”¨ç•ªèŒ„é’Ÿ
  };
  
  habits.value.push(habit);
  await saveHabits(habits.value);
  
  // é‡ç½®è¡¨å•
  newHabit.value = {
    name: '',
    emoji: '',
    frequency: 'daily',
    timesPerDay: '1',
    usePomodoro: false
  };
  
  showAddHabitModal.value = false;
};

// åˆ‡æ¢å•æ—¥æ‰“å¡çŠ¶æ€ (ç›®å‰æœªç›´æ¥ä½¿ç”¨ï¼Œä¿ç•™ä¾›å°†æ¥å¯èƒ½çš„åŠŸèƒ½æ‰©å±•)
// åˆ‡æ¢å•æ—¥æ‰“å¡çŠ¶æ€
const toggleDayCompletion = async (habit: Habit, date: string) => {
  let dayRecord = habit.calendar.find(day => day.date === date);
  
  // å¦‚æœæŒ‡å®šæ—¥æœŸçš„è®°å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€æ¡æ–°è®°å½•
  if (!dayRecord) {
    const timesPerDay = Math.min(typeof habit.timesPerDay === 'string' ? parseInt(habit.timesPerDay) || 1 : habit.timesPerDay || 1, 20);
    dayRecord = {
      date: date,
      completed: false,
      completedCount: 0,
      targetCount: timesPerDay
    };
    habit.calendar.push(dayRecord);
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡
  const targetCount = typeof dayRecord.targetCount === 'string' ? parseInt(dayRecord.targetCount) || 1 : dayRecord.targetCount || 1;
  if (dayRecord.completed) {
    // å¦‚æœå·²å®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™é‡ç½®æ‰“å¡æ•°æ®
    dayRecord.completedCount = 0;
    dayRecord.completed = false;
    // å®ŒæˆçŠ¶æ€å˜ä¸ºæœªå®Œæˆæ—¶ï¼Œç§»é™¤æ—¶é—´æˆ³
    delete dayRecord.timestamp;
    
    // å¦‚æœå®ŒæˆçŠ¶æ€å˜ä¸ºæœªå®Œæˆï¼Œä¸”å®Œæˆæ¬¡æ•°ä¸º0ï¼Œä»æ—¥å†ä¸­ç§»é™¤è¯¥è®°å½•
    if (dayRecord.completedCount === 0) {
      habit.calendar = habit.calendar.filter(day => day.date !== date);
    }
  } else {
    // å¦‚æœå°šæœªå®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡ï¼Œåˆ™å¢åŠ å®Œæˆæ¬¡æ•°
    if (dayRecord.completedCount < targetCount) {
      dayRecord.completedCount = (dayRecord.completedCount || 0) + 1;
    }
    // å½“å®Œæˆæ¬¡æ•°è¾¾åˆ°ç›®æ ‡æ¬¡æ•°æ—¶ï¼Œæ ‡è®°ä¸ºå·²å®Œæˆ
    dayRecord.completed = dayRecord.completedCount >= targetCount;
    
    // åªåœ¨æ‰“å¡å®Œæˆæ—¶æ·»åŠ æ—¶é—´æˆ³
    if (dayRecord.completed && !dayRecord.timestamp) {
      dayRecord.timestamp = Date.now();
    }
  }
  
  // æ›´æ–°å½“å¤©æ˜¯å¦å®Œæˆçš„æ ‡è®°
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const now = new Date();
  const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
  habit.completedToday = date === todayStr && dayRecord.completed;
  
  // æ›´æ–°æ€»å®Œæˆæ¬¡æ•°å’Œè¿ç»­æ‰“å¡å¤©æ•°
  habit.totalCompletions = habit.calendar.filter(day => day.completed).length;
  
  // é‡æ–°è®¡ç®—å½“å‰è¿ç»­æ‰“å¡å¤©æ•°
  const sortedCalendar = [...habit.calendar].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
  habit.currentStreak = 0;
  for (const day of sortedCalendar) {
    if (day.completed) {
      habit.currentStreak++;
    } else {
      break; // é‡åˆ°æœªå®Œæˆçš„å¤©æ•°å°±åœæ­¢è®¡ç®—
    }
  }
  
  await saveHabits(habits.value);
};

// æ£€æŸ¥å‘¨ç›®æ ‡æ˜¯å¦å·²å®Œæˆ
const getWeeklyCompletionStatus = (habit: Habit) => {
  if (!habit.frequency || !habit.frequency.startsWith('weekly')) {
    return false;
  }
  
  // ç¡®å®šæ¯å‘¨éœ€è¦å®Œæˆçš„æ¬¡æ•°
  let requiredWeekCompletions = 1; // é»˜è®¤ä¸º1æ¬¡
  if (habit.frequency === 'weekly2') requiredWeekCompletions = 2;
  else if (habit.frequency === 'weekly3') requiredWeekCompletions = 3;
  else if (habit.frequency === 'weekly4') requiredWeekCompletions = 4;
  else if (habit.frequency === 'weekly5') requiredWeekCompletions = 5;
  else if (habit.frequency === 'weekly6') requiredWeekCompletions = 6;
  
  // è®¡ç®—æœ¬å‘¨çš„å‘¨ä¸€å’Œå‘¨æ—¥
  const today = new Date();
  const todayWeekday = today.getDay();
  const daysToMonday = todayWeekday === 0 ? -6 : 1 - todayWeekday; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨6å¤©åˆ°å‘¨ä¸€
  const thisWeekMonday = new Date(today);
  thisWeekMonday.setDate(today.getDate() + daysToMonday);
  
  const daysToSunday = todayWeekday === 0 ? 0 : 6 - todayWeekday;
  const thisWeekSunday = new Date(today);
  thisWeekSunday.setDate(today.getDate() + daysToSunday);
  
  // è®¡ç®—æœ¬å‘¨å·²å®Œæˆçš„æ‰“å¡æ¬¡æ•°
  const completedThisWeek = habit.calendar.filter(day => {
    const dayDate = new Date(day.date);
    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœ¬å‘¨å†…
    return day.completed && 
           dayDate >= thisWeekMonday && 
           dayDate <= thisWeekSunday;
  }).length;
  
  // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæœ¬å‘¨æ‰€éœ€çš„æ‰“å¡æ¬¡æ•°
  return completedThisWeek >= requiredWeekCompletions;
};

// åˆ‡æ¢ä¹ æƒ¯å®ŒæˆçŠ¶æ€
const getTodayCompletionCount = (habit: Habit) => {
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const today = getToday();
  const todayRecord = habit.calendar.find(day => day.date === today);
  return todayRecord ? (todayRecord.completedCount || 0) : 0;
};

// ç•ªèŒ„é’Ÿç›¸å…³å˜é‡
let pomodoroTimers: { [key: string]: number } = {};

const toggleHabit = async (habitId: string) => {
  const habit = habits.value.find(h => h.id === habitId);
  if (!habit) {
    return;
  }

  const today = getToday();
  const todayRecord = habit.calendar.find(day => day.date === today);

  if (todayRecord) {
    todayRecord.completedCount = todayRecord.completedCount ? todayRecord.completedCount + 1 : 1;
  } else {
    habit.calendar.push({ date: today, completedCount: 1 });
  }

  await saveHabits(habits.value);
};

    console.log('æœªæ‰¾åˆ°ä¹ æƒ¯:', habitId);
    return;
  }
  
  console.log('ç‚¹å‡»ä¹ æƒ¯:', habit.name, 'usePomodoro:', habit.usePomodoro, 'completedToday:', habit.completedToday);
  
  // å¦‚æœå¯ç”¨äº†ç•ªèŒ„é’ŸåŠŸèƒ½ï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦å·²å®Œæˆ
  if (habit.usePomodoro) {
    // å¦‚æœä¹ æƒ¯å·²å®Œæˆï¼Œåˆ™å–æ¶ˆå®ŒæˆçŠ¶æ€
    if (habit.completedToday) {
      // å¼¹å‡ºç¡®è®¤å–æ¶ˆæ‰“å¡å¼¹çª—
      if (confirm('æ˜¯å¦è¦å–æ¶ˆæ‰“å¡è®°å½•ï¼Ÿ')) {
        console.log('å–æ¶ˆç•ªèŒ„é’Ÿä¹ æƒ¯å®ŒæˆçŠ¶æ€ for habit:', habit.name);
        // å–æ¶ˆå½“å¤©å®ŒæˆçŠ¶æ€
        // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
        const today = getToday();
        let todayRecord = habit.calendar.find(day => day.date === today);
        
        if (todayRecord) {
          // æ¸…é™¤å½“å¤©æ‰€æœ‰æ‰“å¡æ¬¡æ•°ï¼Œé‡ç½®ä¸º0
          todayRecord.completed = false;
          todayRecord.completedCount = 0;
        }
        
        // æ›´æ–°ä¹ æƒ¯çš„å®ŒæˆçŠ¶æ€
        habit.completedToday = false;
        
        // é‡æ–°è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°å’Œæ€»å®Œæˆæ¬¡æ•°
        const sortedCalendar = [...habit.calendar].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
        habit.currentStreak = 0;
        for (const day of sortedCalendar) {
          if (day.completed) {
            habit.currentStreak++;
          } else {
            break; // é‡åˆ°æœªå®Œæˆçš„å¤©æ•°å°±åœæ­¢è®¡ç®—
          }
        }
        habit.totalCompletions = habit.calendar.filter(day => day.completed).length;
        
        await saveHabits(habits.value);
      }
      return;
    } else {
      console.log('å¯åŠ¨ç•ªèŒ„é’Ÿè®¡æ—¶å™¨å¹¶è·³è½¬é¡µé¢ for habit:', habit.name);
      // è®¾ç½®å½“å‰æ¿€æ´»çš„ç•ªèŒ„é’Ÿä¹ æƒ¯
      activePomodoroHabit.value = habit;
      // å¯åŠ¨ç•ªèŒ„é’Ÿè®¡æ—¶å™¨
      startPomodoroTimer(habit);
      return;
    }
  }
  
  console.log('æ‰§è¡Œæ™®é€šæ‰“å¡é€»è¾‘');
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºå‘¨é¢‘æ¬¡ä¹ æƒ¯ä¸”å·²å®Œæˆæœ¬å‘¨ç›®æ ‡
  if (habit.frequency && habit.frequency.startsWith('weekly')) {
    if (getWeeklyCompletionStatus(habit)) {
      // å¦‚æœå‘¨ç›®æ ‡å·²å®Œæˆï¼Œç‚¹å‡»æŒ‰é’®åº”å–æ¶ˆå®ŒæˆçŠ¶æ€
      if (confirm('æ˜¯å¦è¦å–æ¶ˆæ‰“å¡è®°å½•ï¼Ÿ')) {
        // æ‰¾åˆ°æœ¬å‘¨æ‰€æœ‰å·²å®Œæˆçš„è®°å½•å¹¶å–æ¶ˆå®ŒæˆçŠ¶æ€
        const today = new Date();
        const todayWeekday = today.getDay();
        const daysToMonday = todayWeekday === 0 ? -6 : 1 - todayWeekday; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨6å¤©åˆ°å‘¨ä¸€
        const thisWeekMonday = new Date(today);
        thisWeekMonday.setDate(today.getDate() + daysToMonday);
        
        const daysToSunday = todayWeekday === 0 ? 0 : 6 - todayWeekday;
        const thisWeekSunday = new Date(today);
        thisWeekSunday.setDate(today.getDate() + daysToSunday);
        
        // æ‰¾åˆ°æœ¬å‘¨æ‰€æœ‰å·²å®Œæˆçš„æ‰“å¡è®°å½•ï¼ŒæŒ‰æ—¥æœŸå€’åºæ’åˆ—
        const weeklyCompletedDays = habit.calendar
          .filter(day => {
            const dayDate = new Date(day.date);
            return day.completed && dayDate >= thisWeekMonday && dayDate <= thisWeekSunday;
          })
          .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
        
        // å–æ¶ˆæœ€åä¸€æ¡æ‰“å¡è®°å½•çš„å®ŒæˆçŠ¶æ€
        if (weeklyCompletedDays.length > 0) {
          const lastCompletedDay = weeklyCompletedDays[0];
          lastCompletedDay.completed = false;
          lastCompletedDay.completedCount = 0;
          // é‡ç½®å½“å¤©çš„å®ŒæˆçŠ¶æ€
          if (lastCompletedDay.date === getToday()) {
            habit.completedToday = false;
          }
          delete lastCompletedDay.timestamp;
        }
        
        // é‡æ–°è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°å’Œæ€»å®Œæˆæ¬¡æ•°
        const sortedCalendar = [...habit.calendar].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
        habit.currentStreak = 0;
        for (const day of sortedCalendar) {
          if (day.completed) {
            habit.currentStreak++;
          } else {
            break; // é‡åˆ°æœªå®Œæˆçš„å¤©æ•°å°±åœæ­¢è®¡ç®—
          }
        }
        habit.totalCompletions = habit.calendar.filter(day => day.completed).length;
        
        await saveHabits(habits.value);
      }
      return; // é€€å‡ºå‡½æ•°ï¼Œä¸æ‰§è¡Œåç»­æ‰“å¡é€»è¾‘
    }
  }
  
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const today = getToday();
  let todayRecord = habit.calendar.find(day => day.date === today);
  
  // å¦‚æœä»Šå¤©æ—¥æœŸçš„è®°å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€æ¡æ–°è®°å½•
  if (!todayRecord) {
    const timesPerDay = Math.min(typeof habit.timesPerDay === 'string' ? parseInt(habit.timesPerDay) || 1 : habit.timesPerDay || 1, 20);
    todayRecord = {
      date: today,
      completed: false,
      completedCount: 0,
      targetCount: timesPerDay
    };
    habit.calendar.push(todayRecord);
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡
  const targetCount = typeof todayRecord.targetCount === 'string' ? parseInt(todayRecord.targetCount) || 1 : todayRecord.targetCount || 1;
  if (todayRecord.completed) {
    // å¦‚æœå·²å®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™é‡ç½®æ‰“å¡æ•°æ®
    // å¼¹å‡ºç¡®è®¤å–æ¶ˆæ‰“å¡å¼¹çª—
    if (confirm('ç¡®å®šè¦å–æ¶ˆæ‰“å¡å—ï¼Ÿ')) {
      todayRecord.completedCount = 0;
      todayRecord.completed = false;
      // å®ŒæˆçŠ¶æ€å˜ä¸ºæœªå®Œæˆæ—¶ï¼Œç§»é™¤æ—¶é—´æˆ³
      delete todayRecord.timestamp;
      
      // å¦‚æœå®ŒæˆçŠ¶æ€å˜ä¸ºæœªå®Œæˆï¼Œä¸”å®Œæˆæ¬¡æ•°ä¸º0ï¼Œä»æ—¥å†ä¸­ç§»é™¤è¯¥è®°å½•
      if (todayRecord.completedCount === 0) {
        habit.calendar = habit.calendar.filter(day => day.date !== today);
      }
    }
  } else {
    // å¦‚æœå°šæœªå®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡ï¼Œåˆ™å¢åŠ å®Œæˆæ¬¡æ•°
    if (todayRecord.completedCount < targetCount) {
      todayRecord.completedCount = (todayRecord.completedCount || 0) + 1;
    }
    // å½“å®Œæˆæ¬¡æ•°è¾¾åˆ°ç›®æ ‡æ¬¡æ•°æ—¶ï¼Œæ ‡è®°ä¸ºå·²å®Œæˆ
    todayRecord.completed = todayRecord.completedCount >= targetCount;
    
    // åªåœ¨æ‰“å¡å®Œæˆæ—¶æ·»åŠ æ—¶é—´æˆ³
    if (todayRecord.completed && !todayRecord.timestamp) {
      todayRecord.timestamp = Date.now();
    }
  }
  
  habit.completedToday = todayRecord?.completed || false;
  
  // é‡æ–°è®¡ç®—æ€»å®Œæˆæ¬¡æ•°ï¼ˆè¿™é‡Œè®¡ç®—çš„æ˜¯å®Œæˆç›®æ ‡çš„å¤©æ•°ï¼‰
  habit.totalCompletions = habit.calendar.filter(day => day.completed).length;
  
  // è®¡ç®—å½“å‰è¿ç»­æ‰“å¡å¤©æ•°
  const sortedCalendar = [...habit.calendar].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
  habit.currentStreak = 0;
  for (const day of sortedCalendar) {
    if (day.completed) {
      habit.currentStreak++;
    } else {
      break; // é‡åˆ°æœªå®Œæˆçš„å¤©æ•°å°±åœæ­¢è®¡ç®—
    }
  }
  
  await saveHabits(habits.value);
};

// å¯åŠ¨ç•ªèŒ„é’Ÿè®¡æ—¶å™¨
const startPomodoroTimer = (habit: Habit) => {
  console.log('startPomodoroTimer è¢«è°ƒç”¨ for habit:', habit.name);
  
  // å¦‚æœå·²æœ‰è®¡æ—¶å™¨ï¼Œå…ˆæ¸…é™¤
  if (pomodoroTimers[habit.id]) {
    console.log('æ¸…é™¤å·²æœ‰è®¡æ—¶å™¨ for habit:', habit.id);
    clearInterval(pomodoroTimers[habit.id]);
  }
  
  // è®¾ç½®ç•ªèŒ„é’Ÿæ—¶é•¿ï¼ˆ10ç§’ï¼Œç”¨äºæµ‹è¯•ï¼‰
  let remainingTime = 10; // 10ç§’ç”¨äºæµ‹è¯•
  console.log('è®¾ç½®å‰©ä½™æ—¶é—´:', remainingTime, 'ç§’');
  
  // æ›´æ–°ä¹ æƒ¯çš„ç•ªèŒ„é’ŸçŠ¶æ€
  habit.pomodoroRemaining = remainingTime;
  habit.pomodoroState = 'work'; // é»˜è®¤å¼€å§‹å·¥ä½œæ—¶é—´
  console.log('æ›´æ–°ç•ªèŒ„é’Ÿå‰©ä½™æ—¶é—´:', habit.pomodoroRemaining, 'çŠ¶æ€:', habit.pomodoroState);
  
  // å¯åŠ¨å€’è®¡æ—¶
  pomodoroTimers[habit.id] = window.setInterval(() => {
    remainingTime--;
    habit.pomodoroRemaining = remainingTime;
    console.log('ç•ªèŒ„é’Ÿå€’è®¡æ—¶æ›´æ–°ï¼Œå‰©ä½™æ—¶é—´:', remainingTime);
    
    if (remainingTime <= 0) {
      // å€’è®¡æ—¶ç»“æŸï¼Œå®Œæˆæ‰“å¡
      console.log('ç•ªèŒ„é’Ÿå€’è®¡æ—¶ç»“æŸï¼Œå®Œæˆæ‰“å¡ for habit:', habit.name);
      clearInterval(pomodoroTimers[habit.id]);
      completeHabitAfterPomodoro(habit);
      
      // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¿™ä¸ªä¹ æƒ¯çš„ç•ªèŒ„é’Ÿé¡µé¢ï¼Œåˆ™å…³é—­é¡µé¢
      if (activePomodoroHabit.value && activePomodoroHabit.value.id === habit.id) {
        activePomodoroHabit.value = null;
      }
    }
  }, 1000);
  
  console.log('å·²å¯åŠ¨ç•ªèŒ„é’Ÿè®¡æ—¶å™¨ï¼ŒID:', pomodoroTimers[habit.id]);
};

// ç•ªèŒ„é’Ÿç»“æŸåå®Œæˆæ‰“å¡
const completeHabitAfterPomodoro = async (habit: Habit) => {
  console.log('completeHabitAfterPomodoro è¢«è°ƒç”¨ for habit:', habit.name);
  
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const today = getToday();
  let todayRecord = habit.calendar.find(day => day.date === today);
  
  // å¦‚æœä»Šå¤©æ—¥æœŸçš„è®°å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€æ¡æ–°è®°å½•
  if (!todayRecord) {
    const timesPerDay = Math.min(typeof habit.timesPerDay === 'string' ? parseInt(habit.timesPerDay) || 1 : habit.timesPerDay || 1, 20);
    todayRecord = {
      date: today,
      completed: false,
      completedCount: 0,
      targetCount: timesPerDay
    };
    habit.calendar.push(todayRecord);
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡
  const targetCount = typeof todayRecord.targetCount === 'string' ? parseInt(todayRecord.targetCount) || 1 : todayRecord.targetCount || 1;
  
  // å¦‚æœå°šæœªå®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡ï¼Œåˆ™å¢åŠ å®Œæˆæ¬¡æ•°
  if (todayRecord.completedCount < targetCount) {
    todayRecord.completedCount = (todayRecord.completedCount || 0) + 1;
  }
  // å½“å®Œæˆæ¬¡æ•°è¾¾åˆ°ç›®æ ‡æ¬¡æ•°æ—¶ï¼Œæ ‡è®°ä¸ºå·²å®Œæˆ
  todayRecord.completed = todayRecord.completedCount >= targetCount;
  
  // åªåœ¨æ‰“å¡å®Œæˆæ—¶æ·»åŠ æ—¶é—´æˆ³
  if (todayRecord.completed && !todayRecord.timestamp) {
    todayRecord.timestamp = Date.now();
  }
  
  habit.completedToday = todayRecord?.completed || false;
  
  // é‡æ–°è®¡ç®—æ€»å®Œæˆæ¬¡æ•°ï¼ˆè¿™é‡Œè®¡ç®—çš„æ˜¯å®Œæˆç›®æ ‡çš„å¤©æ•°ï¼‰
  habit.totalCompletions = habit.calendar.filter(day => day.completed).length;
  
  // è®¡ç®—å½“å‰è¿ç»­æ‰“å¡å¤©æ•°
  const sortedCalendar = [...habit.calendar].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
  habit.currentStreak = 0;
  for (const day of sortedCalendar) {
    if (day.completed) {
      habit.currentStreak++;
    } else {
      break; // é‡åˆ°æœªå®Œæˆçš„å¤©æ•°å°±åœæ­¢è®¡ç®—
    }
  }
  
  // æ¸…é™¤ç•ªèŒ„é’Ÿç›¸å…³çŠ¶æ€
  delete habit.pomodoroRemaining;
  delete habit.pomodoroState;
  if (pomodoroTimers[habit.id]) {
    clearInterval(pomodoroTimers[habit.id]);
    delete pomodoroTimers[habit.id];
  }
  
  await saveHabits(habits.value);
  console.log('ç•ªèŒ„é’Ÿæ‰“å¡å®Œæˆï¼Œå·²ä¿å­˜æ•°æ® for habit:', habit.name);
};

// æ ¼å¼åŒ–ç•ªèŒ„é’Ÿæ—¶é—´æ˜¾ç¤º
const formatPomodoroTime = (seconds: number): string => {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
};

// åœæ­¢ç•ªèŒ„é’Ÿ
const stopPomodoro = (_habit: Habit) => { // eslint-disable-line @typescript-eslint/no-unused-vars
  console.log('åœæ­¢ç•ªèŒ„é’Ÿ for habit:', activePomodoroHabit.value?.name);
  
  if (activePomodoroHabit.value) {
    const habit = activePomodoroHabit.value;
    
    // æ¸…é™¤ç•ªèŒ„é’Ÿç›¸å…³çŠ¶æ€
    delete habit.pomodoroRemaining;
    if (pomodoroTimers[habit.id]) {
      clearInterval(pomodoroTimers[habit.id]);
      delete pomodoroTimers[habit.id];
    }
    
    // é‡ç½®å½“å‰æ¿€æ´»çš„ç•ªèŒ„é’Ÿä¹ æƒ¯
    activePomodoroHabit.value = null;
  }
};

// åœæ­¢å½“å‰ç•ªèŒ„é’Ÿï¼ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼‰
const stopCurrentPomodoro = () => {
  if (activePomodoroHabit.value) {
    stopPomodoro(activePomodoroHabit.value);
  }
};

// æ ¹æ®ç•ªèŒ„é’ŸçŠ¶æ€è¿”å›å¯¹åº”çš„CSSç±»
const pomodoroStateClass = (state?: 'work' | 'shortBreak' | 'longBreak') => {
  if (!state) return 'pomodoro-running';
  
  switch (state) {
    case 'work':
      return 'pomodoro-running';
    case 'shortBreak':
      return 'pomodoro-short-break';
    case 'longBreak':
      return 'pomodoro-long-break';
    default:
      return 'pomodoro-running';
  }
};

// åˆ é™¤ä¹ æƒ¯
const deleteHabit = async (habitId: string) => {
  if (!confirm(t('habitTracker.confirmDelete'))) {
    return;
  }
  
  habits.value = habits.value.filter(h => h.id !== habitId);
  await saveHabits(habits.value);
  
  // å…³é—­ç»Ÿè®¡é¡µé¢
  selectedHabit.value = null;
};

// è®¡ç®—æœ¬æœˆå®Œæˆç‡
const calculateCompletionRate = (habit: Habit) => {
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();
  
  console.log('å¼€å§‹è®¡ç®—å®Œæˆç‡:', {
    habitName: habit.name,
    frequency: habit.frequency,
    currentYear,
    currentMonth: currentMonth + 1, // æœˆä»½ä»0å¼€å§‹ï¼Œæ‰€ä»¥åŠ 1
    today: today.toISOString().split('T')[0]
  });
  
  // è¿‡æ»¤å‡ºæœ¬æœˆçš„æ‰“å¡è®°å½•
  const monthRecords = habit.calendar.filter(record => {
    const recordDate = new Date(record.date);
    return recordDate.getFullYear() === currentYear && 
           recordDate.getMonth() === currentMonth;
  });
  
  console.log('æœ¬æœˆæ‰“å¡è®°å½•:', {
    monthRecordsCount: monthRecords.length,
    monthRecords: monthRecords
  });
  
  if (habit.frequency.startsWith('weekly')) {
    // å¯¹äºå‘¨é¢‘æ¬¡ä¹ æƒ¯ï¼Œè®¡ç®—åŸºäºåº”å®Œæˆæ¬¡æ•°çš„å®Œæˆç‡
    
    // ç¡®å®šæ¯å‘¨éœ€è¦å®Œæˆçš„æ¬¡æ•°
    let weeklyTarget = 1; // é»˜è®¤ä¸º1æ¬¡
    if (habit.frequency === 'weekly2') weeklyTarget = 2;
    else if (habit.frequency === 'weekly3') weeklyTarget = 3;
    else if (habit.frequency === 'weekly4') weeklyTarget = 4;
    else if (habit.frequency === 'weekly5') weeklyTarget = 5;
    else if (habit.frequency === 'weekly6') weeklyTarget = 6;
    
    console.log('å‘¨é¢‘æ¬¡ä¹ æƒ¯è®¡ç®—:', {
      weeklyTarget,
      habitFrequency: habit.frequency
    });
    
    // è®¡ç®—æœ¬å‘¨çš„å‘¨ä¸€å’Œå‘¨æ—¥
    const todayWeekday = today.getDay();
    const daysToMonday = todayWeekday === 0 ? -6 : 1 - todayWeekday; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨6å¤©åˆ°å‘¨ä¸€
    const thisWeekMonday = new Date(today);
    thisWeekMonday.setDate(today.getDate() + daysToMonday);
    
    const daysToSunday = todayWeekday === 0 ? 0 : 7 - todayWeekday;
    const thisWeekSunday = new Date(today);
    thisWeekSunday.setDate(today.getDate() + daysToSunday);
    
    console.log('æœ¬å‘¨èŒƒå›´:', {
      thisWeekMonday: thisWeekMonday.toISOString().split('T')[0],
      thisWeekSunday: thisWeekSunday.toISOString().split('T')[0]
    });
    
    // è®¡ç®—æœ¬æœˆç¬¬ä¸€ä¸ªå‘¨ä¸€
    const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
    
    const firstDayWeekday = firstDayOfMonth.getDay();
    
    // è®¡ç®—æœ¬æœˆç¬¬ä¸€ä¸ªå‘¨ä¸€
    const firstDayToMonday = firstDayWeekday === 0 ? 1 : (8 - firstDayWeekday) % 7;
    const monthFirstMonday = new Date(firstDayOfMonth);
    monthFirstMonday.setDate(firstDayOfMonth.getDate() + (firstDayWeekday === 1 ? 0 : firstDayToMonday));
    
    // è®¡ç®—ä¸Šä¸ªæœˆæœ€åä¸€å‘¨çš„å‘¨æ—¥
    const prevMonthLastDay = new Date(currentYear, currentMonth, 0); // ä¸Šä¸ªæœˆæœ€åä¸€å¤©
    const prevMonthLastWeekday = prevMonthLastDay.getDay();
    const prevMonthLastDayToSunday = (6 - prevMonthLastWeekday + 7) % 7;
    const prevMonthLastSunday = new Date(prevMonthLastDay);
    prevMonthLastSunday.setDate(prevMonthLastDay.getDate() + prevMonthLastDayToSunday);
    
    // è®¡ç®—éœ€è¦ç»Ÿè®¡çš„èµ·å§‹æ—¥æœŸ
    let periodStart = monthFirstMonday;
    
    // å¦‚æœä»Šå¤©åœ¨æœ¬æœˆç¬¬ä¸€ä¸ªå‘¨ä¸€ä¹‹å‰ï¼Œåˆ™ç»Ÿè®¡ä¸Šä¸ªæœˆæœ€åä¸€å‘¨
    if (today < monthFirstMonday) {
      periodStart = prevMonthLastSunday; // ä»ä¸Šä¸ªæœˆæœ€åä¸€å‘¨å‘¨æ—¥å¼€å§‹
    }
    
    console.log('ç»Ÿè®¡å‘¨æœŸ:', {
      monthFirstMonday: monthFirstMonday.toISOString().split('T')[0],
      prevMonthLastSunday: prevMonthLastSunday.toISOString().split('T')[0],
      periodStart: periodStart.toISOString().split('T')[0]
    });
    
    // è®¡ç®—ä»èµ·å§‹æ—¥æœŸåˆ°æœ¬å‘¨å‘¨æ—¥çš„å‘¨æ•°
    const daysFromStart = Math.floor((thisWeekSunday.getTime() - periodStart.getTime()) / (1000 * 60 * 60 * 24));
    let totalWeeks = Math.floor(daysFromStart / 7) + 1;
    
    // ç¡®ä¿è‡³å°‘ç»Ÿè®¡1å‘¨
    if (totalWeeks <= 0) {
      totalWeeks = 1;
    }
    
    // è®¡ç®—åº”å®Œæˆçš„æ€»æ¬¡æ•°
    const expectedTotalCompletions = totalWeeks * weeklyTarget;
    
    console.log('ç›®æ ‡å®Œæˆæ¬¡æ•°:', {
      totalWeeks,
      weeklyTarget,
      expectedTotalCompletions
    });
    
    // å¯¹äºå‘¨é¢‘æ¬¡ä¹ æƒ¯ï¼Œæˆ‘ä»¬ç»Ÿè®¡å®Œæˆå‘¨æ•°è€Œä¸æ˜¯å®Œæˆæ¬¡æ•°
    // è®¡ç®—å®é™…å®Œæˆçš„å‘¨æ•°
    let completedWeeks = 0;
    
    // éœ€è¦è®¡ç®—çš„å‘¨èŒƒå›´ï¼šä»periodStartå¼€å§‹ï¼Œåˆ°thisWeekSundayç»“æŸ
    let currentWeekStart = new Date(periodStart);
    
    // è°ƒæ•´èµ·å§‹å‘¨çš„å¼€å§‹æ—¥æœŸåˆ°æ­£ç¡®çš„å‘¨ä¸€
    const startWeekday = currentWeekStart.getDay();
    const daysToStartMonday = startWeekday === 0 ? -6 : 1 - startWeekday; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨åˆ°å‘¨ä¸€
    currentWeekStart.setDate(currentWeekStart.getDate() + daysToStartMonday);
    
    console.log('è°ƒæ•´åçš„èµ·å§‹å‘¨å‘¨ä¸€:', currentWeekStart.toISOString().split('T')[0]);
    
    // è®¡ç®—éœ€è¦å¤„ç†çš„å‘¨æ•°
    const totalCalculatedWeeks = [];
    let tempWeekStart = new Date(currentWeekStart);
    
    // æ”¶é›†æ‰€æœ‰éœ€è¦æ£€æŸ¥çš„å‘¨
    while (tempWeekStart <= thisWeekSunday) {
      const tempWeekEnd = new Date(tempWeekStart);
      tempWeekEnd.setDate(tempWeekStart.getDate() + 6); // å‘¨æ—¥
      
      totalCalculatedWeeks.push({
        start: new Date(tempWeekStart),
        end: tempWeekEnd
      });
      
      tempWeekStart.setDate(tempWeekStart.getDate() + 7); // ä¸‹ä¸€å‘¨
    }
    
    console.log('éœ€è¦è®¡ç®—çš„å‘¨:', totalCalculatedWeeks.map(w => ({
      start: w.start.toISOString().split('T')[0],
      end: w.end.toISOString().split('T')[0]
    })));
    
    // æ£€æŸ¥æ¯ä¸€å‘¨çš„å®Œæˆæƒ…å†µ
    for (const week of totalCalculatedWeeks) {
      // æ£€æŸ¥è¿™ä¸€å‘¨å†…æ˜¯å¦å®Œæˆäº†ç›®æ ‡æ¬¡æ•°
      let weekCompletedCount = 0;
      for (const record of habit.calendar) {
        const recordDate = new Date(record.date);
        
        // æ£€æŸ¥è¿™ä¸ªè®°å½•æ˜¯å¦åœ¨å½“å‰å‘¨å†…
        if (recordDate >= week.start && recordDate <= week.end && record.completed) {
          weekCompletedCount += record.completedCount || 1;
        }
      }
      
      console.log('å‘¨å®Œæˆæƒ…å†µ:', {
        weekStart: week.start.toISOString().split('T')[0],
        weekEnd: week.end.toISOString().split('T')[0],
        weekCompletedCount,
        weeklyTarget
      });
      
      // å¦‚æœè¿™ä¸€å‘¨å®Œæˆäº†ç›®æ ‡æ¬¡æ•°ï¼Œåˆ™ç®—ä½œå®Œæˆä¸€å‘¨
      if (weekCompletedCount >= weeklyTarget) {
        completedWeeks++;
        console.log('å®Œæˆå‘¨:', week.start.toISOString().split('T')[0]);
      }
    }
    
    console.log('æ€»å…±å®Œæˆå‘¨æ•°:', completedWeeks, 'æ€»å‘¨æ•°:', totalCalculatedWeeks.length);
    
    // è®¡ç®—å®Œæˆç‡ï¼šå®Œæˆçš„å‘¨æ•° / æ€»å‘¨æ•° * 100%
    const totalCalculatedWeeksCount = totalCalculatedWeeks.length;
    const completionRate = totalCalculatedWeeksCount > 0 ? (completedWeeks / totalCalculatedWeeksCount) * 100 : 0;
    const roundedRate = Math.round(completionRate);
    
    console.log('å®Œæˆç‡è®¡ç®—ç»“æœ:', {
      completedWeeks,
      totalCalculatedWeeksCount,
      completionRate,
      roundedRate
    });
    
    return roundedRate;
  } else {
    // å¯¹äºæ—¥é¢‘æ¬¡ä¹ æƒ¯ï¼Œè®¡ç®—åŸºäºå¤©æ•°çš„å®Œæˆç‡
    
    console.log('æ—¥é¢‘æ¬¡ä¹ æƒ¯è®¡ç®—:', {
      monthRecordsCount: monthRecords.length,
      dayOfMonth: today.getDate()
    });
    
    if (monthRecords.length === 0) {
      console.log('æœ¬æœˆæ— æ‰“å¡è®°å½•ï¼Œå®Œæˆç‡: 0');
      return 0;
    }
    
    // è®¡ç®—æœ¬æœˆå·²åº¦è¿‡å¤©æ•°ï¼ˆä»æœˆåˆåˆ°ä»Šå¤©ï¼‰
    const dayOfMonth = today.getDate();
    
    // è®¡ç®—æœ¬æœˆå·²å®Œæˆçš„å¤©æ•°
    const completedDays = monthRecords.filter(record => record.completed).length;
    
    console.log('å®Œæˆå¤©æ•°ç»Ÿè®¡:', {
      completedDays,
      dayOfMonth
    });
    
    // è®¡ç®—å®Œæˆç‡ï¼šå·²å®Œæˆå¤©æ•° / æœ¬æœˆå·²åº¦è¿‡å¤©æ•° * 100%
    const completionRate = (completedDays / dayOfMonth) * 100;
    const roundedRate = Math.round(completionRate);
    
    console.log('å®Œæˆç‡è®¡ç®—ç»“æœ:', {
      completedDays,
      dayOfMonth,
      completionRate,
      roundedRate
    });
    
    return roundedRate;
  }
};

// è®¡ç®—æœ¬æœˆè¿ç»­æ‰“å¡å¤©æ•°
const calculateCurrentMonthStreak = (habit: Habit) => {
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();
  
  // è¿‡æ»¤å‡ºæœ¬æœˆçš„æ‰“å¡è®°å½•
  const monthRecords = habit.calendar
    .filter(record => {
      const recordDate = new Date(record.date);
      return recordDate.getFullYear() === currentYear && recordDate.getMonth() === currentMonth;
    })
    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
  
  if (monthRecords.length === 0 || !monthRecords[0].completed) {
    return 0; // å¦‚æœæœ¬æœˆæ²¡æœ‰è®°å½•æˆ–æœ€æ–°è®°å½•æœªå®Œæˆï¼Œåˆ™è¿ç»­å¤©æ•°ä¸º0
  }
  
  let streak = 0;
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const todayStr = getToday();
  let currentDate = new Date(today);
  
  // æ£€æŸ¥æ˜¯å¦ä»Šå¤©å·²å®Œæˆ
  const todayRecord = monthRecords.find(record => record.date === todayStr);
  if (todayRecord && todayRecord.completed) {
    streak++;
  }
  
  // å¾€å‰æ£€æŸ¥è¿ç»­çš„å®Œæˆæ—¥æœŸ
  for (let i = 1; ; i++) {
    const checkDate = new Date(currentDate);
    checkDate.setDate(currentDate.getDate() - i);
    
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
    const checkDateStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;
    
    // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨å½“å‰æœˆä»½
    if (checkDate.getMonth() !== currentMonth || checkDate.getFullYear() !== currentYear) {
      break; // å·²ç»è¶…å‡ºå½“å‰æœˆä»½ï¼Œåœæ­¢è®¡ç®—
    }
    
    const record = monthRecords.find(r => r.date === checkDateStr);
    if (record && record.completed) {
      streak++;
    } else {
      break; // é‡åˆ°æœªå®Œæˆçš„æ—¥æœŸï¼Œåœæ­¢è®¡ç®—
    }
  }
  
  return streak;
};

// è®¡ç®—æœ¬æœˆæ€»æ‰“å¡æ•°
const calculateTotalMonthCompletions = (habit: Habit) => {
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();
  
  // è¿‡æ»¤å‡ºæœ¬æœˆçš„æ‰“å¡è®°å½•å¹¶è®¡ç®—å®Œæˆçš„æ•°é‡
  return habit.calendar.filter(record => {
    const recordDate = new Date(record.date);
    return recordDate.getFullYear() === currentYear && 
           recordDate.getMonth() === currentMonth && 
           record.completed;
  }).length;
};

// åˆå§‹åŒ–ä¹ æƒ¯è§†å›¾æ¨¡å¼
const initializeHabitViewMode = (habit: Habit) => {
  if (habit.currentWeekOffset === undefined) {
    habit.currentWeekOffset = 0;
  }
};

// åˆå§‹åŒ–ç»Ÿè®¡é¡µé¢è§†å›¾æ¨¡å¼
const initializeStatsViewMode = (habit: Habit) => {
  if (!habit.statsViewMode) {
    habit.statsViewMode = 'month'; // ç»Ÿè®¡é¡µé¢é»˜è®¤ä¸ºæœˆè§†å›¾
  }
  if (habit.statsMonthOffset === undefined) {
    habit.statsMonthOffset = 0;
  }

};

// è·å–æ—¥å†è§†å›¾æ•°æ®ï¼ˆç”¨äºä¹ æƒ¯é¡¹ï¼Œå›ºå®šä¸ºå‘¨è§†å›¾ï¼‰
const getCalendarViewData = (habit: Habit) => {
  initializeHabitViewMode(habit);
  
  // ç›´æ¥ä½¿ç”¨å½“å‰æ—¥æœŸï¼Œç¡®ä¿è·å–æœ€æ–°çš„æ—¥æœŸ
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  
  return getWeekViewData(habit);
};

// è·å–å‘¨è§†å›¾æ•°æ®
const getWeekViewData = (habit: Habit) => {
  const todayDate = new Date();
  const targetDate = new Date(todayDate);
  targetDate.setDate(todayDate.getDate() + (habit.currentWeekOffset || 0) * 7);
  
  // æ‰¾åˆ°è¿™ä¸€å‘¨çš„å¼€å§‹ï¼ˆå‘¨ä¸€ï¼‰
  const startOfWeek = new Date(targetDate);
  const dayOfWeek = startOfWeek.getDay();
  // è®¡ç®—åˆ°å‘¨ä¸€çš„åç§»é‡ï¼ŒJavaScriptä¸­å‘¨æ—¥æ˜¯0ï¼Œå‘¨ä¸€åˆ°å‘¨å…­æ˜¯1-6
  // ä½¿ç”¨æ›´æ˜ç¡®çš„è®¡ç®—æ–¹æ³•æ¥ç¡®ä¿å‘¨ä¸€å¼€å§‹
  // å¦‚æœä»Šå¤©æ˜¯å‘¨æ—¥(dayOfWeek === 0)ï¼Œéœ€è¦å›é€€6å¤©åˆ°ä¸Šä¸€å‘¨çš„å‘¨ä¸€
  // å¦‚æœä»Šå¤©æ˜¯å‘¨å…­(dayOfWeek === 6)ï¼Œéœ€è¦å›é€€5å¤©åˆ°æœ¬å‘¨çš„å‘¨ä¸€
  const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
  startOfWeek.setDate(startOfWeek.getDate() + daysToMonday);
  
  // ç”Ÿæˆä¸€å‘¨çš„æ•°æ®ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
  const weekData = [];
  
    // æ£€æŸ¥æœ¬å‘¨æ˜¯å¦å·²ç»å®Œæˆæ‰€éœ€çš„æ‰“å¡æ¬¡æ•°ï¼ˆå¯¹weeklyNä¹ æƒ¯ï¼‰
  let requiredWeekCompletions = 1; // é»˜è®¤ä¸º1æ¬¡
  if (habit.frequency === 'weekly2') requiredWeekCompletions = 2;
  else if (habit.frequency === 'weekly3') requiredWeekCompletions = 3;
  else if (habit.frequency === 'weekly4') requiredWeekCompletions = 4;
  else if (habit.frequency === 'weekly5') requiredWeekCompletions = 5;
  else if (habit.frequency === 'weekly6') requiredWeekCompletions = 6;
  
  // è®¡ç®—æœ¬å‘¨å·²å®Œæˆçš„æ‰“å¡æ¬¡æ•°
  const completedThisWeek = habit.frequency.startsWith('weekly') ? 
    habit.calendar.filter(day => {
      const dayDate = new Date(day.date);
      // è®¡ç®—è¿™ä¸ªæ—¥æœŸå±äºå“ªä¸€å‘¨ï¼ˆå‘¨ä¸€ä¸ºä¸€å‘¨çš„å¼€å§‹ï¼‰
      const dayStartOfWeek = new Date(dayDate);
      const dayDayOfWeek = dayDate.getDay();
      const dayDaysToMonday = dayDayOfWeek === 0 ? -6 : 1 - dayDayOfWeek; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨6å¤©åˆ°å‘¨ä¸€
      dayStartOfWeek.setDate(dayDate.getDate() + dayDaysToMonday);
      
      // ç¡®ä¿æ—¥æœŸéƒ¨åˆ†ä¸€è‡´ï¼ˆé‡ç½®æ—¶é—´éƒ¨åˆ†ä¸º00:00:00ï¼‰
      const normalizedStartOfWeek = new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate());
      const normalizedDayStartOfWeek = new Date(dayStartOfWeek.getFullYear(), dayStartOfWeek.getMonth(), dayStartOfWeek.getDate());
      
      // æ£€æŸ¥æ˜¯å¦ä¸å½“å‰æŸ¥çœ‹çš„å‘¨æ˜¯åŒä¸€å‘¨
      return day.completed && 
        normalizedStartOfWeek.getTime() === normalizedDayStartOfWeek.getTime();
    }).length : 0;
    
  const hasCompletedRequiredThisWeek = completedThisWeek >= requiredWeekCompletions;
  
  for (let i = 0; i < 7; i++) {
    const currentDate = new Date(startOfWeek);
    currentDate.setDate(startOfWeek.getDate() + i);
    
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
    const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è¿›è¡Œæ¯”è¾ƒ
    const isTodayActual = isToday(dateStr);
    
    // æŸ¥æ‰¾å¯¹åº”çš„æ‰“å¡è®°å½•
    const calendarRecord = habit.calendar.find(day => day.date === dateStr);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è¿‡å»çš„æ—¥æœŸï¼ˆä»Šå¤©ä¹‹å‰çš„æ—¥æœŸï¼‰
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ¯”è¾ƒï¼Œé¿å…æ—¶åŒºé—®é¢˜
    const todayLocalDateStr = getToday();
    const isPast = dateStr < todayLocalDateStr;
    // æ£€æŸ¥æ˜¯å¦æ˜¯æœªæ¥çš„æ—¥æœŸï¼ˆä»Šå¤©ä¹‹åçš„æ—¥æœŸï¼‰
    const isFuture = dateStr > todayLocalDateStr;
    
    // å¯¹äºweeklyNä¹ æƒ¯ï¼Œå¦‚æœæœ¬å‘¨å·²ç»å®Œæˆæ‰€éœ€çš„æ‰“å¡æ¬¡æ•°ï¼Œåˆ™æ‰€æœ‰æ—¥æœŸéƒ½æ˜¾ç¤ºä¸ºå®ŒæˆçŠ¶æ€
    const actualCompleted = calendarRecord ? calendarRecord.completed : false;
    const isCompleted = hasCompletedRequiredThisWeek ? true : actualCompleted;
    // æ ‡è¯†æ˜¯å¦å› ä¸ºå‘¨é¢‘æ¬¡é€»è¾‘è€Œæ˜¾ç¤ºä¸ºå®Œæˆï¼ˆè€Œéå®é™…å®Œæˆå½“å¤©ä»»åŠ¡ï¼‰
    const isCompletedByWeeklyRule = hasCompletedRequiredThisWeek && !actualCompleted;
    
    weekData.push({
      date: dateStr,
      completed: isCompleted,
      completedCount: calendarRecord ? calendarRecord.completedCount || 0 : 0,
      targetCount: calendarRecord ? calendarRecord.targetCount || 1 : 1,
      isPast,
      isFuture,
      isToday: isTodayActual,
      isCompletedByWeeklyRule
    });
  }
  
  return weekData;
};

// è·å–ç»Ÿè®¡é¡µé¢æœˆè§†å›¾æ•°æ®
const getStatsMonthViewData = (habit: Habit) => {
  initializeStatsViewMode(habit);
  const today = new Date();
  const targetDate = new Date(today.getFullYear(), today.getMonth() + (habit.statsMonthOffset || 0), 1);
  
  // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
  const firstDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
  const lastDay = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0);
  
  // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­)
  // firstDay.getDay() ç”¨äºè®¡ç®— prevMonthDaysï¼Œå·²åœ¨ calculatePrevMonthDays å‡½æ•°ä¸­ä½¿ç”¨
  
  // è®¡ç®—å½“æœˆç¬¬ä¸€å¤©å‰é¢éœ€è¦æ˜¾ç¤ºçš„ä¸Šä¸ªæœˆçš„å¤©æ•°
  // ä¸ºç¡®ä¿æ—¥æœŸä¸æ˜ŸæœŸæ ‡é¢˜æ­£ç¡®å¯¹åº”ï¼Œéœ€è¦æ ¹æ®æ˜ŸæœŸè®¡ç®—åç§»é‡
  const prevMonthDays = calculatePrevMonthDays(firstDay);
  
  // è®¡ç®—éœ€è¦æ˜¾ç¤ºçš„æ€»å¤©æ•°ï¼ˆ5è¡Œ7åˆ—ï¼‰
  const daysInMonth = lastDay.getDate();
  const daysNeeded = 35; // 5è¡Œ7åˆ—
  
  const monthData = [];
  
  // æ·»åŠ ä¸Šä¸ªæœˆçš„æ—¥æœŸ
  for (let i = prevMonthDays; i > 0; i--) {
    const date = new Date(targetDate.getFullYear(), targetDate.getMonth(), -i + 1);
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    
    // æŸ¥æ‰¾å¯¹åº”çš„æ‰“å¡è®°å½•
    const calendarRecord = habit.calendar.find(day => day.date === dateStr);
    
    // æ›´ç²¾ç¡®åœ°åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æœˆ
    const isCurrentMonth = (date.getMonth() === targetDate.getMonth() && 
                          date.getFullYear() === targetDate.getFullYear());
    
    monthData.push({
      date: dateStr,
      completed: calendarRecord ? calendarRecord.completed : false,
      isCurrentMonth: isCurrentMonth
    });
  }
  
  // æ·»åŠ å½“å‰æœˆçš„æ—¥æœŸ
  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(targetDate.getFullYear(), targetDate.getMonth(), i);
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    
    // æŸ¥æ‰¾å¯¹åº”çš„æ‰“å¡è®°å½•
    const calendarRecord = habit.calendar.find(day => day.date === dateStr);
    
    // æ›´ç²¾ç¡®åœ°åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æœˆ
    const isCurrentMonth = (date.getMonth() === targetDate.getMonth() && 
                          date.getFullYear() === targetDate.getFullYear());
    
    monthData.push({
      date: dateStr,
      completed: calendarRecord ? calendarRecord.completed : false,
      isCurrentMonth: isCurrentMonth
    });
  }
  
  // æ·»åŠ ä¸‹ä¸ªæœˆçš„æ—¥æœŸï¼Œç›´åˆ°å¡«æ»¡6è¡Œ7åˆ—
  const remainingDays = daysNeeded - monthData.length;
  for (let i = 1; i <= remainingDays; i++) {
    const date = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, i);
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    
    // æŸ¥æ‰¾å¯¹åº”çš„æ‰“å¡è®°å½•
    const calendarRecord = habit.calendar.find(day => day.date === dateStr);
    
    // æ›´ç²¾ç¡®åœ°åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æœˆ
    const isCurrentMonth = (date.getMonth() === targetDate.getMonth() && 
                          date.getFullYear() === targetDate.getFullYear());
    
    monthData.push({
      date: dateStr,
      completed: calendarRecord ? calendarRecord.completed : false,
      isCurrentMonth: isCurrentMonth
    });
  }
  
  return monthData;
};

// æ›´æ”¹ç»Ÿè®¡é¡µé¢æ—¥å†æ—¶é—´æ®µ
const changeStatsCalendarPeriod = (habit: Habit, direction: number) => {
  initializeStatsViewMode(habit);
  
  habit.statsMonthOffset = (habit.statsMonthOffset || 0) + direction;
};

// è·å–å½“å‰æ—¶é—´æ®µæ–‡æœ¬
const getCurrentPeriodText = (habit: Habit) => {
  initializeStatsViewMode(habit);
  
  const today = new Date();
  const targetDate = new Date(today.getFullYear(), today.getMonth() + (habit.statsMonthOffset || 0), 1);
  
  const year = targetDate.getFullYear();
  const month = targetDate.getMonth() + 1;
  
  // æ ¹æ®è¯­è¨€ç¯å¢ƒæ ¼å¼åŒ–æ—¥æœŸ
  if (window.siyuan?.languages?.zh_CN) {
    return `${year}å¹´${month}æœˆ`;
  } else {
    // ä½¿ç”¨è‹±æ–‡æ ¼å¼ï¼Œä¾‹å¦‚ "January 2023"
    return targetDate.toLocaleDateString(window.siyuan?.languages?.lang || 'en', { year: 'numeric', month: 'long' });
  }
};



// å½“å‰é€‰ä¸­çš„ä¹ æƒ¯
const selectedHabit = ref<Habit | null>(null);

// æ˜ŸæœŸåç§°æ•°ç»„ï¼Œæ”¯æŒå›½é™…åŒ–
const weekdaysForCalendar = computed(() => {
  // æ ¹æ®å½“å‰è¯­è¨€ç¯å¢ƒè¿”å›ç›¸åº”çš„æ˜ŸæœŸåç§°
  if (window.siyuan?.languages?.zh_CN) {
    return ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
  } else {
    // é»˜è®¤ä½¿ç”¨è‹±æ–‡ç¼©å†™
    return ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  }
});


// è®¡ç®—å½“æœˆç¬¬ä¸€å¤©å‰éœ€è¦æ˜¾ç¤ºçš„å¤©æ•°
const calculatePrevMonthDays = (firstDay: Date) => {
  // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­)
  const dayOfWeek = firstDay.getDay();
  // è®¡ç®—å‰é¢éœ€è¦å¤šå°‘å¤©æ¥è‡ªä¸Šä¸ªæœˆ
  // ä¸ºäº†è®©æ—¥æœŸæ­£ç¡®å¯¹åº”åˆ°æ˜ŸæœŸæ ‡é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—æ­£ç¡®çš„åç§»é‡
  // æ˜ŸæœŸä¸€(1) â†’ 0å¤©åç§», æ˜ŸæœŸäºŒ(2) â†’ 1å¤©åç§», ..., æ˜ŸæœŸæ—¥(0) â†’ 6å¤©åç§»
  return dayOfWeek === 0 ? 6 : dayOfWeek - 1;
};

// è®¡ç®—å½“å‰æ—¥æœŸå­—ç¬¦ä¸²
const currentDateString = computed(() => {
  const date = new Date(); // ç›´æ¥è·å–å½“å‰æ—¥æœŸï¼Œè€Œä¸æ˜¯ä½¿ç”¨currentDayInfo
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  return `${month}/${day}/å‘¨${weekdays[date.getDay()]}`;
});

// æ˜¾ç¤ºä¹ æƒ¯ç»Ÿè®¡é¡µé¢
const showHabitStats = (habit: Habit) => {
  selectedHabit.value = habit;
};

// æ˜¾ç¤ºç¼–è¾‘ä¹ æƒ¯æ¨¡æ€æ¡†
const showEditHabitModal = ref(false);
const editedHabit = ref<Habit | null>(null);

// æ‰“å¼€ç¼–è¾‘ä¹ æƒ¯æ¨¡æ€æ¡†
const openEditHabitModal = () => {
  if (selectedHabit.value) {
    // åˆ›å»ºä¹ æƒ¯çš„å‰¯æœ¬ä»¥é¿å…ç›´æ¥ä¿®æ”¹åŸå¯¹è±¡
    editedHabit.value = JSON.parse(JSON.stringify(selectedHabit.value));
    showEditHabitModal.value = true;
  }
};

// å…³é—­ç¼–è¾‘ä¹ æƒ¯æ¨¡æ€æ¡†
const closeEditHabitModal = () => {
  showEditHabitModal.value = false;
  editedHabit.value = null;
};

// ä¸ºç¼–è¾‘ä¹ æƒ¯é€‰æ‹©emoji
const selectEmojiForEdit = (emoji: string) => {
  if (editedHabit.value) {
    editedHabit.value.emoji = emoji;
  }
};

// å¤„ç†timesPerDayå˜æ›´
const onTimesPerDayChange = (value: string | number) => {
  if (editedHabit.value) {
    editedHabit.value.timesPerDay = typeof value === 'string' ? parseInt(value) || 1 : value;
  }
};

// ä¿å­˜ç¼–è¾‘åçš„ä¹ æƒ¯
const saveEditedHabit = async () => {
  if (editedHabit.value && selectedHabit.value) {
    // ç¡®ä¿timesPerDayæ˜¯æ•°å­—ç±»å‹
    if (typeof editedHabit.value.timesPerDay === 'string') {
      editedHabit.value.timesPerDay = parseInt(editedHabit.value.timesPerDay) || 1;
    }
    
    // æ›´æ–°åŸå§‹ä¹ æƒ¯å¯¹è±¡
    Object.assign(selectedHabit.value, editedHabit.value);
    
    // ä¿å­˜åˆ°å­˜å‚¨
    await saveHabits(habits.value);
    
    // å…³é—­æ¨¡æ€æ¡†
    closeEditHabitModal();
  }
};

// å…³é—­ç»Ÿè®¡é¡µé¢
const closeHabitStats = () => {
  selectedHabit.value = null;
};

// åˆ‡æ¢ç»Ÿè®¡é¡µé¢è§†å›¾æ¨¡å¼ï¼ˆå·²ç§»é™¤ï¼Œç»Ÿè®¡é¡µé¢åªæ˜¾ç¤ºæœˆè§†å›¾ï¼‰
// const toggleStatsViewMode = (habit: Habit) => {
//   initializeStatsViewMode(habit);
//   habit.statsViewMode = habit.statsViewMode === 'month' ? 'week' : 'month';
// };
</script>

<style lang="scss" scoped>
.Pinch-habit-container {
  width: 100%;
  height: 100%;
  box-sizing: border-box;
  overflow-y: auto;
  padding: 4px;
  
  .Pinch-habit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    
    h2 {
      margin: 0;
      color: var(--b3-theme-on-background);
    }
    
    .icon {
      margin-right: 4px;
      vertical-align: middle;
      width: 16px;
      height: 16px;
    }
    
    #add-habit-btn {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: 28px;
      height: 28px;
      
      svg {
        color: var(--b3-theme-on-background);
        width: 28px;
        height: 28px;
      }
    }
  }
  
  .habit-list {
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--b3-font-color1);
      font-size: 16px;
    }
    
    .habits-grid {
      display: grid;
      gap: 8px;
    }
    
    .habit-card {
      background: var(--b3-theme-background);
      border-radius: 15px;
      box-shadow: rgba(0, 0, 0, 0.03) 0px 1px 5px 0px;
      
      .habit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        
        .habit-title {
          font-size: 16px;
          font-weight: bold;
          color: var(--b3-theme-on-background);
          flex: 1;
          margin-left: 2px;
        }
        
        .habit-actions {
          display: flex;
          gap: 8px;
        }
      }
      
      .habit-stats {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--b3-border-color);
        
        .stats-item {
          text-align: center;
          
          .stat-label {
            display: block;
            font-size: 12px;
            color: var(--b3-font-color1);
          }
          
          .stat-value {
            display: block;
            font-weight: bold;
            color: var(--b3-theme-on-background);
          }
        }
      }
      
      .habit-calendar {
        .calendar-controls {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          
          .view-selector {
            display: flex;
            gap: 4px;
            
            .view-btn {
              padding: 4px 8px;
              border: 1px solid var(--b3-border-color);
              background-color: var(--b3-list-background);
              color: var(--b3-font-color1);
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
              
              &.active {
                background-color: var(--b3-theme-primary);
                color: var(--b3-theme-on-primary);
                border-color: var(--b3-theme-primary);
              }
              
              &:hover {
                background-color: var(--b3-list-hover);
              }
            }
          }
          
          .calendar-navigation {
            display: flex;
            align-items: center;
            gap: 8px;
            
            .nav-btn {
              padding: 2px 6px;
              border: 1px solid var(--b3-border-color);
              background-color: var(--b3-list-background);
              color: var(--b3-font-color1);
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
              
              &:hover {
                background-color: var(--b3-list-hover);
              }
            }
            
            .current-period {
              font-size: 12px;
              color: var(--b3-font-color1);
              min-width: 120px;
              text-align: center;
            }
          }
        }
        
        .calendar-weekdays {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          text-align: center;
          font-size: 12px;
          color: var(--b3-font-color1);
          margin-bottom: 4px;
        }
        
        .calendar-days {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 2px;
          
          .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 12px;
            background-color: var(--b3-list-background);
            color: var(--b3-font-color1);
            
            &.completed {
              background-color: var(--b3-success-background);
              color: var(--b3-success-text);
            }
            
            &.today {
              border: 2px solid var(--b3-theme-primary);
            }
            
            .day-number {
              font-size: 12px;
            }
          }
        }
      }
    }
  }
  
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
    
    .modal-content {
      background-color: var(--b3-theme-surface);
      border-radius: 10px;
      width: 400px;
      max-width: 90vw;
      box-shadow: var(--b3-dialog-shadow);
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        
        h3 {
          margin: 0;
          color: var(--b3-theme-on-background);
        }
      }
      
      .modal-body {
        padding: 16px;
        
        .form-group {
          margin-bottom: 16px;
          
          label {
            display: block;
            margin-bottom: 4px;
            color: var(--b3-theme-on-background);
            font-size: 14px;
          }
        }
      }
      
      .modal-footer {
        padding: 16px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
    }
  }
}

.stats-panel {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--b3-theme-surface);
  z-index: 2;
  padding: 16px;
  box-sizing: border-box;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  
  .stats-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--b3-border-color);
    
    .stats-emoji {
      font-size: 24px;
      margin-right: 10px;
    }
    
    .stats-title {
      flex: 1;
      font-size: 18px;
      font-weight: bold;
    }
    
    .stats-header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
  }
  
  .stats-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
      
      .stat-item {
        text-align: center;
        background: var(--b3-list-background);
        border-radius: 4px;
        
        .stat-value {
          font-size: 24px;
          font-weight: bold;
          color: #ee6f5b;
          margin-bottom: 4px;
        }
        
        .stat-label {
          font-size: 12px;
          color: var(--b3-font-color1);
        }
      }
    }
    
    .calendar-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
      padding: 8px;
      background: var(--b3-list-background);
      border-radius: 4px;
      
      .view-selector {
        display: flex;
        gap: 4px;
        
        .sy-button {
          min-width: 60px;
        }
      }
      
      .calendar-navigation {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        justify-content: center;
        
        .nav-btn {
          background: none;
          border: none;
          padding: 4px;
          cursor: pointer;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background-color 0.2s;
          
          &:hover {
            background-color: var(--b3-list-hover);
          }
          
          &:active {
            background-color: var(--b3-list-hover);
          }
        }
        
        .current-period {
          min-width: 120px;
          text-align: center;
          font-size: 14px;
        }
      }
    }
    
    .calendar-view {
      flex: 1;
      margin-bottom: 20px;
      
      .weekdays-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--b3-font-color1);
      }
      
      .week-view {
        .week-data {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 4px;
        }
      }
      
      .month-view {
        .month-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 8px;
        }
      }
      
      .day {
        position: relative;
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 30%;
        background: var(--b3-list-background);
        cursor: default;
        font-weight: 700;
        transition: background-color 0.2s;
        
        &.completed {
          background: #ee6f5b;
          color: var(--b3-theme-background);
          font-weight: bold;
        }
        
        &.today {
          box-shadow: 0 0 0 2px oklch(68.98% 0.161 30.76 / 0.3);
        }
        
        &.not-current-month:not(.completed) {
          color: var(--b3-theme-on-background);
        }
        &.not-current-month{
          opacity: 0.3;
        }
        
        &.past:not(.completed) {
          color: oklch(68.98% 0.161 30.76 / 0.3);
        }
        
        &.future:not(.completed) {
          color: var(--b3-list-hover);
        }
        
        .day-number {
          font-size: 12px;
        }
      }
    }
    
    .stats-actions {
      display: flex;
      justify-content: center;
      margin-top: auto;
      
      .sy-button {
        min-width: 120px;
      }
    }
  }
}

.today-calendar {
  margin-bottom: 20px;
  padding: 16px;
  background-color: var(--b3-theme-surface);
  border: 1px solid var(--b3-border-color);
  border-radius: var(--b3-border-radius);
  box-shadow: var(--b3-point-shadow);
  
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--b3-border-color);
    
    h3 {
      margin: 0;
      font-size: 16px;
      color: var(--b3-theme-on-background);
    }
    
    .calendar-actions {
      display: flex;
      gap: 8px;
      
      .sy-button {
        min-width: 40px;
      }
    }
  }
  
  .calendar-day {
    .day-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 8px 0;
      
      .day-date {
        font-size: 18px;
        font-weight: bold;
        color: var(--b3-theme-on-background);
      }
      
      .day-weather {
        font-size: 16px;
      }
    }
    
    .day-habits {
      .habit-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin-bottom: 8px;
        background-color: var(--b3-list-background);
        border-radius: 4px;
        
        &:last-child {
          margin-bottom: 0;
        }
        
        .habit-emoji {
          margin-right: 8px;
          font-size: 18px;
        }
        
        .habit-name {
          flex: 1;
          color: var(--b3-theme-on-background);
        }
        
        .sy-checkbox {
          margin-left: auto;
        }
      }
      
      .no-habits {
        text-align: center;
        padding: 20px;
        color: var(--b3-font-color3);
        font-style: italic;
      }
    }
  }
}

.pomodoro-page {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  min-height: 400px;
  padding: 20px;
  
  .pomodoro-display {
    text-align: center;
    width: 100%;
    max-width: 400px;
    padding: 30px;
    background-color: var(--b3-theme-background);
    border-radius: 16px;
    
    h2 {
      margin: 0 0 30px 0;
      font-size: 28px;
      color: var(--b3-theme-on-background);
      font-weight: 600;
    }
    
    .timer {
      font-size: 80px;
      font-weight: bold;
      color: #e74c3c;
      margin: 20px 0;
      text-align: center;
      letter-spacing: 2px;
      
      &.pomodoro-running {
        color: #e74c3c;
      }
      
      &.pomodoro-short-break {
        color: #3498db;
      }
      
      &.pomodoro-long-break {
        color: #2ecc71;
      }
    }
    
    .pomodoro-controls {
      margin-top: 40px;
      
      .stop-btn {
        background-color: #ff6b6b;
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s;
        
        &:hover {
          background-color: #ff5252;
        }
      }
    }
  }
}
</style>
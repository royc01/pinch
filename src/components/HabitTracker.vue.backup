<template>
  <div class="Pinch-habit-container">
    <!-- ä¹ æƒ¯åˆ—è¡¨é¡µé¢ -->
    <div class="habit-list-container">
      <div class="Pinch-habit-header">
        <div class="header-content">
          <div class="date-display">{{ currentDateString.split('/')[0] }}<span>.</span>{{ currentDateString.split('/')[1] }}<span>.</span>{{ currentDateString.split('/')[2] }}</div>
          <div class="header-buttons">
            <SyButton @click="showMoodCalendar = true" id="mood-calendar-btn" class="mood-calendar-btn">
              <svg t="1767958238562" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5893" width="200" height="200"><path d="M512 85.290667C747.648 85.290667 938.666667 276.352 938.666667 512.042667c0 235.648-191.061333 426.709333-426.709334 426.709333-235.690667 0-426.752-191.061333-426.752-426.709333C85.248 276.352 276.309333 85.248 512 85.248zM360.96 630.784a32 32 0 0 0-50.261333 39.594667A255.616 255.616 0 0 0 512 768.085333c79.36 0 152.746667-36.394667 201.045333-97.450666a32 32 0 0 0-50.261333-39.68A191.616 191.616 0 0 1 512 704.085333c-59.690667 0-114.773333-27.306667-150.997333-73.301333zM384 373.333333a53.333333 53.333333 0 1 0 0 106.624A53.333333 53.333333 0 0 0 384 373.333333z m256 0a53.333333 53.333333 0 1 0 0 106.624 53.333333 53.333333 0 0 0 0-106.624z" fill="var(--b3-theme-on-background)" ></path></svg>
            </SyButton>
            <SyButton @click="showTotalStatsPage = true" id="stats-btn" class="stats-btn">
              <svg t="1767958081939" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4693" width="200" height="200"><path d="M64.67 512c2.03-148.27 27.78-271.04 103.07-344.26C240.96 92.45 363.73 66.7 512 64.67c148.27 2.03 271.04 27.78 344.26 103.07C931.55 240.96 957.3 363.73 959.33 512c-2.03 148.27-27.78 271.04-103.07 344.26C783.04 931.55 660.27 957.3 512 959.33c-148.27-2.03-271.04-27.78-344.26-103.07C92.45 783.04 66.7 660.27 64.67 512z" ></path><path d="M339.12 720.13c-26.83 0-48.77-21.95-48.77-48.77V446.89c0-26.83 21.95-48.77 48.77-48.77 26.83 0 48.77 21.95 48.77 48.77v224.47c0.01 26.82-21.94 48.77-48.77 48.77zM512 720.13c-26.83 0-48.77-21.95-48.77-48.77V352.64c0-26.83 21.95-48.77 48.77-48.77 26.83 0 48.77 21.95 48.77 48.77v318.71c0 26.83-21.94 48.78-48.77 48.78zM684.88 720.13c-26.83 0-48.77-21.95-48.77-48.77V533.13c0-26.83 21.95-48.77 48.77-48.77 26.83 0 48.77 21.95 48.77 48.77v138.23c0 26.82-21.95 48.77-48.77 48.77z" fill="var(--b3-theme-background)" ></path></svg>
            </SyButton>
            <SyButton @click="showAddHabitModal = true" id="add-habit-btn">
              <svg t="1767249216319" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1606" width="16" height="16">
                <path d="M512.67794 65.291029C265.701966 65.004503 66.200236 263.518742 65.293587 510.472204c-0.916882 247.286036 198.739367 447.915449 446.048939 448.236767 247.38632 0.322341 447.196065-199.272509 447.366957-446.883957C958.882422 265.25734 759.426741 65.579601 512.67794 65.291029zM772.621251 544.93204c-0.64059 26.420743-15.491833 41.562605-41.989323 41.606607-47.989991 0.080841-95.982028 0.124843-143.972019 0.151449 0.01228 45.808302 0.017396 91.615581-0.026606 137.418766-0.033769 35.107589-13.380752 48.577369-48.030923 48.683792-19.839861 0.061398-39.694047 0.370437-59.528791-0.11154-26.414603-0.642636-41.552371-15.495926-41.596374-41.999556-0.079818-47.998177-0.12382-95.996354-0.150426-143.993508-47.941895-0.027629-95.882767-0.072655-143.826709-0.154519-26.546609-0.044002-41.48381-15.205307-42.060955-41.548278-0.478907-21.701255-0.385786-43.417859-0.038886-65.119113 0.438998-27.465538 15.230889-42.333154 42.967604-42.441625 47.653323-0.176009 95.307669-0.155543 142.959969-0.122797 0.027629-47.950082 0.072655-95.89914 0.154519-143.851269 0.041956-26.552749 15.20019-41.49302 41.537022-42.070164 21.694091-0.477884 43.408649-0.385786 65.103764-0.037862 27.460422 0.438998 42.323944 15.233959 42.432415 42.977837 0.176009 47.667649 0.155543 95.335299 0.122797 143.001925 45.796022-0.01228 91.591021-0.017396 137.38295 0.026606 35.100426 0.033769 48.565089 13.382798 48.671513 48.039109C772.796236 505.231853 773.105275 525.093203 772.621251 544.93204z" p-id="1607"></path>
              </svg>
            </SyButton>
          </div>
        </div>
      </div>

      <!-- æœ¬å‘¨æ—¥æœŸæ˜¾ç¤ºï¼Œä»å‘¨ä¸€å¼€å§‹ -->
      <div class="week-dates">
        <div 
          v-for="date in weekDates" 
          :key="date.fullDate"
          :class="['week-date-item', { today: date.isToday }]"
          @mouseenter="showCustomTooltip(date.fullDate, $event)"
          @mouseleave="hideCustomTooltip"
          @click="openMoodTracker(date.fullDate)">
          <span class="weekday-name">{{ date.dayName }}</span>
          <span v-if="moodData[date.fullDate] && moodData[date.fullDate].emoji" class="mood-emoji">
            <div v-html="getSmallMoodSvg(moodData[date.fullDate].emoji)" class="mood-svg-small"></div>
          </span>
          <div class="week-date-number">{{ date.date }}</div>
        </div>
      </div>
      
      <!-- è‡ªå®šä¹‰æç¤ºæ¡† -->
      <div v-if="tooltipVisible && tooltipContent" 
           class="custom-tooltip" 
           :style="tooltipStyle">
        {{ tooltipContent }}
      </div>

      <div class="habit-list">
        <div v-if="habits.length === 0" class="empty-state">
          {{ t('habitTracker.noHabits') }}
        </div>
        <div v-else class="habits-grid">
          <transition-group name="habit-list" tag="div" class="habits-container">
          <div v-for="habit in sortedHabits" :key="habit.id" :class="['habit-card', { 'completed': habit.completedToday || (habit.frequency && habit.frequency.startsWith('weekly') && getWeeklyCompletionStatus(habit)), 'paused': habit.isPaused }]">
            <div class="habit-week-view">
              <div class="week-habit-item">
                <div class="emoji-section" @click="showHabitStats(habit)">
                  <span class="habit-emoji">{{ habit.emoji || 'ğŸ“' }}</span>
                </div>
                <div class="habit-info" @click="showHabitStats(habit)">
                  <div class="habit-title">
                                  {{ habit.name }}
                                  <span v-if="habit.usePomodoro" class="pomodoro-indicator">ğŸ… {{ habit.pomodoroDuration ? habit.pomodoroDuration + 'min' : '25min' }}</span>
                                </div>
                  <div class="week-checkboxes">
                    <div 
                      v-for="day in getCalendarViewData(habit)" 
                      :key="day.date" 
                      :class="['day-checkbox', { completed: day.completed, today: day.isToday, past: day.isPast, future: day.isFuture, 'completed-by-weekly-rule': day.isCompletedByWeeklyRule }]"
                      :title="day.date"
                      @click="toggleDayCompletion(habit, day.date)"
                    >
                      <svg
                        class="day-checkbox-icon"
                        :class="{ completed: day.completed }"
                        viewBox="0 0 1024 1024"
                        width="16"
                        height="16"
                        xmlns="http://www.w3.org/2000/svg"
                        >
                        <path 
                          v-if="!day.completed"
                          d="M698.8,1024H325.2C145.6,1024,0,878.4,0,698.8V325.2C0,145.6,145.6,0,325.2,0h373.7
	C878.4,0,1024,145.6,1024,325.2v373.7C1024,878.4,878.4,1024,698.8,1024z"
                        ></path>
                        <path 
                          v-else
                          d="M698.8,0H325.2C145.6,0,0,145.6,0,325.2v373.7C0,878.4,145.6,1024,325.2,1024h373.7
	c179.6,0,325.2-145.6,325.2-325.2V325.2C1024,145.6,878.4,0,698.8,0z M749.4,364.5L526.7,720.7c-8.9,14.3-23.8,23.8-40.6,25.8
	c-2,0.2-3.9,0.3-5.9,0.3c-14.6,0-28.6-5.9-39-16.6l-136.4-140c-21.6-22.4-21.5-57.8,0-80.2c20.8-21.6,55.1-22.2,76.7-1.4
	c0.5,0.5,0.9,0.9,1.4,1.4l87.9,90.3l185.7-296.9c16.5-26.3,50.6-34,76.3-17.1C758.4,303.1,765.8,338.2,749.4,364.5z"
                        ></path>
                      </svg>
                    </div>
                  </div>
                </div>
                <div class="habit-actions">
                  <!-- é»˜è®¤æŒ‰é’® -->
                  <SyButton @click="toggleHabit(habit.id)" :type="habit.completedToday || (habit.frequency && habit.frequency.startsWith('weekly') && getWeeklyCompletionStatus(habit)) ? 'success' : 'default'" size="small" :class="['check-in-btn', { 'success-animation': showAnimation && animationHabitId === habit.id }]" :disabled="habit.isPaused">
                                  <div v-if="showAnimation && animationHabitId === habit.id" class="rays-container">
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                    <div class="ray"></div>
                                  </div>
                    <svg v-if="habit.usePomodoro && habit.pomodoroRemaining !== undefined" :class="{'completed': habit.completedToday}" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      <path d="M417.79639 1024c-31.740625 0-62.423229-12.901028-85.153612-36.177486l-297.372113-305.324334a125.972738 125.972738 0 0 1 0.03413-174.812345 118.293555 118.293555 0 0 1 170.307224 0l191.60416 196.826004L802.165119 56.968961C838.103697-0.471331 912.608842-17.194886 968.547427 19.733454c55.972715 36.860081 72.218454 113.310618 36.279876 170.68265L519.161612 967.139913a120.170689 120.170689 0 0 1-88.464194 56.211623 130.37547 130.37547 0 0 1-12.901028 0.648464z"></path>
                    </svg>
                    <svg v-else-if="!habit.usePomodoro && (habit.completedToday || (habit.timesPerDay && habit.timesPerDay > 1 && getTodayCompletionCount(habit) === 0) || !habit.timesPerDay || habit.timesPerDay <= 1)" :class="{'completed': habit.completedToday}" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      <path d="M417.79639 1024c-31.740625 0-62.423229-12.901028-85.153612-36.177486l-297.372113-305.324334a125.972738 125.972738 0 0 1 0.03413-174.812345 118.293555 118.293555 0 0 1 170.307224 0l191.60416 196.826004L802.165119 56.968961C838.103697-0.471331 912.608842-17.194886 968.547427 19.733454c55.972715 36.860081 72.218454 113.310618 36.279876 170.68265L519.161612 967.139913a120.170689 120.170689 0 0 1-88.464194 56.211623 130.37547 130.37547 0 0 1-12.901028 0.648464z"></path>
                    </svg>
                    <svg v-else-if="habit.timesPerDay && habit.timesPerDay > 1 && getTodayCompletionCount(habit) > 0 && getTodayCompletionCount(habit) < habit.timesPerDay" 
                         class="progress-pie" 
                         width="26" 
                         height="26" 
                         viewBox="0 0 26 26">
                      <clipPath id="rect-clip">
                        <rect x="0" y="0" width="26" height="26" rx="8" ry="8" />
                      </clipPath>
                      <rect class="progress-pie__background" 
                            x="0" 
                            y="0" 
                            width="26" 
                            height="26" 
                            rx="8" 
                            ry="8" 
                            fill="var(--b3-list-hover)" />
                      <g clip-path="url(#rect-clip)">
                        <path class="progress-pie__progress" 
                              :d="getLargePiePath(habit)"
                              fill="#f98f7a" />
                      </g>
                      <text x="13" y="16" text-anchor="middle" class="progress-pie__text">{{ getTodayCompletionCount(habit) }}</text>
                    </svg>
                    <span class="pomodoro-timer" v-else-if="habit.usePomodoro && habit.pomodoroRemaining !== undefined">
                      {{ formatPomodoroTime(habit.pomodoroRemaining) }}
                    </span>
                    <svg v-else :class="{'completed': habit.completedToday}" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      <path d="M417.79639 1024c-31.740625 0-62.423229-12.901028-85.153612-36.177486l-297.372113-305.324334a125.972738 125.972738 0 0 1 0.03413-174.812345 118.293555 118.293555 0 0 1 170.307224 0l191.60416 196.826004L802.165119 56.968961C838.103697-0.471331 912.608842-17.194886 968.547427 19.733454c55.972715 36.860081 72.218454 113.310618 36.279876 170.68265L519.161612 967.139913a120.170689 120.170689 0 0 1-88.464194 56.211623 130.37547 130.37547 0 0 1-12.901028 0.648464z"></path>
                    </svg>
                  </SyButton>
                </div>
              </div>
              <!-- ç•ªèŒ„é’ŸåŠŸèƒ½åŒºåŸŸ -->
              <div v-if="habit.usePomodoro && habit.id === activePomodoroHabit?.id" class="pomodoro-inline-display">
                <div class="pomodoro-timer-inline">
                  <div class="timer-container">
                    <div class="timer" :class="pomodoroStateClass(habit.pomodoroState)">{{ formatPomodoroTime(habit.pomodoroRemaining || 25 * 60) }}</div>
                    <svg class="progress-ring" width="100" height="100">
                      <circle class="progress-ring__bg" r="45" cx="50" cy="50" />
                      <circle class="progress-ring__progress" r="45" cx="50" cy="50" :stroke-dasharray="inlineCircumference" :stroke-dashoffset="inlineStrokeDashoffset" />
                    </svg>
                  </div>
                </div>
                <div class="pomodoro-controls-inline">
                  <button @click="togglePomodoroPause" v-if="!habit.isPomodoroPaused" class="pause-btn">
                    <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      <path d="M768 912c-44.16 0-80-35.84-80-80V192a80 80 0 0 1 160 0v640c0 44.16-35.84 80-80 80zM256 912c-44.16 0-80-35.84-80-80V192a80 80 0 0 1 160 0v640c0 44.16-35.84 80-80 80z" ></path>
                    </svg>
                  </button>
                  <button @click="togglePomodoroResume" v-if="habit.isPomodoroPaused" class="resume-btn">
                    <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      <path d="M897.143467 597.051733l-464.648534 311.5264c-46.976 31.488-110.592 18.944-142.08-28.023466A102.4 102.4 0 0 1 273.066667 823.5264V200.4736c0-56.5504 45.8496-102.4 102.4-102.4a102.4 102.4 0 0 1 57.028266 17.348267l464.64 311.5264c46.976 31.488 59.528533 95.104 28.032 142.08a102.4 102.4 0 0 1-28.023466 28.023466z"></path>
                    </svg>
                  </button>
                  <button @click="stopCurrentPomodoro" class="stop-btn">
                    <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      <path d="M722.9375 933.875H301.0625a210.9375 210.9375 0 0 1-210.9375-210.9375V301.0625a210.9375 210.9375 0 0 1 210.9375-210.9375h421.875a210.9375 210.9375 0 0 1 210.9375 210.9375v421.875a210.9375 210.9375 0 0 1-210.9375 210.9375z"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
          </transition-group>
        </div>
      </div>
    </div>

    <!-- ä¹ æƒ¯ç»Ÿè®¡é¢æ¿ -->
    <div v-if="selectedHabit" class="stats-panel">
      <div class="stats-header">
        <div class="stats-header-content">
          <button @click="openEditHabitModal" class="icon-button">
            <svg class="icon" viewBox="0 0 200 200" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M0,190c0-5.5,4.5-10,10-10h0h180c5.5,0,10,4.5,10,10c0,5.5-4.5,10-10,10c0,0,0,0,0,0H10C4.5,200,0,195.5,0,190 L0,190L0,190z M133.5,0c2.7,0,5.2,1.1,7.1,2.9l36.5,36.5c3.9,3.9,3.9,10.2,0,14.1L73.7,157.1c-1.9,1.9-4.4,2.9-7.1,2.9H30 c-5.5,0-10-4.5-10-10l0,0v-36.4c0-2.7,1-5.2,2.9-7.1L126.4,2.9C128.3,1.1,130.8,0,133.5,0z" ></path>
            </svg>
          </button>
          <div class="stats-title">{{ selectedHabit.name }}</div>
          <button @click="closeHabitStats" class="icon-button">
            <svg class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M39.156558 39.219619a133.725281 133.725281 0 0 1 189.221272 0L984.594293 795.703532a133.725281 133.725281 0 0 1-189.221272 189.087547L39.156558 228.307166a133.725281 133.725281 0 0 1 0-189.087547z m0 756.483913L795.373021 39.219619a133.725281 133.725281 0 0 1 189.221272 189.087547L228.37783 984.791079a133.792143 133.792143 0 1 1-189.221272-189.288135z" ></path>
            </svg>
          </button>
        </div>
        <div class="stats-emoji">{{ selectedHabit.emoji || 'ğŸ“' }}</div>
        <div class="habit-meta">
          <span class="habit-frequency">{{ getFrequencyText(selectedHabit) }}</span>
          <span class="habit-created">{{ getCreatedDateText(selectedHabit) }}</span>
        </div>
      </div>
      <div class="stats-content">
        <!-- æ—¥å†æ§ä»¶å’Œè§†å›¾å®¹å™¨ -->
        <div class="calendar-container">
          <!-- æ—¥å†æ§ä»¶ -->
          <div class="calendar-controls">
            <div class="calendar-navigation">
              <button @click="changeStatsCalendarPeriod(selectedHabit, -1)" class="nav-btn">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                  <path d="M747.245 81.064c-28.497-29.315-74.739-29.315-103.307 0l-367.236 378.011c-28.483 29.367-28.483 76.982 0 106.291l367.236 377.997c28.562 29.367 74.806 29.367 103.307 0 28.546-29.325 28.546-76.929 0-106.304l-315.6-324.841 315.599-324.803c28.545-29.367 28.544-76.973 0-106.356l0 0z" :fill="`var(--b3-theme-on-background)`"></path>
                </svg>
              </button>
              <span class="current-period">{{ getCurrentPeriodText(selectedHabit) }}</span>
              <button @click="changeStatsCalendarPeriod(selectedHabit, 1)" class="nav-btn">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                  <path d="M276.755 942.936c28.497 29.315 74.739 29.315 103.307 0l367.236-378.011c28.483-29.367 28.483-76.982 0-106.291l-367.236-377.997c-28.562-29.367-74.806-29.367-103.307 0-28.546 29.325-28.546 76.929 0 106.304l315.6 324.841-315.599 324.803c-28.545 29.367-28.544 76.973 0 106.356l0 0z" :fill="`var(--b3-theme-on-background)`"></path>
                </svg>
              </button>
            </div>
          </div>
          <!-- æœˆè§†å›¾ -->
          <div class="calendar-view">
            <div class="month-view">
              <div class="weekdays-header">
                <div v-for="day in weekdaysForCalendar" :key="day" class="weekday">{{ day }}</div>
              </div>
              <div class="month-grid">
                <div 
                  v-for="day in getStatsMonthViewData(selectedHabit)" 
                  :key="day.date" 
                  :class="['day', { completed: day.completed, today: day.date === getToday(), 'not-current-month': !day.isCurrentMonth }]"
                  @click="!selectedHabit.isPaused && toggleDayCompletion(selectedHabit, day.date)"
                >
                  <span class="day-number">{{ day.date.split('-')[2] }}</span>
                  <!-- å½“ç›®æ ‡æ¬¡æ•°å¤§äº1æ—¶æ˜¾ç¤ºè¿›åº¦æ¡ -->
                  <div v-if="day.targetCount > 1" class="day-progress-container">
                    <div class="day-progress-bar">
                      <div class="day-progress-fill" :style="{ width: (day.completedCount / day.targetCount * 100) + '%' }"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">{{ calculateCurrentMonthStreak(selectedHabit) }}</div>
            <div class="stat-label">{{ t('habitTracker.currentStreak') }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ calculateTotalMonthCompletions(selectedHabit) }}</div>
            <div class="stat-label">{{ t('habitTracker.totalCompletions') }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ calculateCompletionRate(selectedHabit) }}<span> %</span></div>
            <div class="stat-label">{{ t('habitTracker.completionRate') }}</div>
          </div>
        </div>
      </div>
        
        <!-- ç´¯è®¡æ‰“å¡æ•°ç»Ÿè®¡ -->
        <div class="cumulative-stats">
          <div class="stat-row">
            <div class="stat-item">
              <div class="stat-label">ç´¯è®¡æ‰“å¡</div>
              <div class="stat-value">{{ selectedHabit.totalCompletions }}<span> æ¬¡</span></div>
              <div class="monthly-progress-chart">
                <div class="chart-bar" v-for="monthData in getMonthlyProgressData(selectedHabit)" :key="monthData.month">
                  <div class="bar-fill" :style="{ height: monthData.percentage + '%' }"></div>
                </div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-label">æœ€é•¿è¿ç»­åšæŒ</div>
              <div class="stat-value">{{ selectedHabitLongestStreak.streak }}<span> å¤©</span></div>
              <div class="stat-timeline" v-if="selectedHabitLongestStreak.startDate && selectedHabitLongestStreak.endDate">
                <div class="stat-timeline-start">{{ formatTimelineDate(selectedHabitLongestStreak.startDate) }}</div>
                <div class="stat-timeline-end">{{ formatTimelineDate(selectedHabitLongestStreak.endDate) }}</div>
              </div>
            </div>
          </div>
          <div class="stat-row">
            <div class="stat-item">
              <div class="stat-label">æ€»å®Œæˆç‡</div>
              <div class="stat-value">{{ calculateTotalCompletionRate(selectedHabit) }}<span> %</span></div>
              <div class="progress-bar">
                <div class="progress-fill" :style="{ width: calculateTotalCompletionRate(selectedHabit) + '%' }"></div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-label">æœ€å¸¸æ‰“å¡æ—¶åˆ»</div>
              <div class="stat-value" v-html="calculateCommonTimeSlot(selectedHabit)"></div>
              <!-- å°æ—¶åˆ†å¸ƒæ¡å½¢å›¾ -->
              <div class="hour-distribution-chart">
                <div class="chart-container">
                  <div 
                    v-for="hourData in getHourDistribution(selectedHabit)" 
                    :key="hourData.hour"
                    class="hour-bar"
                    :style="{ height: calculateBarHeight(hourData.count) + '%' }"
                    :title="`${hourData.hour}ç‚¹: ${hourData.count}æ¬¡`"
                  >
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
        
        
        <div class="stats-actions">
          <SyButton @click="togglePauseHabit(selectedHabit)" class="pause-button" :icon="selectedHabit.isPaused ? 'iconPlay' : 'iconPause'">
            {{ selectedHabit.isPaused ? 'æ¢å¤æ‰“å¡' : 'æš‚åœæ‰“å¡' }}
          </SyButton>
          <SyButton @click="deleteHabit(selectedHabit.id)" class="confirm-button" icon="iconTrashcan">
            {{ t('habitTracker.delete') }}
          </SyButton>
        </div>
      </div>
    </div>
    
    <!-- æ€»ç»Ÿè®¡é¢æ¿ -->
    <div v-if="showTotalStatsPage" class="total-stats-panel">
      <div class="stats-header">
        <div class="stats-header-content">
          <div class="stats-title">ç»Ÿè®¡æ€»è§ˆ</div>
          <button @click="showTotalStatsPage = false" class="icon-button">
            <svg class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M39.156558 39.219619a133.725281 133.725281 0 0 1 189.221272 0L984.594293 795.703532a133.725281 133.725281 0 0 1-189.221272 189.087547L39.156558 228.307166a133.725281 133.725281 0 0 1 0-189.087547z m0 756.483913L795.373021 39.219619a133.725281 133.725281 0 0 1 189.221272 189.087547L228.37783 984.791079a133.792143 133.792143 0 1 1-189.221272-189.288135z" ></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">{{ totalHabitsCount }}</div>
          <div class="stat-label">æ€»ä¹ æƒ¯æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ totalCompletionsCount }}</div>
          <div class="stat-label">æ€»å®Œæˆæ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ longestStreak }}</div>
          <div class="stat-label">æœ€é•¿è¿ç»­</div>
        </div>
      </div>
      
      <!-- çƒ­åŠ›å›¾åŒºåŸŸ -->
      <div class="heatmap-section">
        <div class="heatmap-header">
          <h3 class="heatmap-title">æ‰“å¡çƒ­åŠ›å›¾</h3>
          <div class="heatmap-legend">
            <span>æ— </span>
            <div class="legend-colors">
              <div class="legend-color intensity-0"></div>
              <div class="legend-color intensity-1"></div>
              <div class="legend-color intensity-2"></div>
              <div class="legend-color intensity-3"></div>
              <div class="legend-color intensity-4"></div>
            </div>
            <span>å¤š</span>
          </div>
        </div>
        <div class="heatmap-container">
          <div class="heatmap-grid">
            <div class="heatmap-weekdays">
              <div class="heatmap-weekday">ä¸€</div>
              <div class="heatmap-weekday">äºŒ</div>
              <div class="heatmap-weekday">ä¸‰</div>
              <div class="heatmap-weekday">å››</div>
              <div class="heatmap-weekday">äº”</div>
              <div class="heatmap-weekday">å…­</div>
              <div class="heatmap-weekday">æ—¥</div>
            </div>
            <div class="heatmap-days-container">
              <template v-for="(week, weekIndex) in heatmapGridData.weeks" :key="weekIndex">
                <div class="heatmap-week-row">
                  <template v-for="(day, dayIndex) in week" :key="dayIndex">
                    <div 
                      class="heatmap-day" 
                      :class="`intensity-${day.intensity}`"
                      :title="`${day.date}: ${day.count}æ¬¡æ‰“å¡`"
                    ></div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </div>
        <div class="heatmap-months">
          <div v-for="month in heatmapMonths" :key="month.monthLabel" class="heatmap-month-label" :style="{ 'left': month.offset + '%' }">
            {{ month.monthLabel }}
          </div>
        </div>
      </div>
      <!-- æ¯ä¸ªä¹ æƒ¯çš„ç»Ÿè®¡åˆ—è¡¨ -->
      <div class="habits-stats-list">
        <div class="habit-stat-item" v-for="habit in habits" :key="habit.id">
          <div class="habit-stat-content">
            <div class="habit-stat-header">
              <div class="habit-emoji-large">{{ habit.emoji || 'ğŸ“' }}</div>
              <span class="habit-name">{{ habit.name }}</span>
              <span class="habit-created">{{ getCreatedDateText(habit) }}</span>
            </div>
            <div class="habit-stat-details">
              <div class="stat-detail-item">
                <span class="stat-value">{{ habit.totalCompletions || habit.calendar.filter(record => record.completed).length }}<span> æ¬¡</span></span>
                <span class="stat-label">ç´¯è®¡æ‰“å¡</span>
              </div>
              <div class="stat-detail-item">
                <span class="stat-value">{{ calculateLongestStreak(habit).streak }}<span> å¤©</span></span>
                <span class="stat-label">æœ€é•¿è¿ç»­</span>
              </div>
              <div class="stat-detail-item">
                <span class="stat-value">{{ calculateTotalCompletionRate(habit) }}<span> %</span></span>
                <span class="stat-label">æ€»å®Œæˆç‡</span>
              </div>
              <div class="stat-detail-item">
                <span class="stat-value" v-html="calculateCommonTimeSlot(habit)"></span>
                <span class="stat-label">æ‰“å¡æ—¶åˆ»</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç¼–è¾‘ä¹ æƒ¯æ¨¡æ€æ¡† -->
    <div v-show="showEditHabitModal" class="modal-overlay" @click.self="closeEditHabitModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>ç¼–è¾‘ä¹ æƒ¯</h3>
          <button @click="closeEditHabitModal" class="icon-button">
            <svg class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M39.156558 39.219619a133.725281 133.725281 0 0 1 189.221272 0L984.594293 795.703532a133.725281 133.725281 0 0 1-189.221272 189.087547L39.156558 228.307166a133.725281 133.725281 0 0 1 0-189.087547z m0 756.483913L795.373021 39.219619a133.725281 133.725281 0 0 1 189.221272 189.087547L228.37783 984.791079a133.792143 133.792143 0 1 1-189.221272-189.288135z" :fill="`var(--b3-theme-on-background)`"></path>
            </svg>
          </button>
        </div>
        <div class="modal-body" v-if="editedHabit">
          <div class="form-group">
            <label>ä¹ æƒ¯åç§°</label>
            <SyInput v-model="editedHabit.name" placeholder="è¾“å…¥ä¹ æƒ¯åç§°" />
          </div>
          <div class="form-group">
            <label>é€‰æ‹©å›¾æ ‡</label>
            <div class="emoji-selector">
              <SyInput v-model="editedHabit.emoji" placeholder="é€‰æ‹©æˆ–è¾“å…¥emoji" />
              <SyButton 
                @click="showEmojiPicker = !showEmojiPicker" 
                type="default" 
                size="small" 
                class="emoji-picker-btn">
                {{ editedHabit.emoji || 'ğŸ“' }}
              </SyButton>
              <div class="emoji-picker" v-if="showEmojiPicker">
                <div class="emoji-categories">
                  <div 
                    v-for="(emojis, category) in emojiCategories" 
                    :key="category" 
                    class="emoji-category"
                    :id="'emoji-category-' + category.toLowerCase().replace(/\s+/g, '-')">
                    <h4>{{ category }}</h4>
                    <div class="emoji-options-grid">
                      <div class="emoji-option" v-for="emoji in emojis" :key="emoji" @click="selectEmojiForEdit(emoji)">
                        {{ emoji }}
                      </div>
                    </div>
                  </div>
                </div>
                <!-- åº•éƒ¨å¯¼èˆªèœå• -->
                <div class="emoji-nav">
                  <div 
                    v-for="(_, category) in emojiCategories" 
                    :key="category" 
                    class="emoji-nav-item"
                    @click="scrollToCategory('emoji-category-' + category.toLowerCase().replace(/\s+/g, '-'))">
                    {{ getFixedEmojiForCategory(category) }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>{{ t('habitTracker.frequency') }}</label>
            <SySelect v-model="editedHabit.frequency" :options="frequencyOptions" />
          </div>
          <div class="form-group">
            <label>{{ t('habitTracker.timesPerDay') }}</label>
            <SySelect :modelValue="editedHabit.timesPerDay?.toString()" @update:modelValue="onTimesPerDayChange" :options="timesPerDayOptions" />
          </div>
          
          <div class="form-group">
            <label>
              <input 
                type="checkbox" 
                v-model="editedHabit.usePomodoro" 
                class="pomodoro-checkbox"
              >
              å¯ç”¨ç•ªèŒ„é’ŸåŠŸèƒ½
            </label>
          </div>
          
          <div class="form-group" v-if="editedHabit.usePomodoro">
            <label>ç•ªèŒ„é’Ÿæ—¶é•¿</label>
            <SySelect 
              :modelValue="editedHabit.pomodoroDuration?.toString()" 
              @update:modelValue="(value) => { if (editedHabit) editedHabit.pomodoroDuration = parseInt(value) || 25 }"
              :options="pomodoroDurationOptions" 
            />
          </div>
        </div>
        <div class="modal-footer">
          <SyButton @click="saveEditedHabit" class="confirm-button">ä¿å­˜</SyButton>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ ä¹ æƒ¯æ¨¡æ€æ¡† -->
    <div v-show="showAddHabitModal" class="modal-overlay" @click.self="showAddHabitModal = false">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>{{ t('habitTracker.addHabit') }}</h3>
          <button @click="showAddHabitModal = false" class="icon-button">
                      <svg class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                        <path d="M39.156558 39.219619a133.725281 133.725281 0 0 1 189.221272 0L984.594293 795.703532a133.725281 133.725281 0 0 1-189.221272 189.087547L39.156558 228.307166a133.725281 133.725281 0 0 1 0-189.087547z m0 756.483913L795.373021 39.219619a133.725281 133.725281 0 0 1 189.221272 189.087547L228.37783 984.791079a133.792143 133.792143 0 1 1-189.221272-189.288135z" :fill="`var(--b3-theme-on-background)`" p-id="23336"></path>
                      </svg>
                    </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>{{ t('habitTracker.habitName') }}</label>
            <SyInput v-model="newHabit.name" :placeholder="t('habitTracker.habitNamePlaceholder')" />
          </div>
          <div class="form-group">
            <label>é€‰æ‹©å›¾æ ‡</label>
            <div class="emoji-selector">
              <SyInput v-model="newHabit.emoji" placeholder="é€‰æ‹©æˆ–è¾“å…¥emoji" />
              <SyButton 
                @click="showEmojiPicker = !showEmojiPicker" 
                type="default" 
                size="small" 
                class="emoji-picker-btn">
                ğŸ“
              </SyButton>
              <div class="emoji-picker" v-if="showEmojiPicker">
                <div class="emoji-categories">
                  <div 
                    v-for="(emojis, category) in emojiCategories" 
                    :key="category" 
                    class="emoji-category"
                    :id="'emoji-category-' + category.toLowerCase().replace(/\s+/g, '-')">

                    <h4>{{ category }}</h4>
                    <div class="emoji-options-grid">
                      <div class="emoji-option" v-for="emoji in emojis" :key="emoji" @click="selectEmoji(emoji)">
                        {{ emoji }}
                      </div>
                    </div>
                  </div>
                </div>
                <!-- åº•éƒ¨å¯¼èˆªèœå• -->
                <div class="emoji-nav">
                  <div 
                    v-for="(_, category) in emojiCategories" 
                    :key="category" 
                    class="emoji-nav-item"
                    @click="scrollToCategory('emoji-category-' + category.toLowerCase().replace(/\s+/g, '-'))">
                    {{ getFixedEmojiForCategory(category) }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>{{ t('habitTracker.frequency') }}</label>
            <SySelect v-model="newHabit.frequency" :options="frequencyOptions" />
          </div>
          <div class="form-group">
            <label>{{ t('habitTracker.timesPerDay') }}</label>
            <SySelect v-model="newHabit.timesPerDay" :options="timesPerDayOptions" />
          </div>
          
          <div class="form-group">
            <label>
              <input 
                type="checkbox" 
                v-model="newHabit.usePomodoro" 
                class="pomodoro-checkbox"
              >
              å¯ç”¨ç•ªèŒ„é’ŸåŠŸèƒ½
            </label>
          </div>
          
          <div class="form-group" v-if="newHabit.usePomodoro">
            <label>ç•ªèŒ„é’Ÿæ—¶é•¿</label>
            <SySelect 
              :modelValue="newHabit.pomodoroDuration" 
              @update:modelValue="(value) => newHabit.pomodoroDuration = value"
              :options="pomodoroDurationOptions" 
            />
          </div>
        </div>
        <div class="modal-footer">
          <SyButton @click="addHabit" class="confirm-button">{{ t('OK') }}</SyButton>
        </div>
      </div>
    </div>
    
    <!-- æƒ…ç»ªæ‰“å¡æ¨¡æ€æ¡† -->
    <div v-show="showMoodTracker" class="modal-overlay" @click.self="closeMoodTracker">
      <div class="modal-content" @click.stop style="width: 350px;">
        <div class="modal-header">
          <h3>å¿ƒæƒ…æ‰“å¡ - {{ selectedDate }}</h3>
          <button @click="closeMoodTracker" class="icon-button">
            <svg class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M39.156558 39.219619a133.725281 133.725281 0 0 1 189.221272 0L984.594293 795.703532a133.725281 133.725281 0 0 1-189.221272 189.087547L39.156558 228.307166a133.725281 133.725281 0 0 1 0-189.087547z m0 756.483913L795.373021 39.219619a133.725281 133.725281 0 0 1 189.221272 189.087547L228.37783 984.791079a133.792143 133.792143 0 1 1-189.221272-189.288135z" :fill="`var(--b3-theme-on-background)`"></path>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>é€‰æ‹©å¿ƒæƒ…</label>
            <div class="emoji-selector">
              <div class="mood-emoji-grid">
                <span 
                  v-for="emoji in moodEmojis" 
                  :key="emoji.id"
                  class="mood-emoji-option"
                  @click="selectMoodEmoji(emoji.emoji)"
                  :class="{ selected: moodEntry.emoji === emoji.emoji }">
                  <div v-html="getLargeMoodSvg(emoji.emoji)" class="mood-svg"></div>
                </span>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>ä»Šæ—¥å¿ƒæƒ…</label>
            <SyTextarea v-model="moodEntry.note" placeholder="è®°å½•ä»Šå¤©çš„å¿ƒæƒ…æˆ–äº‹ä»¶..." class="mood-input" />
          </div>
        </div>
        <div class="modal-footer">
          <SyButton @click="deleteMoodEntry" class="danger-button" v-if="moodEntry.emoji || moodEntry.note">åˆ é™¤</SyButton>
          <SyButton @click="saveMoodEntry" class="confirm-button">ä¿å­˜</SyButton>
        </div>
      </div>
    </div>
    
    <!-- æƒ…ç»ªæ‰“å¡æœˆè§†å›¾æ¨¡æ€æ¡† -->
    <div v-if="showMoodCalendar" class="mood-calendar-panel">
      <div class="stats-header">
        <div class="stats-header-content">
          <div class="stats-title">å¿ƒæƒ…æ‰“å¡æœˆè§†å›¾</div>
          <button @click="showMoodCalendar = false" class="icon-button">
            <svg class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
              <path d="M39.156558 39.219619a133.725281 133.725281 0 0 1 189.221272 0L984.594293 795.703532a133.725281 133.725281 0 0 1-189.221272 189.087547L39.156558 228.307166a133.725281 133.725281 0 0 1 0-189.087547z m0 756.483913L795.373021 39.219619a133.725281 133.725281 0 0 1 189.221272 189.087547L228.37783 984.791079a133.792143 133.792143 0 1 1-189.221272-189.288135z" ></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="stats-content">
                  <!-- æƒ…ç»ªç»Ÿè®¡æŸ±çŠ¶å›¾ -->
          <div class="mood-stats-container">
            <div class="mood-stats-chart">
              <div class="mood-stat-item" v-for="item in moodStatsData.data" :key="item.type">
                <div class="mood-stat-bar-container">
                  <div 
                    class="mood-stat-bar" 
                    :class="`mood-stat-bar-${item.type}`"
                    :style="{ height: (item.count / moodStatsData.maxValue * 100) + '%' }"
                  ></div>
                </div>
                <div class="mood-stat-count">{{ item.count }}</div>
                <div class="mood-stat-emoji" v-html="getLargeMoodSvg(item.emoji)"></div>
              </div>
            </div>
          </div>
          <div class="calendar-container">
          <div class="calendar-controls">
            <div class="calendar-navigation">
              <button @click="changeMoodCalendarMonth(-1)" class="nav-btn">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                  <path d="M747.245 81.064c-28.497-29.315-74.739-29.315-103.307 0l-367.236 378.011c-28.483 29.367-28.483 76.982 0 106.291l367.236 377.997c28.562 29.367 74.806 29.367 103.307 0 28.546-29.325 28.546-76.929 0-106.304l-315.6-324.841 315.599-324.803c28.545-29.367 28.544-76.973 0-106.356l0 0z" :fill="`var(--b3-theme-on-background)`"></path>
                </svg>
              </button>
              <span class="current-period">{{ moodCalendarMonthYear }}</span>
              <button @click="changeMoodCalendarMonth(1)" class="nav-btn">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                  <path d="M276.755 942.936c28.497 29.315 74.739 29.315 103.307 0l367.236-378.011c28.483-29.367 28.483-76.982 0-106.291l-367.236-377.997c-28.562-29.367-74.806-29.367-103.307 0-28.546 29.325-28.546 76.929 0 106.304l315.6 324.841-315.599 324.803c-28.545 29.367-28.544 76.973 0 106.356l0 0z" :fill="`var(--b3-theme-on-background)`"></path>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="calendar-view">
            <div class="month-view">
              <div class="weekdays-header">
                <div v-for="day in weekdaysForCalendar" :key="day" class="weekday">{{ day }}</div>
              </div>
              <div class="month-grid">
                <div 
                  v-for="day in moodCalendarData" 
                  :key="day.date" 
                  :class="['day', { 
                    'completed': day.mood, 
                    'today': day.isToday, 
                    'not-current-month': !day.isCurrentMonth 
                  }]"
                  @click="openMoodTracker(day.date)"
                >
                    <div v-if="day.mood" class="mood-emoji-large" v-html="getLargeMoodSvg(day.mood.emoji)"></div>
                  <span v-else class="day-number">{{ day.date.split('-')[2] }}</span>
                </div>
              </div>
            </div>
        
          
          </div>
          
          <!-- æœ¬æœˆæƒ…ç»ªè®°å½•åˆ—è¡¨ -->
          <div class="mood-list-container">
            <h4 class="mood-list-title">æœ¬æœˆå¿ƒæƒ…è®°å½•</h4>
            <div class="mood-list">
              <div 
                v-for="entry in currentMonthMoodEntries" 
                :key="entry.date" 
                class="mood-list-item"
              >
                <div class="mood-list-date">{{ entry.date.split('-')[2] }}</div>
                <div class="mood-list-content" @click="openMoodTracker(entry.date)">
                  <div class="mood-list-emoji" v-html="getLargeMoodSvg(entry.mood.emoji)"></div>
                  <div class="mood-list-note">{{ entry.mood.note }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.emoji-selector {
  position: relative;
  display: flex;
  align-items: center;
}

.emoji-picker-btn {
  margin-left: 8px;
  border: none;
  border-radius: 6px;
  height: 28px;
  width: 30px;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.pomodoro-checkbox {
  margin-right: 8px;
}

.pomodoro-timer {
  font-family: monospace;
  font-weight: bold;
  color: #e74c3c;
}



.pomodoro-label {
  font-size: 12px;
  color: #3498db;
}

.date-display {
  font-weight: bold;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 5px;
}

.date-display span {
  color: var(--b3-theme-on-background);
}

.emoji-picker {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 1000;
  background: white;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  overflow-y: auto;
  width: 350px;
}

.emoji-categories {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 200px;
  overflow-y: auto;
}

.emoji-category {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.emoji-category .emoji-option {
  display: inline-block;
  font-size: 20px;
  cursor: pointer;
  border-radius: 4px;
}

.emoji-category .emoji-options-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(20px, 1fr));
  gap: 4px;
}

.emoji-category h4 {
  margin: 0 0 4px 0;
  font-size: 12px;
  color: #666;
  padding: 0 4px;
}

.emoji-option:hover {
  background-color: #f0f0f0;
}

.emoji-nav {
  display: flex;
  justify-content: space-around;
  padding: 4px 0 0px 0;
  border-top: 1px solid #eee;
  margin-top: 8px;
  position: sticky;
  bottom: 0;
  background: white;
  z-index: 1001;
}

.emoji-nav-item {
  padding: 4px 8px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 16px;
  color: #666;
  text-align: center;
  flex: 1;
}

.emoji-nav-item:hover {
  background-color: #f0f0f0;
  color: #333;
}

.icon-button {
  width: 28px;
  height: 28px;
  border: none;
  background: none;
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.icon-button .icon {
  width: 16px;
  height: 16px;
  color: var(--b3-theme-background);
  fill: var(--b3-theme-background);
}


.icon-button:hover {
  background-color: var(--b3-list-hover);
  border-radius: 4px;
}

.day-checkbox-icon {
  width: 14px;
  height: 14px;
  border-radius: 4px;
  transition: all 0.2s;

}


.day-checkbox.today:not(.completed) .day-checkbox-icon,
.day-checkbox.today.completed-by-weekly-rule .day-checkbox-icon,
.day-checkbox.past.completed-by-weekly-rule .day-checkbox-icon,
.day-checkbox.future.completed-by-weekly-rule .day-checkbox-icon{
  color: oklch(68.98% 0.161 30.76 / 0.2);
}

.day-checkbox.past:not(.completed) .day-checkbox-icon {
  color: var(--b3-list-hover);
}


.day-checkbox.completed .day-checkbox-icon {
  color: #f98f7a;
}

.day-checkbox.future .day-checkbox-icon {
  color: var(--b3-list-hover);
}

.week-habit-item {
  display: flex;
  align-items: center;
  padding: 6px;
}

.confirm-button {
  background-color: #f98f7a;
  color: var(--b3-theme-background);
  font-weight: bold;
  border: none;
  border-radius: 24px;
  padding: 6px 12px;
}

.cumulative-stats {
  margin: 10px 0;
}

.stat-row {
  display: flex;
  justify-content: space-around;
  margin-bottom: 10px;
  gap:10px;
}

.cumulative-stats .stat-item {
  flex: 1;
  background-color: var(--b3-theme-background);
  border-radius: 24px;
  padding: 20px;
}

.cumulative-stats .stat-value {
  font-weight: 600;
  font-size: 24px;
  color: var(--b3-theme-on-background);
  margin-top: 4px;
  margin-bottom: 12px;
}

.cumulative-stats .stat-value span{
  font-size: 12px;
}

.cumulative-stats .stat-label {
  font-size: 12px;
  color: var(--b3-scroll-color);
}

.stat-timeline {
  display: flex;
  flex-direction: column;
  margin-top: 4px;
  position: relative;
  margin-left: 8px;
}

.stat-timeline::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 0;
  bottom: 0;
  width: 2px;
  background: #decdfa;
  transform: translate(-50%, -50%);
  height: 10px;
  z-index: 1;
}

.stat-timeline .stat-timeline-start {
  color: var(--b3-theme-on-surface);
  position: relative;
  z-index: 2;
  padding: 2px 8px;
}

.stat-timeline .stat-timeline-start::before {
  content: '';
  position: absolute;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #decdfa;
  top: 50%;
  left: 0px;
  transform: translate(-50%, -50%);
  z-index: 3;
}

.stat-timeline .stat-timeline-end {
  color: var(--b3-theme-on-surface);
  position: relative;
  z-index: 2;
  padding: 2px 8px;
}

.stat-timeline .stat-timeline-end::before {
  content: '';
  position: absolute;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #decdfa;
  top: 50%;
  left: 0px;
  transform: translate(-50%, -50%);
  z-index: 3;
}

.monthly-progress-chart {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  height: 30px;
  margin-top: 24px;
  gap: 4px;
  .chart-bar {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    height: 100%;
    min-width: 1px;
    border-radius: 3px;
    position: relative;
    background-color: var(--b3-list-hover);
    
    .bar-fill {
      width: 100%;
      background: #f98f7a;
      border-radius: 3px;
      transition: height 0.3s ease;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }
  }
}
.progress-bar {
  width: 100%;
  height: 24px;
  background-color: var(--b3-list-hover);
  border-radius: 8px;
  overflow: hidden;
  margin-top: 18px;
  box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(to right, #fcd07d, #ffcb4c);
  border-radius: 8px;
  transition: width 0.3s ease;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.chart-title {
  font-size: 14px;
  font-weight: bold;
  color: var(--b3-theme-on-background);
}

.chart-container {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  height: 30px;
  border-radius: 4px;
  background-color: var(--b3-list-background);
}

.hour-bar {
  flex: 1;
  margin: 0 1px;
  background: linear-gradient(to top, #7ba6d3, #7ba6d3);
  min-width: 2px;
  min-height: 15%;
  border-radius: 10px;
  position: relative;
  transition: background 0.3s;
}

.hour-bar:hover {
  background-color: var(--b3-theme-primary-lighter);
}





.confirm-button:hover {
  background-color: #e55a47;
}

.confirm-button:active {
  background-color: #dc4a33;
}

.danger-button {
  background-color: #e74c3c;
  color: var(--b3-theme-background);
  font-weight: bold;
  border: none;
  padding: 8px 16px;
  border-radius: 24px;
  cursor: pointer;
  transition: background-color 0.2s;
  min-width: auto;
  font-size: 14px;
}

.danger-button:hover {
  background-color: #c0392b;
}

.danger-button:active {
  background-color: #a93226;
}

.pause-button {
  background-color: #fdd07d;
  border: none;
  color: var(--b3-theme-background);
  padding: 8px 16px;
  border-radius: 24px;
  cursor: pointer;
  transition: background-color 0.2s;
  min-width: auto;
  font-size: 14px;
  font-weight: bold;

}

.pause-button:hover {
  background-color: #ffcb4c;
}

.pause-button:active {
  background-color: #ffcb4c;
}

.emoji-section {
  text-align: center;
  font-size: 36px;
  width: 50px;
  height: 50px;
  border-radius: 10px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.habit-info {
  flex: 1;
  margin: 0 6px;
}

.habit-title {
  font-weight: bold;
  margin-bottom: 6px;
  margin-left: 2px;
  span{
    font-weight: 500;
    font-size: 12px;
    color: var(--b3-theme-on-surface);
    background-color: var(--b3-list-hover);
    padding: 2px 6px;
    border-radius: 6px;
  }
}

.week-checkboxes {
  display: flex;
}

.day-checkbox {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  padding: 2px;
  transition: background-color 0.2s;
}

.day-checkbox-input {
  margin: 0 0 4px 0;
}

.day-label {
  font-size: 12px;
}

.check-in-btn {
  background-color: var(--b3-list-hover);
  border-radius: 8px;
  border: none;
  padding: 0;
  min-width: auto;
  width: 26px;
  height: 26px;
  margin-right: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.check-in-btn .icon {
  width: 12px;
  height: 12px;
  color: var(--b3-theme-background);
  transition: color 0.3s, fill 0.3s;
}

.check-in-btn[type="success"] {
  background-color: #f98f7a;
}

.rays-container {
  position: absolute;
  top: 50%;
  left: 10px;
  width: 24px;
  height: 24px;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.ray {
  position: absolute;
  top: 0;
  left: 50%;
  width: 4px;
  height: 12px;
  background: #f98f7a;
  border-radius: 4px;
  transform-origin: bottom center;
  opacity: 0;
  animation: rayAnimation 0.4s ease-out forwards;
}

.ray:nth-child(1) { --rotation: 0deg; transform: rotate(0deg) translateY(-10px); }
.ray:nth-child(2) { --rotation: 30deg; transform: rotate(30deg) translateY(-10px); }
.ray:nth-child(3) { --rotation: 60deg; transform: rotate(60deg) translateY(-10px); }
.ray:nth-child(4) { --rotation: 90deg; transform: rotate(90deg) translateY(-10px); }
.ray:nth-child(5) { --rotation: 120deg; transform: rotate(120deg) translateY(-10px); }
.ray:nth-child(6) { --rotation: 150deg; transform: rotate(150deg) translateY(-10px); }
.ray:nth-child(7) { --rotation: 180deg; transform: rotate(180deg) translateY(-10px); }
.ray:nth-child(8) { --rotation: 210deg; transform: rotate(210deg) translateY(-10px); }
.ray:nth-child(9) { --rotation: 240deg; transform: rotate(240deg) translateY(-10px); }
.ray:nth-child(10) { --rotation: 270deg; transform: rotate(270deg) translateY(-10px); }
.ray:nth-child(11) { --rotation: 300deg; transform: rotate(300deg) translateY(-10px); }
.ray:nth-child(12) { --rotation: 330deg; transform: rotate(330deg) translateY(-10px); }

@keyframes rayAnimation {
  0% {
    opacity: 1;
    transform: rotate(var(--rotation)) translateY(-10px) scale(0.2);
  }
  50% {
    opacity: 1;
  }
  100% {
    opacity: 0;
    transform: rotate(var(--rotation)) translateY(-20px) scale(1);
  }
}

.progress-pie__progress {
  transition: d 0.3s ease-in-out;
}

.progress-pie__text {
  font-weight: bold;
  fill: var(--b3-theme-background);
  text-anchor: middle;
  dominant-baseline: middle;
  font-size: 16px;
}

.week-dates {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  margin: 8px 0;
}

.week-date-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 38px;
  padding: 10px 6px;
  border-radius: 14px;
  background-color: var(--b3-theme-background);
  box-shadow: rgba(0, 0, 0, 0.03) 0px 1px 5px 0px;
  overflow: hidden;
  position: relative;
}

.week-date-item.today {
  position: relative;
}
.week-date-item.today .weekday-name {
  color: #f98f7a;
}
.week-date .weekday-name {
  font-size: 10px;
  color: var(--b3-scroll-color);
  margin-bottom: 4px;
}

.mood-emoji {
  font-size: 16px;
  margin-bottom: 4px;
}

.weekday-name {
  font-size: 10px;
  position: relative;
}

.weekday-name::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 0;
  right: 0;
  height: 1px;
  background-color: var(--b3-border-color);
}


.week-date-item .mood-emoji {
  position: absolute;
  bottom: -12px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 0;
  opacity: 0.7;
}


.week-date-number {
  font-size: 14px;
  font-weight: 600;
  z-index: 1;
  margin-top: 15px;
}

.day-progress-container {
  position: absolute;
  bottom: 2px;
  left: 0;
  right: 0;
  padding: 0 4px;
}

.day-progress-bar {
  width: 80%;
  height: 4px;
  background-color: var(--b3-list-hover);
  border-radius: 2px;
  overflow: hidden;
  margin: 0 auto;
}

.day-progress-fill {
  height: 100%;
  background-color: #f98f7a;
  transition: width 0.3s ease;
}

.mood-emoji-option {
  display: inline-block;
  font-size: 20px;
  padding: 4px;
  cursor: pointer;
  border-radius: 8px;
  margin: 2px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mood-emoji-option.selected {
  background-color: var(--b3-list-hover);
  box-shadow: 0 0 0 2px #f98f7a;
}

.mood-emoji-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
}

.mood-input {
  height: 80px;
  min-height: 60px;
  resize: vertical;
  width: 100%;
  box-sizing: border-box;
  padding: 8px;
  border: 1px solid var(--b3-border-color);
  border-radius: 4px;
  font-family: inherit;
  font-size: 14px;
  line-height: 1.4;
}

.mood-svg {
  width: 40px;
  height: 40px;
}

.mood-svg svg {
  width: 100%;
  height: 100%;
}

.mood-svg-small {
  width: 50px;
  height: 50px;
}

.mood-svg-small svg {
  width: 100%;
  height: 100%;
}

</style>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, computed, shallowRef } from 'vue';
import SyButton from '@/components/SiyuanTheme/SyButton.vue';
import SyInput from '@/components/SiyuanTheme/SyInput.vue';
import SySelect from '@/components/SiyuanTheme/SySelect.vue';
import SyTextarea from '@/components/SiyuanTheme/SyTextarea.vue';
import { getHabits, saveHabits, Habit, getEmojiConf, getMoodData, saveMoodData, MoodData } from '@/api';

// æ—¥æœŸæ ¼å¼åŒ–ç¼“å­˜ - é¿å…é‡å¤åˆ›å»º Date å¯¹è±¡å’Œå­—ç¬¦ä¸²
const dateCache = new Map<number, string>();
const getCachedDate = (date: Date): string => {
  const key = date.getTime();
  if (!dateCache.has(key)) {
    const formatted = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    dateCache.set(key, formatted);
    // é™åˆ¶ç¼“å­˜å¤§å°ï¼Œé¿å…å†…å­˜æ³„æ¼
    if (dateCache.size > 1000) {
      const firstKey = dateCache.keys().next().value;
      dateCache.delete(firstKey);
    }
  }
  return dateCache.get(key)!;
};

// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD æ ¼å¼ï¼ˆä½¿ç”¨ç¼“å­˜ä¼˜åŒ–æ€§èƒ½ï¼‰
const formatDate = getCachedDate;

const formatTimelineDate = (date: Date | null): string => {
  if (!date) return '';
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆæ—¥æœŸ
  if (isNaN(date.getTime())) {
    return '';
  }
  
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  
  return `${year}.${month}.${day}`;
};


// é€šç”¨æ‰“å¡çŠ¶æ€åˆ‡æ¢å‡½æ•°
const toggleHabitCompletion = (habit: Habit, date: string) => {
  let dayRecord = habit.calendar.find(day => day.date === date);
  
  // å¦‚æœæŒ‡å®šæ—¥æœŸçš„è®°å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€æ¡æ–°è®°å½•
  if (!dayRecord) {
    const timesPerDay = Math.min(typeof habit.timesPerDay === 'string' ? parseInt(habit.timesPerDay) || 1 : habit.timesPerDay || 1, 20);
    dayRecord = {
      date: date,
      completed: false,
      completedCount: 0,
      targetCount: timesPerDay
    };
    habit.calendar.push(dayRecord);
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡
  const targetCount = typeof dayRecord.targetCount === 'string' ? parseInt(dayRecord.targetCount) || 1 : dayRecord.targetCount || 1;
  if (dayRecord.completed) {
    // å¦‚æœå·²å®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™é‡ç½®æ‰“å¡æ•°æ®
    dayRecord.completedCount = 0;
    dayRecord.completed = false;
    // å®ŒæˆçŠ¶æ€å˜ä¸ºæœªå®Œæˆæ—¶ï¼Œç§»é™¤æ—¶é—´æˆ³
    delete dayRecord.timestamp;
    
    // å¦‚æœå®ŒæˆçŠ¶æ€å˜ä¸ºæœªå®Œæˆï¼Œä¸”å®Œæˆæ¬¡æ•°ä¸º0ï¼Œä»æ—¥å†ä¸­ç§»é™¤è¯¥è®°å½•
    if (dayRecord.completedCount === 0) {
      habit.calendar = habit.calendar.filter(day => day.date !== date);
    }
  } else {
    // å¦‚æœå°šæœªå®Œæˆæ‰€æœ‰æ‰“å¡ä»»åŠ¡ï¼Œåˆ™å¢åŠ å®Œæˆæ¬¡æ•°
    if (dayRecord.completedCount < targetCount) {
      dayRecord.completedCount = (dayRecord.completedCount || 0) + 1;
    }
    // å½“å®Œæˆæ¬¡æ•°è¾¾åˆ°ç›®æ ‡æ¬¡æ•°æ—¶ï¼Œæ ‡è®°ä¸ºå·²å®Œæˆ
    dayRecord.completed = dayRecord.completedCount >= targetCount;
    
    // åªåœ¨æ‰“å¡å®Œæˆæ—¶æ·»åŠ æ—¶é—´æˆ³
    if (dayRecord.completed && !dayRecord.timestamp) {
      dayRecord.timestamp = Date.now();
    }
  }
  
  // æ›´æ–°å½“å¤©æ˜¯å¦å®Œæˆçš„æ ‡è®°
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const now = new Date();
  const todayStr = formatDate(now);
  habit.completedToday = date === todayStr && dayRecord.completed;
  
  // æ›´æ–°æ€»å®Œæˆæ¬¡æ•°å’Œè¿ç»­æ‰“å¡å¤©æ•°
  habit.totalCompletions = habit.calendar.filter(day => day.completed).length;
  habit.currentStreak = calculateCurrentStreak(habit);
};

// ç»Ÿä¸€çš„æ›´æ–°ä¹ æƒ¯ç»Ÿè®¡å‡½æ•° - å‡å°‘é‡å¤ä»£ç 
const updateHabitStats = (habit: Habit) => {
  habit.totalCompletions = habit.calendar.filter(day => day.completed).length;
  habit.currentStreak = calculateCurrentStreak(habit);
};

// ç¼“å­˜å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨è®¡ç®—ç»“æœ
const streakCache = new Map<string, {result: number, timestamp: number}>();

// è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•° - å¯ç”¨äºå½“å‰è¿ç»­æˆ–æœ€é•¿è¿ç»­
const calculateCurrentStreak = (habit: Habit, startDate?: Date) => {
  // åˆ›å»ºç¼“å­˜é”®
  const cacheKey = `${habit.id}-${startDate ? startDate.getTime() : 'none'}-${Date.now() - (Date.now() % 86400000)}`; // åŒ…å«æ—¥æœŸä½†å¿½ç•¥æ—¶é—´
  
  // æ£€æŸ¥ç¼“å­˜ï¼ˆæ¯æ—¥é‡ç½®ï¼‰
  const cached = streakCache.get(cacheKey);
  if (cached && (Date.now() - cached.timestamp) < 86400000) { // ä¸€å¤©å†…æœ‰æ•ˆ
    return cached.result;
  }
  
  // å¦‚æœæä¾›äº†èµ·å§‹æ—¥æœŸï¼Œåˆ™ä»è¯¥æ—¥æœŸå¼€å§‹è®¡ç®—è¿ç»­å¤©æ•°
  let filteredCalendar = habit.calendar;
  if (startDate) {
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ¯”è¾ƒï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
    const startNormalized = new Date(startDate);
    startNormalized.setHours(0, 0, 0, 0);
    filteredCalendar = filteredCalendar.filter(record => {
      const recordDate = new Date(record.date);
      recordDate.setHours(0, 0, 0, 0);
      return recordDate >= startNormalized;
    });
  }
  
  // æŒ‰æ—¥æœŸå€’åºæ’åˆ—ï¼ˆæœ€è¿‘çš„æ—¥æœŸåœ¨å‰ï¼‰
  const sortedCalendar = filteredCalendar
    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
  
  let streak = 0;
  
  // ä»æœ€æ–°æ—¥æœŸå¼€å§‹è®¡ç®—è¿ç»­å¤©æ•°
  let expectedNextDate: Date | null = null;
  
  for (const day of sortedCalendar) {
    // å¦‚æœé‡åˆ°æœªå®Œæˆçš„è®°å½•ï¼Œåˆ™åœæ­¢è®¡ç®—
    if (!day.completed) {
      break; // é‡åˆ°æœªå®Œæˆçš„å¤©æ•°å°±åœæ­¢è®¡ç®—
    }
    
    const recordDate = new Date(day.date);
    recordDate.setHours(0, 0, 0, 0);
    
    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå®Œæˆçš„è®°å½•ï¼Œæˆ–è€…æ—¥æœŸæ˜¯è¿ç»­çš„
    if (expectedNextDate === null || recordDate.getTime() === expectedNextDate.getTime()) {
      streak++;
      // è®¡ç®—ä¸‹ä¸€ä¸ªæœŸæœ›çš„æ—¥æœŸï¼ˆå‰ä¸€å¤©ï¼‰
      expectedNextDate = new Date(recordDate);
      expectedNextDate.setDate(expectedNextDate.getDate() - 1);
    } else {
      // å¦‚æœæ—¥æœŸä¸è¿ç»­ï¼Œä¸­æ–­è®¡ç®—
      break;
    }
  }
  
  // ç¼“å­˜ç»“æœ
  streakCache.set(cacheKey, {result: streak, timestamp: Date.now()});
  
  return streak;
};

// è®¡ç®—æ¯æœˆæ‰“å¡è¿›åº¦æ•°æ®
const getMonthlyProgressData = (habit: Habit) => {
  const currentYear = new Date().getFullYear();
  
  // é¢„å…ˆè¿‡æ»¤å‡ºå½“å¹´çš„æ•°æ®ï¼Œé¿å…é‡å¤è®¡ç®—
  const yearlyData = habit.calendar.filter(record => {
    const recordDate = new Date(record.date);
    return recordDate.getFullYear() === currentYear && record.completed;
  });
  
  // åˆå§‹åŒ–12ä¸ªæœˆçš„æ•°æ®
  const monthlyData = [];
  for (let month = 0; month < 12; month++) {
    const monthEnd = new Date(currentYear, month + 1, 0); // è¯¥æœˆæœ€åä¸€å¤©
    const totalDays = monthEnd.getDate(); // è¯¥æœˆæ€»å¤©æ•°
    
    // è®¡ç®—è¯¥æœˆçš„æ‰“å¡è®°å½•æ•°ï¼Œä½¿ç”¨é¢„è¿‡æ»¤çš„æ•°æ®
    const monthCompletions = yearlyData.filter(record => {
      const recordDate = new Date(record.date);
      return recordDate.getMonth() === month;
    }).length;
    
    const percentage = totalDays > 0 ? Math.round((monthCompletions / totalDays) * 100) : 0;
    
    monthlyData.push({
      month: `${month + 1}æœˆ`,
      completions: monthCompletions,
      totalDays: totalDays,
      percentage: percentage
    });
  }
  
  return monthlyData;
};

// è·å–ä»Šå¤©æ—¥æœŸçš„å‡½æ•°
const getToday = () => {
  const today = new Date();
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  return formatDate(today);
};

// æ£€æŸ¥æ˜¯å¦ä¸ºä»Šå¤©
const isToday = (dateString: string) => {
  return dateString === getToday();
};

// const plugin = usePlugin(); // Removed unused plugin variable

// è¡¨æƒ…é€‰æ‹©ç›¸å…³
const showEmojiPicker = ref(false);

// ä»æ€æºç¬”è®°è·å–å†…ç½®emojié…ç½® - ä½¿ç”¨ shallowRef ä¼˜åŒ–æ€§èƒ½ï¼ˆè¿™äº›æ•°æ®ä¸éœ€è¦æ·±åº¦å“åº”å¼ï¼‰
const emojiCategories = shallowRef<Record<string, string[]>>({});
const commonEmojis = shallowRef<string[]>([]);
// æƒ…ç»ªæ‰“å¡ä¸“ç”¨çš„SVGå›¾æ ‡ - ä½¿ç”¨ shallowRef ä¼˜åŒ–æ€§èƒ½ï¼ˆé™æ€æ•°æ®ä¸éœ€è¦æ·±åº¦å“åº”å¼ï¼‰
const moodEmojis = shallowRef([
  { id: 'excited', emoji: 'ğŸ¤©', largeSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#FDD07D"/><circle cx="37.3" cy="32.8" r="10.9" fill="#FFFFFF"/><circle cx="63.3" cy="32.8" r="10.9" fill="#FFFFFF"/><path d="M34.5,50.5c3.4,4.8,7.8,7.4,16.2,7.4c9.9,0,14.8-5.7,15.8-7.4" stroke="#000000" stroke-width="3" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M42.9,33c0-2.1-2-5.3-5.5-5.3c-2.9,0-5.7,2.5-5.7,5.3" stroke="#000000" stroke-width="3" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M69,33c0-2.1-2-5.3-5.5-5.3c-2.9,0-5.7,2.5-5.7,5.3" stroke="#000000" stroke-width="3" fill="none" stroke-linecap="round" stroke-miterlimit="10"/></svg>', smallSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,24.9V100h100V24.9C88.6,9.8,70.4,0,50,0S11.4,9.8,0,24.9z" fill="#FDD07D"/><circle cx="43.3" cy="16.5" r="5.8" fill="#FFFFFF"/><circle cx="43.3" cy="16.5" r="4.2"/><circle cx="41.3" cy="14.5" r="1.4" fill="#FFFFFF"/><circle cx="57" cy="16.5" r="5.8" fill="#FFFFFF"/><circle cx="57" cy="16.5" r="4.2"/><circle cx="55" cy="14.5" r="1.4" fill="#FFFFFF"/><circle cx="43.3" cy="16.5" r="5.8" fill="#FFFFFF"/><circle cx="57" cy="16.5" r="5.8" fill="#FFFFFF"/><path d="M41.8,25.9c1.8,2.5,4.1,3.9,8.6,3.9c5.3,0,7.8-3,8.4-3.9" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M46.2,16.6c0-1.1-1.1-2.8-2.9-2.8c-1.5,0-3,1.3-3,2.8" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M60.1,16.6c0-1.1-1.1-2.8-2.9-2.8c-1.5,0-3,1.3-3,2.8" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round" stroke-miterlimit="10"/></svg>' },
  { id: 'happy', emoji: 'ğŸ˜Š', largeSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M78.3,100H21.7C8.2,100-2,88.7,0.3,76.5l11.5-59.9C13.7,7,22.7,0,33.2,0h34c10.6,0,19.6,7,21.4,16.6l11.2,59.9C102,88.8,91.8,100,78.3,100z" fill="#8aae97"/><circle cx="37.3" cy="32.8" r="10.9" fill="#FFFFFF"/><circle cx="37.3" cy="32.8" r="8" fill="#000000"/><circle cx="33.4" cy="29" r="2.7" fill="#FFFFFF"/><circle cx="63.3" cy="32.8" r="10.9" fill="#FFFFFF"/><circle cx="63.3" cy="32.8" r="8" fill="#000000"/><circle cx="59.4" cy="29" r="2.7" fill="#FFFFFF"/><path d="M39.2,52.7c2.4,3.4,5.6,5.3,11.6,5.3c7.1,0,10.6-4.1,11.3-5.3" stroke="#000000" stroke-width="3" fill="none" stroke-linecap="round" stroke-miterlimit="10"/></svg>', smallSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M12.3,11.5L0,45.9V100h100V50.5L87,11.8C84.6,4.8,78,0,70.6,0H28.6C21.3,0,14.8,4.6,12.3,11.5z" fill="#8aae97"/><circle cx="43.3" cy="16.5" r="5.8" fill="#FFFFFF"/><circle cx="43.3" cy="16.5" r="4.2" fill="#000000"/><circle cx="41.2" cy="14.5" r="1.4" fill="#FFFFFF"/><circle cx="57" cy="16.5" r="5.8" fill="#FFFFFF"/><circle cx="57" cy="16.5" r="4.2" fill="#000000"/><circle cx="55" cy="14.5" r="1.4" fill="#FFFFFF"/><path d="M44.3,27c1.3,1.8,3,2.8,6.1,2.8c3.7,0,5.6-2.2,6-2.8" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round" stroke-miterlimit="10"/></svg>' },
  { id: 'calm', emoji: 'ğŸ˜Œ', largeSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M37.2,4.5L8.8,26C1.6,31.4-1.4,40.8,1.3,49.3l11.2,35.7c2.8,8.9,11,14.9,20.3,14.9h34.5c9.3,0,17.5-6,20.3-14.9l11.2-35.7c2.7-8.6-0.3-17.9-7.5-23.3L62.8,4.5C55.3-1.2,44.8-1.2,37.2,4.5z" fill="#89b0bc"/><circle cx="37.3" cy="32.8" r="10.9" fill="#FFFFFF"/><circle cx="37.3" cy="32.8" r="8" fill="#000000"/><circle cx="33.4" cy="29" r="2.7" fill="#FFFFFF"/><circle cx="63.3" cy="32.8" r="10.9" fill="#FFFFFF"/><circle cx="63.3" cy="32.8" r="8" fill="#000000"/><circle cx="59.4" cy="29" r="2.7" fill="#FFFFFF"/><line x1="41.6" y1="52.7" x2="59.9" y2="52.7" stroke="#000000" stroke-width="3" stroke-linecap="round" stroke-miterlimit="10"/></svg>', smallSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M91.6,26L62.8,4.3c-7.6-5.7-18-5.7-25.6,0L8.4,26C2.9,30.2-0.2,36.8,0,43.5h0v56.5h100.1V43.5h0C100.2,36.8,97.2,30.2,91.6,26z" fill="#89b0bc"/><circle cx="43.3" cy="16.5" r="5.8" fill="#FFFFFF"/><circle cx="43.3" cy="16.5" r="4.2" fill="#000000"/><circle cx="41.2" cy="14.5" r="1.4" fill="#FFFFFF"/><circle cx="57" cy="16.5" r="5.8" fill="#FFFFFF"/><circle cx="57" cy="16.5" r="4.2" fill="#000000"/><circle cx="55" cy="14.5" r="1.4" fill="#FFFFFF"/><line x1="45.5" y1="27" x2="55.2" y2="27" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10"/></svg>' },
  { id: 'sad', emoji: 'ğŸ˜¢', largeSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M69.6,100H30.4C13.6,100,0,86.4,0,69.6V30.4C0,13.6,13.6,0,30.4,0h39.1C86.4,0,100,13.6,100,30.4v39.1C100,86.4,86.4,100,69.6,100z" fill="#f192c9"/><circle cx="37.3" cy="32.8" r="10.9" fill="#FFFFFF"/><circle cx="37.3" cy="32.8" r="8" fill="#000000"/><circle cx="33.4" cy="29" r="2.7" fill="#FFFFFF"/><circle cx="63.3" cy="32.8" r="10.9" fill="#FFFFFF"/><circle cx="63.3" cy="32.8" r="8" fill="#000000"/><circle cx="59.4" cy="29" r="2.7" fill="#FFFFFF"/><path d="M23.6,24.9c1.4,0.1,4.2,0.5,7.5-1c4.1-2,5.5-4.4,6.7-6.8" stroke="#000000" stroke-width="3" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M76.9,24.9c-1.4,0.1-4.2,0.5-7.5-1c-4.1-2-5.5-4.4-6.7-6.8" stroke="#000000" stroke-width="3" fill="none" stroke-linecap="round" stroke-miterlimit="10"/></svg>', smallSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M69.6,100H30.5C13.7,100,0,86.4,0,69.6V30.5C0,13.7,13.7,0,30.5,0h39.1C86.4,0,100,13.7,100,30.5v39.1C100,86.4,86.4,100,69.6,100z" fill="#f192c9"/><circle cx="43.3" cy="16.5" r="5.8" fill="#FFFFFF"/><circle cx="43.3" cy="16.5" r="4.2" fill="#000000"/><circle cx="41.2" cy="14.5" r="1.4" fill="#FFFFFF"/><circle cx="57.1" cy="16.5" r="5.8" fill="#FFFFFF"/><circle cx="57.1" cy="16.5" r="4.2" fill="#000000"/><circle cx="55" cy="14.5" r="1.4" fill="#FFFFFF"/><path d="M36,12.3c0.7,0.1,2.2,0.3,4-0.5c2.2-1,2.9-2.3,3.6-3.6" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M64.3,12.3c-0.7,0.1-2.2,0.3-4-0.5c-2.2-1-2.9-2.3-3.6-3.6" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round" stroke-miterlimit="10"/></svg>' },
  { id: 'angry', emoji: 'ğŸ˜¡', largeSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M59.3,4l2.9,3.1c2.5,2.7,6,4.1,9.7,4l4.2-0.1c7.3-0.2,13.3,5.8,13.1,13.1l-0.1,4.2c-0.1,3.7,1.3,7.2,4,9.7l3.1,2.9c5.4,5,5.4,13.5,0,18.5l-3.1,2.9c-2.7,2.5-4.1,6-4,9.7l0.1,4.2c0.2,7.3-5.8,13.3-13.1,13.1l-4.2-0.1c-3.7-0.1-7.2,1.3-9.7,4L59.3,96c-5,5.4-13.5,5.4-18.5,0l-2.9-3.1c-2.5-2.7-6-4.1-9.7-4L24,89.1c-7.3,0.2-13.3-5.8-13.1-13.1l0.1-4.2c0.1-3.7-1.3-7.2-4-9.7L4,59.3c-5.4-5-5.4-13.5,0-18.5l3.1-2.9c2.7-2.5,4.1-6,4-9.7L10.9,24c-0.2-7.3,5.8-13.3,13.1-13.1l4.2,0.1c3.7,0.1,7.2-1.3,9.7-4L40.7,4C45.8-1.3,54.2-1.3,59.3,4z" fill="#fc8f7b"/><circle cx="37.3" cy="32.8" r="10.9" fill="#FFFFFF"/><circle cx="37.3" cy="32.8" r="8" fill="#000000"/><circle cx="33.4" cy="29" r="2.7" fill="#FFFFFF"/><circle cx="63.3" cy="32.8" r="10.9" fill="#FFFFFF"/><circle cx="63.3" cy="32.8" r="8" fill="#000000"/><circle cx="59.4" cy="29" r="2.7" fill="#FFFFFF"/><path d="M34.1,17.7c0.5,1,1.7,2.6,4.3,4.1c3.2,1.9,4.9,2.3,7.7,2.4" stroke="#000000" stroke-width="3" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M61.5,56.2c-0.7-1.2-4.2-5.3-11.3-5.3c-6,0-9.2,1.9-11.6,5.3" stroke="#000000" stroke-width="3" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M66.7,17.7c-0.5,1-1.7,2.6-4.3,4.1c-3.2,1.9-4.9,2.3-7.7,2.4" stroke="#000000" stroke-width="3" fill="none" stroke-linecap="round" stroke-miterlimit="10"/></svg>', smallSvg: '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M38,7c-2.5,2.7-6,4.1-9.7,4L0,10.9V100h100V11l-28.1,0.1c-3.7,0.1-7.2-1.3-9.7-4L59.3,4c-5-5.3-13.5-5.3-18.5,0L38,7z" fill="#fc8f7b"/><circle cx="43.3" cy="16.6" r="5.8" fill="#FFFFFF"/><circle cx="43.3" cy="16.6" r="4.2" fill="#000000"/><circle cx="41.2" cy="14.6" r="1.4" fill="#FFFFFF"/><circle cx="57.1" cy="16.6" r="5.8" fill="#FFFFFF"/><circle cx="57.1" cy="16.6" r="4.2" fill="#000000"/><circle cx="55" cy="14.6" r="1.4" fill="#FFFFFF"/><path d="M41.6,8.6c0.3,0.5,0.9,1.4,2.3,2.2c1.7,1,2.6,1.2,4.1,1.3" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M56.1,29c-0.4-0.6-2.2-2.8-6-2.8c-3.2,0-4.9,1-6.1,2.8" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round" stroke-miterlimit="10"/><path d="M58.9,8.6c-0.3,0.5-0.9,1.4-2.3,2.2c-1.7,1-2.6,1.2-4.1,1.3" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round" stroke-miterlimit="10"/></svg>' }
]);

// ç»Ÿä¸€çš„SVGè·å–å‡½æ•°ï¼Œå‡å°‘é‡å¤ä»£ç 
const getMoodSvg = (emoji: string, size: 'large' | 'small' = 'large') => {
  const mood = moodEmojis.value.find(m => m.emoji === emoji);
  return mood ? (size === 'large' ? mood.largeSvg : mood.smallSvg) : '';
};

// ä¾¿æ·å‡½æ•°ï¼šè·å–å¤§å‹SVG
const getLargeMoodSvg = (emoji: string) => getMoodSvg(emoji, 'large');

// ä¾¿æ·å‡½æ•°ï¼šè·å–å°å‹SVG
const getSmallMoodSvg = (emoji: string) => getMoodSvg(emoji, 'small');
// å°†åå…­è¿›åˆ¶ä»£ç è½¬æ¢ä¸ºemojiå­—ç¬¦
const convertHexToEmoji = (hexCode: string): string => {
  try {
    // å¦‚æœå·²ç»æ˜¯emojiå­—ç¬¦ï¼Œç›´æ¥è¿”å›
    if (/[^\u0000-\u00ff]/.test(hexCode)) {
      return hexCode;
    }
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ–‡ä»¶æ‰©å±•åï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›åŸå€¼
    if (typeof hexCode === 'string' && (hexCode.includes('.') || hexCode.includes('/'))) {
      // è¿™æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œä¸æ˜¯emojiä»£ç ï¼Œç›´æ¥è¿”å›
      return hexCode;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯åå…­è¿›åˆ¶ä»£ç 
    if (typeof hexCode === 'string') {
      // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„emojiåå…­è¿›åˆ¶ä»£ç æ ¼å¼
      // é€šå¸¸emojiä»£ç ç”±åå…­è¿›åˆ¶æ•°å­—å’Œå¯èƒ½çš„è¿å­—ç¬¦ç»„æˆï¼Œå¦‚'1f600'æˆ–'1f1f7-1f1f8'
      const hexPattern = /^[0-9a-fA-F]+(-[0-9a-fA-F]+)*$/;
      if (hexPattern.test(hexCode)) {
        // ç§»é™¤å¯èƒ½çš„å‰ç¼€
        let cleanHex = hexCode.replace(/^U\+|0x|\\u/g, '').replace(/-/g, ' ');
        
        // å°†åå…­è¿›åˆ¶ä»£ç è½¬æ¢ä¸ºå­—ç¬¦
        const codePoints = cleanHex.split(' ').map(h => parseInt(h, 16));
        
        // æ£€æŸ¥codePointsæ•°ç»„æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„æ•°å€¼
        if (codePoints.some(isNaN)) {
          // å¦‚æœåŒ…å«NaNå€¼ï¼Œè¿”å›åŸå€¼
          return hexCode;
        }
        
        return String.fromCodePoint(...codePoints);
      }
    }
    
    // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„åå…­è¿›åˆ¶ä»£ç æ ¼å¼ï¼Œç›´æ¥è¿”å›åŸå€¼
    return hexCode;
  } catch (error) {
    console.warn('æ— æ³•è½¬æ¢åå…­è¿›åˆ¶ä»£ç åˆ°emoji:', hexCode, error);
    return hexCode;
  }
};

// Emoji æ£€æµ‹æ­£åˆ™è¡¨è¾¾å¼ - æå–ä¸ºå¸¸é‡é¿å…é‡å¤åˆ›å»º
const EMOJI_REGEX = /(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|\ud83c[\udde6-\uddff]|\ud83c[\udff0-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|\ud83e[\udd10-\uddff])|[^\x00-\xFF]/u;

// ä»æ€æº API çš„ emoji item ä¸­æå– emoji å­—ç¬¦ - ç»Ÿä¸€çš„æå–é€»è¾‘
const extractEmojiFromItem = (item: any): string | null => {
  if (!item) return null;

  // å¦‚æœé¡¹ç›®æœ¬èº«å°±æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
  if (typeof item === 'string') {
    return item;
  }

  // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°è¯•è·å–emojiå­—ç¬¦çš„å„ç§å¯èƒ½å±æ€§
  if (typeof item === 'object') {
    if (item.ch) return item.ch;
    if (item.emoji) return item.emoji;
    if (item.text) return item.text;
    if (item.unicode) return convertHexToEmoji(item.unicode);

    // ä½œä¸ºæœ€åçš„å°è¯•ï¼Œéå†å¯¹è±¡çš„å€¼ï¼Œå¯»æ‰¾å¯èƒ½çš„emojiå­—ç¬¦ä¸²
    const values = Object.values(item);
    for (const val of values) {
      if (typeof val === 'string' && val.length <= 5 && EMOJI_REGEX.test(val)) {
        return val;
      }
    }
  }

  return null;
};

// ä» emoji items æ•°ç»„ä¸­æå–æ‰€æœ‰ emojis
const extractEmojisFromItems = (items: any[]): string[] => {
  const emojis: string[] = [];
  for (const item of items) {
    const emoji = extractEmojiFromItem(item);
    if (emoji) {
      emojis.push(emoji);
    }
  }
  return emojis;
};

// è·å–æ€æºç¬”è®°å†…ç½®emoji
const loadSiyuanEmojis = async () => {
  try {
    const emojiConf: any = await getEmojiConf();
    if (emojiConf) {
      const categories: Record<string, string[]> = {};

      // å¤„ç†æ•°ç»„æ ¼å¼çš„ emoji é…ç½®
      if (Array.isArray(emojiConf)) {
        for (const emojiCategory of emojiConf) {
          if (emojiCategory?.items && Array.isArray(emojiCategory.items)) {
            const categoryName = emojiCategory.title_zh_cn || emojiCategory.title || emojiCategory.id;
            if (categoryName && categoryName !== 'è‡ªå®šä¹‰' && categoryName !== 'Custom') {
              categories[categoryName] = extractEmojisFromItems(emojiCategory.items);
            }
          }
        }
      } else {
        // å¤„ç†å¯¹è±¡æ ¼å¼çš„ emoji é…ç½®
        for (const category in emojiConf) {
          const categoryData = emojiConf[category];

          // ç®€å•æ•°ç»„æ ¼å¼
          if (Array.isArray(categoryData)) {
            categories[category] = categoryData.map((item: any) => item.ch);
            continue;
          }

          // å¯¹è±¡æ ¼å¼
          if (categoryData?.items && Array.isArray(categoryData.items)) {
            const categoryName = categoryData.title_zh_cn || categoryData.title || categoryData.id || category;
            if (categoryName !== 'è‡ªå®šä¹‰' && categoryName !== 'Custom') {
              categories[categoryName] = extractEmojisFromItems(categoryData.items);
            }
          } else if (categoryData?.ch) {
            categories[category] = [categoryData.ch];
          } else {
            categories[category] = Object.values(categoryData).filter(v => typeof v === 'string') as string[];
          }
        }
      }

      emojiCategories.value = categories;

      // å°†æ‰€æœ‰emojiåˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„
      const allEmojis = Object.values(categories).flat();
      commonEmojis.value = allEmojis;
    }
  } catch (error) {
    console.error('è·å–æ€æºç¬”è®°emojié…ç½®å¤±è´¥:', error);
  }
};

// ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ€æºç¬”è®°emoji
onMounted(() => {
  loadSiyuanEmojis();
});

// é€‰æ‹©emoji
const selectEmoji = (emoji: string) => {
  newHabit.value.emoji = emoji;
  showEmojiPicker.value = false;
};

// æ»šåŠ¨åˆ°æŒ‡å®šåˆ†ç±»
const scrollToCategory = (categoryId: string) => {
  // ç›´æ¥å°è¯•æ»šåŠ¨ï¼Œä¸ä½¿ç”¨ nextTickï¼Œå› ä¸ºå¯èƒ½åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­æœ‰ä¸åŒè¡¨ç°
  const element = document.getElementById(categoryId);
  
  if (element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    // å»¶æ—¶æŸ¥æ‰¾ï¼Œé€‚ç”¨äºä¸åŒä¸Šä¸‹æ–‡
    setTimeout(() => {
      const element2 = document.getElementById(categoryId);
      if (element2) {
        element2.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 100);
  }
};

// ä¸ºåˆ†ç±»è·å–å¯¹åº”çš„å›ºå®šemoji
const getFixedEmojiForCategory = (category: string): string => {
  // æ ¹æ®åˆ†ç±»åç§°è¿”å›å¯¹åº”çš„å›ºå®šemojiï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨æ­¤å¤„æ‰‹åŠ¨ä¿®æ”¹
  const emojiMap: Record<string, string> = {
    'ç¬‘è„¸å’Œäººç±»': 'ğŸ˜€',
    'åŠ¨ç‰©å’Œè‡ªç„¶': 'ğŸ·',
    'é£Ÿç‰©å’Œé¥®æ–™': 'ğŸ',
    'æ´»åŠ¨': 'âš½',
    'æ—…è¡Œå’Œåœ°ç‚¹': 'âœˆï¸',
    'ç‰©å“': 'ğŸ',
    'ç¬¦å·': 'â¤ï¸',
    'æ——å¸œ': 'ğŸš©',
    // è‹±æ–‡åˆ†ç±»
    'Smileys & People': 'ğŸ˜€',
    'Animals & Nature': 'ğŸ·',
    'Food & Drink': 'ğŸ',
    'Activity': 'âš½',
    'Travel & Places': 'âœˆï¸',
    'Objects': 'ğŸ',
    'Symbols': 'â¤ï¸',
    'Flags': 'ğŸš©',
  };
  
  return emojiMap[category] || 'â­'; // é»˜è®¤è¿”å›æ˜Ÿå·emoji
};

// å›½é™…åŒ–å‡½æ•°
const t = (key: string) => {
  // ä»æ€æºç¬”è®°è·å–è¯­è¨€èµ„æº
  const lang = window.siyuan?.languages || {};
  
  // å¦‚æœæ€æºç¬”è®°è¯­è¨€èµ„æºä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¿”å›é»˜è®¤ä¸­æ–‡æ–‡æœ¬
  const defaultLang = {
    'habitTracker.title': 'ä¹ æƒ¯æ‰“å¡',
    'habitTracker.addHabit': 'æ·»åŠ ä¹ æƒ¯',
    'habitTracker.habitName': 'ä¹ æƒ¯åç§°',
    'habitTracker.habitNamePlaceholder': 'ä¾‹å¦‚ï¼šæ™¨è·‘ã€è¯»ä¹¦ã€å–æ°´',
    'habitTracker.frequency': 'æ‰“å¡å‘¨æœŸ',
    'habitTracker.customFrequency': 'æ¯å‘¨å¤©æ•°',
    'habitTracker.customFrequencyPlaceholder': 'è¾“å…¥æ¯å‘¨è¦æ‰“å¡çš„å¤©æ•°',
    'habitTracker.timesPerDay': 'æ¯å¤©é¢‘ç‡',
    'habitTracker.timesPerDayPlaceholder': 'è¾“å…¥æ¯å¤©è¦å®Œæˆçš„æ¬¡æ•°',
    'habitTracker.reminderTime': 'æé†’æ—¶é—´',
    'habitTracker.daily': 'æ¯å¤©',
    'habitTracker.weekly': 'æ¯å‘¨6å¤©',
    'habitTracker.custom': 'è‡ªå®šä¹‰',
    'habitTracker.checkIn': 'æ‰“å¡',
    'habitTracker.checkedIn': 'å·²æ‰“å¡',
    'habitTracker.delete': 'åˆ é™¤',
    'habitTracker.currentStreak': 'è¿ç»­å¤©æ•°',
    'habitTracker.totalCompletions': 'æœ¬æœˆæ‰“å¡',
    'habitTracker.completionRate': 'æœ¬æœˆå®Œæˆç‡',
    'habitTracker.days': 'å¤©',
    'habitTracker.times': 'æ¬¡',
    'habitTracker.noHabits': 'æš‚æ— ä¹ æƒ¯ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ–°ä¹ æƒ¯',
    'habitTracker.confirmDelete': 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿ',
    'habitTracker.weekView': 'å‘¨è§†å›¾',
    'habitTracker.monthView': 'æœˆè§†å›¾',
    'Cancel': 'å–æ¶ˆ',
    'OK': 'ç¡®å®š',
  };

  return lang[key] || defaultLang[key] || key;
};

// é˜²æŠ–çš„ä¿å­˜å‡½æ•° - ä¼˜åŒ–æ€§èƒ½ï¼Œå‡å°‘é¢‘ç¹çš„å­˜å‚¨æ“ä½œ
let saveDebounceTimer: ReturnType<typeof setTimeout> | null = null;
const debouncedSaveHabits = async (habitsToSave: Habit[]) => {
  if (saveDebounceTimer) {
    clearTimeout(saveDebounceTimer);
  }
  return new Promise<void>((resolve) => {
    saveDebounceTimer = setTimeout(async () => {
      await saveHabits(habitsToSave);
      resolve();
    }, 300); // 300ms é˜²æŠ–å»¶è¿Ÿ
  });
};

// ç«‹å³ä¿å­˜å‡½æ•°ï¼ˆç”¨äºå…³é”®æ“ä½œï¼‰
const immediateSaveHabits = async (habitsToSave: Habit[]) => {
  if (saveDebounceTimer) {
    clearTimeout(saveDebounceTimer);
    saveDebounceTimer = null;
  }
  await saveHabits(habitsToSave);
};

// ä¹ æƒ¯æ•°æ®
const habits = shallowRef<Habit[]>([]);
const showAddHabitModal = ref(false);
const showTotalStatsPage = ref(false);
const showMoodCalendar = ref(false);
const showAnimation = ref(false);
const animationHabitId = ref<string | null>(null);

// å­˜å‚¨åŠ¨ç”»æœŸé—´çš„åŸå§‹å®ŒæˆçŠ¶æ€
const animationOriginalStatus = ref<Record<string, boolean>>({});

// const weekdays = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥']; // å·²æ³¨é‡Šï¼šæ­¤å˜é‡æœªè¢«ä½¿ç”¨ï¼Œä½¿ç”¨çš„æ˜¯ weekdaysForCalendar è®¡ç®—å±æ€§

// å½“å‰æ—¥æœŸè¿½è¸ªï¼ˆç”¨äºç¡®ä¿æ—¥æœŸç›¸å…³è®¡ç®—èƒ½å¤Ÿå“åº”æ—¥æœŸå˜åŒ–ï¼‰
const currentDate = ref(formatDate(new Date()));

// è®¡ç®—æœ¬å‘¨æ—¥æœŸï¼Œä»å‘¨ä¸€å¼€å§‹
const weekDates = computed(() => {
  const today = new Date();
  const dayOfWeek = today.getDay(); // 0ä¸ºå‘¨æ—¥ï¼Œ1-6ä¸ºå‘¨ä¸€åˆ°å‘¨å…­
  
  // è®¡ç®—å‘¨ä¸€çš„æ—¥æœŸï¼ˆå¦‚æœä»Šå¤©æ˜¯å‘¨æ—¥ï¼Œåˆ™éœ€è¦å‡å»6å¤©ï¼‰
  const monday = new Date(today);
  const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // å‘¨æ—¥ä¸º0ï¼Œå‘¨ä¸€ä¸º1
  monday.setDate(today.getDate() - daysToMonday);

  const dates = [];
  
  for (let i = 0; i < 7; i++) {
    const currentDate = new Date(monday);
    currentDate.setDate(monday.getDate() + i);
    
    const dateStr = `${currentDate.getDate()}`;
    const fullDateStr = formatDate(currentDate);
    const isToday = currentDate.toDateString() === today.toDateString();
    
    dates.push({
      date: dateStr,
      dayName: WEEKDAY_NAMES[i],
      isToday: isToday,
      fullDate: fullDateStr
    });
  }
  
  return dates;
});

// ç•ªèŒ„é’Ÿç›¸å…³æ•°æ®
const activePomodoroHabit = ref<Habit | null>(null);

// è®¡ç®—å±æ€§ï¼šæŒ‰å½“å¤©å®ŒæˆçŠ¶æ€å’Œå‘¨ç›®æ ‡å®ŒæˆçŠ¶æ€æ’åºçš„ä¹ æƒ¯åˆ—è¡¨ï¼ˆæœªå®Œæˆçš„åœ¨å‰ï¼‰
// ä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜å’Œé¢„è®¡ç®—å‡å°‘é‡å¤è®¡ç®—
const sortedHabits = computed(() => {
  // é¢„è®¡ç®—æ‰€æœ‰ä¹ æƒ¯çš„å®ŒæˆçŠ¶æ€ï¼Œé¿å…åœ¨æ’åºå‡½æ•°ä¸­é‡å¤è®¡ç®—
  const habitStatusCache = new Map<string, {
    isPaused: boolean;
    isCompleted: boolean;
    createdAt: number;
  }>();

  // é¢„è®¡ç®—å¹¶ç¼“å­˜æ¯ä¸ªä¹ æƒ¯çš„çŠ¶æ€
  for (const habit of habits.value) {
    const isWeekly = habit.frequency && habit.frequency.startsWith('weekly');
    const weeklyCompleted = isWeekly && getWeeklyCompletionStatus(habit);
    const animationStatus = animationOriginalStatus.value[habit.id];

    habitStatusCache.set(habit.id, {
      isPaused: habit.isPaused || false,
      isCompleted: isWeekly
        ? (animationStatus !== undefined ? animationStatus : (habit.completedToday || weeklyCompleted))
        : (animationStatus !== undefined ? animationStatus : habit.completedToday),
      createdAt: new Date(habit.createdAt).getTime()
    });
  }

  // ä½¿ç”¨ç¼“å­˜çš„çŠ¶æ€è¿›è¡Œæ’åº
  return [...habits.value].sort((a, b) => {
    const aStatus = habitStatusCache.get(a.id)!;
    const bStatus = habitStatusCache.get(b.id)!;

    // é¦–å…ˆå¤„ç†æš‚åœçŠ¶æ€ï¼šæš‚åœçš„ä¹ æƒ¯æ”¾åœ¨æœ€å
    if (aStatus.isPaused && !bStatus.isPaused) {
      return 1;
    } else if (!aStatus.isPaused && bStatus.isPaused) {
      return -1;
    }

    // æ¯”è¾ƒå®ŒæˆçŠ¶æ€ï¼šæœªå®Œæˆçš„åœ¨å‰ï¼Œå·²å®Œæˆçš„åœ¨å
    if (!aStatus.isCompleted && bStatus.isCompleted) {
      return -1;
    } else if (aStatus.isCompleted && !bStatus.isCompleted) {
      return 1;
    } else {
      // åœ¨ç›¸åŒå®ŒæˆçŠ¶æ€ä¸‹ï¼ŒæŒ‰åˆ›å»ºæ—¥æœŸå€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      return bStatus.createdAt - aStatus.createdAt;
    }
  });
});

// æ–°ä¹ æƒ¯è¡¨å•æ•°æ®
const newHabit = ref({
  name: '',
  emoji: '',
  frequency: 'daily' as 'daily' | 'weekly6' | 'weekly5' | 'weekly4' | 'weekly3' | 'weekly2' | 'weekly1',
  timesPerDay: '1', // æ¯å¤©æ¬¡æ•°
  usePomodoro: false, // æ˜¯å¦ä½¿ç”¨ç•ªèŒ„é’Ÿ
  pomodoroDuration: '25' // ç•ªèŒ„é’Ÿæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼Œé»˜è®¤25åˆ†é’Ÿ
});

// è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ•°å­—é€‰é¡¹ - å‡å°‘é‡å¤ä»£ç 
const createNumberOptions = (count: number, suffix: string) =>
  Array.from({ length: count }, (_, i) => ({
    value: String(i + 1),
    text: `${i + 1}${suffix}`
  }));

// é¢‘ç‡é€‰é¡¹ - ä½¿ç”¨è¾…åŠ©å‡½æ•°å‡å°‘é‡å¤ä»£ç 
const frequencyOptions = ref([
  { value: 'daily', text: t('habitTracker.daily') },
  ...Array.from({ length: 6 }, (_, i) => ({
    value: `weekly${6 - i}`,
    text: `æ¯å‘¨${6 - i}å¤©`
  }))
]);

// æ¯æ—¥æ‰“å¡æ¬¡æ•°é€‰é¡¹ - ä½¿ç”¨è¾…åŠ©å‡½æ•°ç”Ÿæˆï¼Œå‡å°‘é‡å¤ä»£ç 
const timesPerDayOptions = ref(createNumberOptions(20, 'æ¬¡'));

// ç•ªèŒ„é’Ÿæ—¶é—´é€‰é¡¹
const pomodoroDurationOptions = ref([
  { value: '5', text: '5åˆ†é’Ÿ' },
  { value: '10', text: '10åˆ†é’Ÿ' },
  { value: '15', text: '15åˆ†é’Ÿ' },
  { value: '25', text: '25åˆ†é’Ÿ' },
  { value: '30', text: '30åˆ†é’Ÿ' },
  { value: '45', text: '45åˆ†é’Ÿ' },
  { value: '60', text: '60åˆ†é’Ÿ' }
]);

// æ˜ŸæœŸåç§°æ•°ç»„ - æå–ä¸ºå¸¸é‡é¿å…é‡å¤
const WEEKDAY_NAMES = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

// åˆå§‹åŒ–æ•°æ®
onMounted(async () => {
  try {
    habits.value = await getHabits();
    
    // æ¯æ¬¡ç»„ä»¶æŒ‚è½½æ—¶æ›´æ–°currentDayInfoä¸ºå½“å‰æ—¥æœŸ
    const today = new Date();

    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
    const localDate = formatDate(today);
    currentDayInfo.value.date = localDate;
    currentDayInfo.value.dayOfWeek = today.getDay();
    currentDayInfo.value.dayOfMonth = today.getDate();
    currentDayInfo.value.month = today.getMonth() + 1;
    currentDayInfo.value.year = today.getFullYear();
    
    // æ›´æ–°currentDateå˜é‡
    currentDate.value = localDate;
    
    // åŠ è½½æƒ…ç»ªæ•°æ®
    moodData.value = await getMoodData();
    
    // åˆå§‹åŒ–æ¯ä¸ªä¹ æƒ¯çš„completedTodayå±æ€§
    const todayStr = localDate;
    habits.value.forEach(habit => {
      const todayRecord = habit.calendar.find(day => day.date === todayStr);
      habit.completedToday = todayRecord ? todayRecord.completed : false;
    });
    

    
  } catch (error) {
    console.error('Error initializing habits:', error);
    // åˆå§‹åŒ–å¤±è´¥æ—¶ï¼Œä½¿ç”¨ç©ºæ•°ç»„ï¼Œç¡®ä¿ç•Œé¢ä»èƒ½æ˜¾ç¤º
    habits.value = [];
  }
});

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
onUnmounted(() => {
  // æ¸…ç†ä¸»å®šæ—¶å™¨
  if ((window as any).habitTrackerTimer) {
    clearInterval((window as any).habitTrackerTimer);
    delete (window as any).habitTrackerTimer;
  }
  
  // æ¸…ç†å¤‡ç”¨å®šæ—¶å™¨
  if ((window as any).habitTrackerBackupTimer) {
    clearInterval((window as any).habitTrackerBackupTimer);
    delete (window as any).habitTrackerBackupTimer;
  }
  
  // æ¸…ç†ç•ªèŒ„é’Ÿå®šæ—¶å™¨
  for (const habitId in pomodoroTimers) {
    clearInterval(pomodoroTimers[habitId]);
    delete pomodoroTimers[habitId];
  }
});

// ç”Ÿæˆæ—¥å†æ•°æ®
const generateCalendarData = (): any[] => {
  // åªè¿”å›ç©ºæ•°ç»„ï¼Œå› ä¸ºåªè®°å½•å·²æ‰“å¡çš„æ—¥æœŸ
  // ä¹‹å‰çš„å®ç°å¯èƒ½ä¼šåˆå§‹åŒ–å…¨å¹´çš„æ—¥å†æ•°æ®ï¼Œä½†ç°åœ¨æ”¹ä¸ºåªåœ¨æ‰“å¡æ—¶åˆ›å»ºè®°å½•
  // _targetCount åœ¨åˆ›å»ºæ—¥å†è®°å½•æ—¶ä¼šå•ç‹¬å¤„ç†ï¼Œå› æ­¤æ­¤å¤„ä¸éœ€è¦ä½¿ç”¨è¯¥å‚æ•°
  return [];
};

// æ·»åŠ ä¹ æƒ¯
const addHabit = async () => {
  if (!newHabit.value.name.trim()) {
    alert('è¯·è¾“å…¥ä¹ æƒ¯åç§°');
    return;
  }
  
  // é™åˆ¶ timesPerDay æœ€å¤§å€¼ä¸º 20
  const inputTimesPerDay = parseInt(newHabit.value.timesPerDay) || 1;
  if (inputTimesPerDay > 20) {
    alert('æ¯æ—¥æ‰“å¡æ¬¡æ•°ä¸èƒ½è¶…è¿‡20æ¬¡');
    return;
  }
  
  const timesPerDay = Math.min(inputTimesPerDay, 20);
  
  const habit: Habit = {
    id: Date.now().toString(),
    name: newHabit.value.name,
    emoji: newHabit.value.emoji,
    frequency: newHabit.value.frequency,
    timesPerDay: timesPerDay,
    completedToday: false,
    currentStreak: 0,
    totalCompletions: 0,
    calendar: generateCalendarData(),
    createdAt: new Date().toISOString(),
    usePomodoro: newHabit.value.usePomodoro || false, // æ˜¯å¦ä½¿ç”¨ç•ªèŒ„é’Ÿ
    pomodoroDuration: parseInt(newHabit.value.pomodoroDuration) || 25 // ç•ªèŒ„é’Ÿæ—¶é•¿ï¼Œé»˜è®¤25åˆ†é’Ÿ
  };
  
  habits.value.push(habit);
  await saveHabits(habits.value);
  
  // é‡ç½®è¡¨å•
  newHabit.value = {
    name: '',
    emoji: '',
    frequency: 'daily',
    timesPerDay: '1',
    usePomodoro: false,
    pomodoroDuration: '25'
  };
  
  showAddHabitModal.value = false;
};

// åˆ‡æ¢å•æ—¥æ‰“å¡çŠ¶æ€ (ç›®å‰æœªç›´æ¥ä½¿ç”¨ï¼Œä¿ç•™ä¾›å°†æ¥å¯èƒ½çš„åŠŸèƒ½æ‰©å±•)
// åˆ‡æ¢å•æ—¥æ‰“å¡çŠ¶æ€
const toggleDayCompletion = async (habit: Habit, date: string) => {
  toggleHabitCompletion(habit, date);

  // ä½¿ç”¨é˜²æŠ–ä¿å­˜ä¼˜åŒ–æ€§èƒ½
  await debouncedSaveHabits(habits.value);
};

// è·å–ä¹ æƒ¯é¢‘ç‡å¯¹åº”çš„å‘¨ç›®æ ‡æ¬¡æ•°
const getWeeklyTarget = (frequency: string): number => {
  if (!frequency.startsWith('weekly')) return 1;
  
  switch (frequency) {
    case 'weekly2': return 2;
    case 'weekly3': return 3;
    case 'weekly4': return 4;
    case 'weekly5': return 5;
    case 'weekly6': return 6;
    default: return 1;
  }
};

// è·å–ä¸€å‘¨çš„å¼€å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ï¼‰
const getWeekStart = (date: Date): Date => {
  const dayOfWeek = date.getDay();
  const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨6å¤©åˆ°å‘¨ä¸€
  const weekStart = new Date(date);
  weekStart.setDate(date.getDate() + daysToMonday);
  
  // è®¾ç½®æ—¶é—´ä¸º00:00:00ä»¥ç¡®ä¿æ­£ç¡®çš„æ—¥æœŸæ¯”è¾ƒ
  weekStart.setHours(0, 0, 0, 0);
  return weekStart;
};

// æ£€æŸ¥ç»™å®šæ—¥æœŸæ˜¯å¦åœ¨åŒä¸€å‘¨å†…ï¼ˆå‘¨ä¸€ä¸ºä¸€å‘¨çš„å¼€å§‹ï¼‰
const isSameWeek = (date1: Date, date2: Date): boolean => {
  return getWeekStart(date1).getTime() === getWeekStart(date2).getTime();
};

// é€šç”¨å‡½æ•°ï¼šè®¡ç®—æŒ‡å®šå‘¨çš„æ‰“å¡å®Œæˆæƒ…å†µ
const getWeekCompletionData = (habit: Habit, startOfWeek: Date) => {
  // è®¡ç®—æœ¬å‘¨å·²å®Œæˆçš„æ‰“å¡æ¬¡æ•°
  const completedThisWeek = habit.frequency.startsWith('weekly') ? 
    habit.calendar.filter(day => {
      return day.completed && isSameWeek(new Date(day.date), startOfWeek);
    }).length : 0;
    
  // è·å–æ¯å‘¨éœ€è¦å®Œæˆçš„æ¬¡æ•°
  const requiredWeekCompletions = getWeeklyTarget(habit.frequency);
  
  // å¯¹äºweeklyNä¹ æƒ¯ï¼Œå¦‚æœæœ¬å‘¨å·²ç»å®Œæˆæ‰€éœ€çš„æ‰“å¡æ¬¡æ•°ï¼Œåˆ™æ‰€æœ‰æ—¥æœŸéƒ½æ˜¾ç¤ºä¸ºå®ŒæˆçŠ¶æ€
  const hasCompletedRequiredThisWeek = completedThisWeek >= requiredWeekCompletions;
  
  return {
    hasCompletedRequiredThisWeek,
    requiredWeekCompletions,
    completedThisWeek
  };
};

// æ£€æŸ¥å‘¨ç›®æ ‡æ˜¯å¦å·²å®Œæˆ
const getWeeklyCompletionStatus = (habit: Habit) => {
  if (!habit.frequency || !habit.frequency.startsWith('weekly')) {
    return false;
  }
  
  // åˆ›å»ºç¼“å­˜é”®
  const cacheKey = `${habit.id}-weeklyStatus-${getWeekStart(new Date()).toISOString().split('T')[0]}`; // æŒ‰å‘¨ç¼“å­˜
  
  // æ£€æŸ¥ç¼“å­˜
  const cached = weeklyCompletionCache.get(cacheKey);
  if (cached) {
    return cached.result;
  }
  
  // è·å–æ¯å‘¨éœ€è¦å®Œæˆçš„æ¬¡æ•°
  const requiredWeekCompletions = getWeeklyTarget(habit.frequency);
  
  // è·å–æœ¬å‘¨å‘¨ä¸€çš„æ—¥æœŸ
  const thisWeekStart = getWeekStart(new Date());
  
  // è®¡ç®—æœ¬å‘¨å·²å®Œæˆçš„æ‰“å¡æ¬¡æ•° - ä½¿ç”¨reduceæ›¿ä»£filter+lengthæé«˜æ€§èƒ½
  const completedThisWeek = habit.calendar.reduce((count, day) => {
    return (day.completed && isSameWeek(new Date(day.date), thisWeekStart)) ? count + 1 : count;
  }, 0);
  
  // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæœ¬å‘¨æ‰€éœ€çš„æ‰“å¡æ¬¡æ•°
  const result = completedThisWeek >= requiredWeekCompletions;
  
  // ç¼“å­˜ç»“æœ
  weeklyCompletionCache.set(cacheKey, {result, timestamp: Date.now()});
  
  return result;
};

// è·å–æŒ‡å®šæ—¥æœŸçš„æ‰“å¡å®Œæˆæ¬¡æ•°
const getCompletionCount = (habit: Habit, date: string) => {
  const dayRecord = habit.calendar.find(day => day.date === date);
  return dayRecord ? (dayRecord.completedCount || 0) : 0;
};

// åˆ‡æ¢ä¹ æƒ¯å®ŒæˆçŠ¶æ€
const getTodayCompletionCount = (habit: Habit) => {
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const today = getToday();
  return getCompletionCount(habit, today);
};

// ç•ªèŒ„é’Ÿç›¸å…³å˜é‡
let pomodoroTimers: { [key: string]: number } = {};

// å†…è”ç•ªèŒ„é’Ÿè¿›åº¦æ¡ç›¸å…³è®¡ç®—
const inlineRadius = ref(45);
const inlineCircumference = computed(() => 2 * Math.PI * inlineRadius.value);

// è®¡ç®—å†…è”è¿›åº¦æ¡åç§»é‡
const inlineStrokeDashoffset = computed(() => {
  if (!activePomodoroHabit.value || activePomodoroHabit.value.pomodoroRemaining === undefined) {
    return inlineCircumference.value;
  }
  
  // å¼ºåˆ¶ä¾èµ–pomodoroRemainingï¼Œç¡®ä¿å½“å®ƒå˜åŒ–æ—¶è®¡ç®—å±æ€§é‡æ–°è®¡ç®—
  const remainingTime = activePomodoroHabit.value.pomodoroRemaining;
  
  // è®¡ç®—è¿›åº¦æ¯”ä¾‹ï¼ˆä»0åˆ°1ï¼‰
  // å€’è®¡æ—¶å¼€å§‹æ—¶å‰©ä½™æ—¶é—´ä¸ºæœ€å¤§å€¼ï¼ˆè¿›åº¦0ï¼‰ï¼Œç»“æŸæ—¶å‰©ä½™æ—¶é—´ä¸º0ï¼ˆè¿›åº¦1ï¼‰
  const totalTime = getPomodoroTotalTime(activePomodoroHabit.value);
  const progressRatio = 1 - (remainingTime / totalTime);
  
  // è®¡ç®—stroke-dashoffsetï¼šä»å®Œæ•´å‘¨é•¿ï¼ˆæ— è¿›åº¦ï¼‰åˆ°0ï¼ˆå®Œæ•´è¿›åº¦ï¼‰
  // è¿™æ ·å€’è®¡æ—¶å¼€å§‹æ—¶è¿›åº¦æ¡ä¸ºç©ºï¼Œç»“æŸæ—¶æ˜¯æ»¡çš„
  let offset = inlineCircumference.value * (1 - progressRatio);
  
  // ç¡®ä¿åœ¨è¾¹ç•Œæƒ…å†µä¸‹å€¼æ˜¯ç²¾ç¡®çš„
  if (progressRatio >= 1) {
    offset = 0; // å®Œå…¨å¡«æ»¡
  } else if (progressRatio <= 0) {
    offset = inlineCircumference.value; // å®Œå…¨ä¸ºç©º
  }
  
  return offset;
});

const toggleHabit = async (habitId: string) => {
  const habit = habits.value.find(h => h.id === habitId);
  if (!habit) {

    return;
  }
  
  
  
  // å¦‚æœå¯ç”¨äº†ç•ªèŒ„é’ŸåŠŸèƒ½ï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦å·²å®Œæˆ
  if (habit.usePomodoro) {
    // å¦‚æœä¹ æƒ¯å·²å®Œæˆï¼Œåˆ™å–æ¶ˆå®ŒæˆçŠ¶æ€
    if (habit.completedToday) {
      // å¼¹å‡ºç¡®è®¤å–æ¶ˆæ‰“å¡å¼¹çª—
      if (confirm('æ˜¯å¦è¦å–æ¶ˆæ‰“å¡è®°å½•ï¼Ÿ')) {

        // å–æ¶ˆå½“å¤©å®ŒæˆçŠ¶æ€
        // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
        const today = getToday();
        let todayRecord = habit.calendar.find(day => day.date === today);
        
        if (todayRecord) {
          // æ¸…é™¤å½“å¤©æ‰€æœ‰æ‰“å¡æ¬¡æ•°ï¼Œé‡ç½®ä¸º0
          todayRecord.completed = false;
          todayRecord.completedCount = 0;
        }
        
        // æ›´æ–°ä¹ æƒ¯çš„å®ŒæˆçŠ¶æ€
        habit.completedToday = false;
        
        // é‡æ–°è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°å’Œæ€»å®Œæˆæ¬¡æ•°
        updateHabitStats(habit);

        await immediateSaveHabits(habits.value);
      }
      return;
    } else {
      // å¦‚æœå½“å‰æœ‰å…¶ä»–ç•ªèŒ„é’Ÿæ­£åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢å®ƒ
      if (activePomodoroHabit.value && activePomodoroHabit.value.id !== habit.id) {
        const previousHabit = activePomodoroHabit.value;
        // æ¸…é™¤ä¹‹å‰çš„ç•ªèŒ„é’Ÿ
        activePomodoroHabit.value = null;
        if (pomodoroTimers[previousHabit.id]) {
          clearInterval(pomodoroTimers[previousHabit.id]);
          delete pomodoroTimers[previousHabit.id];
        }
        // æ¸…é™¤ç•ªèŒ„é’Ÿç›¸å…³çŠ¶æ€
        delete previousHabit.pomodoroRemaining;
        delete previousHabit.pomodoroState;
      }
      
      // è®¾ç½®å½“å‰æ¿€æ´»çš„ç•ªèŒ„é’Ÿä¹ æƒ¯
      activePomodoroHabit.value = habit;
      // å¯åŠ¨ç•ªèŒ„é’Ÿè®¡æ—¶å™¨
      startPomodoroTimer(habit);
      return;
    }
  }
  

  
  // æ£€æŸ¥æ˜¯å¦ä¸ºå‘¨é¢‘æ¬¡ä¹ æƒ¯ä¸”å·²å®Œæˆæœ¬å‘¨ç›®æ ‡
  if (habit.frequency && habit.frequency.startsWith('weekly')) {
    if (getWeeklyCompletionStatus(habit)) {
      // å¦‚æœå‘¨ç›®æ ‡å·²å®Œæˆï¼Œç‚¹å‡»æŒ‰é’®åº”å–æ¶ˆå®ŒæˆçŠ¶æ€
      if (confirm('æ˜¯å¦è¦å–æ¶ˆæ‰“å¡è®°å½•ï¼Ÿ')) {
        // æ‰¾åˆ°æœ¬å‘¨æ‰€æœ‰å·²å®Œæˆçš„è®°å½•å¹¶å–æ¶ˆå®ŒæˆçŠ¶æ€
        const today = new Date();
        // è®¡ç®—æœ¬å‘¨çš„å‘¨ä¸€
        const todayWeekday = today.getDay();
        const daysToMonday = todayWeekday === 0 ? -6 : 1 - todayWeekday; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨6å¤©åˆ°å‘¨ä¸€
        const thisWeekMonday = new Date(today);
        thisWeekMonday.setDate(today.getDate() + daysToMonday);
        
        // æ‰¾åˆ°æœ¬å‘¨æ‰€æœ‰å·²å®Œæˆçš„æ‰“å¡è®°å½•ï¼ŒæŒ‰æ—¥æœŸå€’åºæ’åˆ—
        const weeklyCompletedDays = habit.calendar
          .filter(day => {
            const dayDate = new Date(day.date);
            // è®¡ç®—è¿™ä¸ªæ—¥æœŸå±äºå“ªä¸€å‘¨ï¼ˆå‘¨ä¸€ä¸ºä¸€å‘¨çš„å¼€å§‹ï¼‰
            const dayStartOfWeek = new Date(dayDate);
            const dayDayOfWeek = dayDate.getDay();
            const dayDaysToMonday = dayDayOfWeek === 0 ? -6 : 1 - dayDayOfWeek; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨6å¤©åˆ°å‘¨ä¸€
            dayStartOfWeek.setDate(dayDate.getDate() + dayDaysToMonday);
            
            // ç¡®ä¿æ—¥æœŸéƒ¨åˆ†ä¸€è‡´ï¼ˆé‡ç½®æ—¶é—´éƒ¨åˆ†ä¸º00:00:00ï¼‰
            const normalizedStartOfWeek = new Date(thisWeekMonday.getFullYear(), thisWeekMonday.getMonth(), thisWeekMonday.getDate());
            const normalizedDayStartOfWeek = new Date(dayStartOfWeek.getFullYear(), dayStartOfWeek.getMonth(), dayStartOfWeek.getDate());
            
            // æ£€æŸ¥æ˜¯å¦ä¸å½“å‰æŸ¥çœ‹çš„å‘¨æ˜¯åŒä¸€å‘¨
            return day.completed && 
              normalizedStartOfWeek.getTime() === normalizedDayStartOfWeek.getTime();
          })
          .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
        
        // å–æ¶ˆæœ€åä¸€æ¡æ‰“å¡è®°å½•çš„å®ŒæˆçŠ¶æ€
        if (weeklyCompletedDays.length > 0) {
          const lastCompletedDay = weeklyCompletedDays[0];
          lastCompletedDay.completed = false;
          lastCompletedDay.completedCount = 0;
          // é‡ç½®å½“å¤©çš„å®ŒæˆçŠ¶æ€
          if (lastCompletedDay.date === getToday()) {
            habit.completedToday = false;
          }
          delete lastCompletedDay.timestamp;
        }
        
        // é‡æ–°è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°å’Œæ€»å®Œæˆæ¬¡æ•°
        updateHabitStats(habit);

        await immediateSaveHabits(habits.value);
      }
      return; // é€€å‡ºå‡½æ•°ï¼Œä¸æ‰§è¡Œåç»­æ‰“å¡é€»è¾‘
    }
  }
  
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const today = getToday();
  
  // ä½¿ç”¨é€šç”¨æ‰“å¡å‡½æ•°å¤„ç†æ‰“å¡é€»è¾‘
  toggleHabitCompletion(habit, today);
  
  // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰“å¡ï¼Œå¦‚æœæ˜¯åˆ™è§¦å‘åŠ¨ç”»
  const completedToday = habit.completedToday;
  if (completedToday && !habit.usePomodoro) {  // ç•ªèŒ„é’Ÿä¹ æƒ¯ä¸ä½¿ç”¨æ­¤åŠ¨ç”»
    // ä¿å­˜åŸå§‹å®ŒæˆçŠ¶æ€ï¼Œä»¥ä¾¿åœ¨åŠ¨ç”»æœŸé—´ä¿æŒåœ¨æœªå®ŒæˆåŒºåŸŸ
    animationOriginalStatus.value[habit.id] = false; // æ‰“å¡å‰çš„çŠ¶æ€æ˜¯æœªå®Œæˆ
    
    // è§¦å‘æˆåŠŸåŠ¨ç”»
    showAnimation.value = true;
    animationHabitId.value = habit.id;
    
    // åŠ¨ç”»ç»“æŸåå†ä¿å­˜æ•°æ®å’Œé‡ç½®åŠ¨ç”»çŠ¶æ€
    setTimeout(async () => {
      await immediateSaveHabits(habits.value);
      showAnimation.value = false;
      animationHabitId.value = null;
      // æ¸…é™¤åŠ¨ç”»åŸå§‹çŠ¶æ€
      delete animationOriginalStatus.value[habit.id];
    }, 600); // åŠ¨ç”»æŒç»­æ—¶é—´
  } else {
    // å¦‚æœæ²¡æœ‰å®Œæˆæ‰“å¡æˆ–ä½¿ç”¨ç•ªèŒ„é’Ÿï¼Œç›´æ¥ä¿å­˜æ•°æ®
    await immediateSaveHabits(habits.value);
  }
};

// å¯åŠ¨ç•ªèŒ„é’Ÿè®¡æ—¶å™¨
const startPomodoroTimer = (habit: Habit) => {

  
  // å¦‚æœå·²æœ‰è®¡æ—¶å™¨ï¼Œå…ˆæ¸…é™¤
  if (pomodoroTimers[habit.id]) {

    clearInterval(pomodoroTimers[habit.id]);
  }
  
  // è®¾ç½®ç•ªèŒ„é’Ÿæ—¶é•¿ï¼Œä½¿ç”¨ä¹ æƒ¯é…ç½®çš„æ—¶é•¿ï¼ˆåˆ†é’Ÿè½¬æ¢ä¸ºç§’ï¼‰
  const durationInMinutes = habit.pomodoroDuration || 25; // é»˜è®¤25åˆ†é’Ÿ
  let remainingTime = durationInMinutes * 60; // è½¬æ¢ä¸ºç§’

  
  // æ›´æ–°ä¹ æƒ¯çš„ç•ªèŒ„é’ŸçŠ¶æ€
  habit.pomodoroRemaining = remainingTime;
  habit.pomodoroState = 'work'; // é»˜è®¤å¼€å§‹å·¥ä½œæ—¶é—´

  
  // å¯åŠ¨å€’è®¡æ—¶
  pomodoroTimers[habit.id] = window.setInterval(() => {
    remainingTime--;
    habit.pomodoroRemaining = remainingTime;

    
    if (remainingTime <= 0) {
      // å€’è®¡æ—¶ç»“æŸï¼Œå®Œæˆæ‰“å¡

      clearInterval(pomodoroTimers[habit.id]);
      completeHabitAfterPomodoro(habit);
      
      // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¿™ä¸ªä¹ æƒ¯çš„ç•ªèŒ„é’Ÿé¡µé¢ï¼Œåˆ™å…³é—­é¡µé¢
      if (activePomodoroHabit.value && activePomodoroHabit.value.id === habit.id) {
        activePomodoroHabit.value = null;
      }
    }
  }, 1000);
  

};

// ç•ªèŒ„é’Ÿç»“æŸåå®Œæˆæ‰“å¡
const completeHabitAfterPomodoro = async (habit: Habit) => {

  
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const today = getToday();
  
  // ä½¿ç”¨é€šç”¨æ‰“å¡å‡½æ•°å¤„ç†æ‰“å¡é€»è¾‘
  toggleHabitCompletion(habit, today);
  
  // æ¸…é™¤ç•ªèŒ„é’Ÿç›¸å…³çŠ¶æ€
  delete habit.pomodoroRemaining;
  delete habit.pomodoroState;
  if (pomodoroTimers[habit.id]) {
    clearInterval(pomodoroTimers[habit.id]);
    delete pomodoroTimers[habit.id];
  }
  
  await saveHabits(habits.value);

};


// æ ¼å¼åŒ–ç•ªèŒ„é’Ÿæ—¶é—´æ˜¾ç¤º
const formatPomodoroTime = (seconds: number): string => {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// è·å–ç•ªèŒ„é’Ÿåˆå§‹æ€»æ—¶é—´
const getPomodoroTotalTime = (habit: Habit): number => {
  let totalTime = 0;
  if (habit.pomodoroState === 'work') {
    // ä½¿ç”¨ä¹ æƒ¯é…ç½®çš„ç•ªèŒ„é’Ÿæ—¶é•¿
    totalTime = (habit.pomodoroDuration || 25) * 60; // é»˜è®¤25åˆ†é’Ÿ
  } else if (habit.pomodoroState === 'shortBreak') {
    totalTime = 5 * 60; // 5åˆ†é’ŸçŸ­ä¼‘æ¯
  } else if (habit.pomodoroState === 'longBreak') {
    totalTime = 15 * 60; // 15åˆ†é’Ÿé•¿ä¼‘æ¯
  } else {
    totalTime = (habit.pomodoroDuration || 25) * 60; // é»˜è®¤ä½¿ç”¨ä¹ æƒ¯é…ç½®çš„æ—¶é•¿
  }
  return totalTime;
};

// åœæ­¢å½“å‰ç•ªèŒ„é’Ÿï¼ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼‰
const stopCurrentPomodoro = () => {
  if (activePomodoroHabit.value) {
    const habit = activePomodoroHabit.value;
    
    controlPomodoro('stop', habit);
    
    // æ¸…é™¤å½“å‰æ¿€æ´»çš„ç•ªèŒ„é’Ÿ
    activePomodoroHabit.value = null;
    
    saveHabits(habits.value);
  }
};

// ç»Ÿä¸€çš„ç•ªèŒ„é’Ÿæ§åˆ¶å‡½æ•°
const controlPomodoro = (action: 'pause' | 'resume' | 'start' | 'stop', habit?: Habit) => {
  if (!habit && activePomodoroHabit.value) {
    habit = activePomodoroHabit.value;
  }
  
  if (!habit) return;
  
  switch (action) {
    case 'pause':
      // æš‚åœå®šæ—¶å™¨
      if (pomodoroTimers[habit.id]) {
        clearInterval(pomodoroTimers[habit.id]);
        delete pomodoroTimers[habit.id];
      }
      
      // è®¾ç½®æš‚åœçŠ¶æ€
      habit.isPomodoroPaused = true;
      break;
      
    case 'resume':
      // æ¸…é™¤æš‚åœçŠ¶æ€
      habit.isPomodoroPaused = false;
      
      // é‡æ–°å¯åŠ¨å®šæ—¶å™¨ï¼Œä½¿ç”¨å‰©ä½™æ—¶é—´ç»§ç»­
      if (habit.pomodoroRemaining !== undefined) {
        // æ¸…é™¤æ—§çš„å®šæ—¶å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
        if (pomodoroTimers[habit.id]) {
          clearInterval(pomodoroTimers[habit.id]);
          delete pomodoroTimers[habit.id];
        }
        
        // é‡æ–°å¯åŠ¨å®šæ—¶å™¨ï¼Œä½¿ç”¨å‰©ä½™æ—¶é—´
        startPomodoroTimerWithRemainingTime(habit, habit.pomodoroRemaining);
      }
      break;
      
    case 'start':
      // å¯åŠ¨ç•ªèŒ„é’Ÿ
      startPomodoroTimer(habit);
      break;
      
    case 'stop':
      // åœæ­¢ç•ªèŒ„é’Ÿ
      if (pomodoroTimers[habit.id]) {
        clearInterval(pomodoroTimers[habit.id]);
        delete pomodoroTimers[habit.id];
      }
      
      // æ¸…é™¤ç•ªèŒ„é’Ÿç›¸å…³çŠ¶æ€
      delete habit.pomodoroRemaining;
      delete habit.pomodoroState;
      delete habit.isPomodoroPaused;
      break;
  }
  
  // ä¿å­˜çŠ¶æ€
  saveHabits(habits.value);
};

// æš‚åœç•ªèŒ„é’Ÿ
const togglePomodoroPause = () => {
  if (activePomodoroHabit.value) {
    controlPomodoro('pause', activePomodoroHabit.value);
  }
};

// ç»§ç»­ç•ªèŒ„é’Ÿ
const togglePomodoroResume = () => {
  if (activePomodoroHabit.value) {
    controlPomodoro('resume', activePomodoroHabit.value);
  }
};

// ä½¿ç”¨å‰©ä½™æ—¶é—´å¯åŠ¨ç•ªèŒ„é’Ÿè®¡æ—¶å™¨
const startPomodoroTimerWithRemainingTime = (habit: Habit, remainingTime: number) => {
  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (pomodoroTimers[habit.id]) {
    clearInterval(pomodoroTimers[habit.id]);
    delete pomodoroTimers[habit.id];
  }

  // åˆå§‹åŒ–å‰©ä½™æ—¶é—´
  habit.pomodoroRemaining = remainingTime;

  // è®¾ç½®æ–°çš„å®šæ—¶å™¨
  pomodoroTimers[habit.id] = window.setInterval(() => {
    habit.pomodoroRemaining!--;
    
    if (habit.pomodoroRemaining! <= 0) {
      // å€’è®¡æ—¶ç»“æŸï¼Œå®Œæˆæ‰“å¡
      clearInterval(pomodoroTimers[habit.id]);
      delete pomodoroTimers[habit.id];
      completeHabitAfterPomodoro(habit);
      
      // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¿™ä¸ªä¹ æƒ¯çš„ç•ªèŒ„é’Ÿé¡µé¢ï¼Œåˆ™å…³é—­é¡µé¢
      if (activePomodoroHabit.value && activePomodoroHabit.value.id === habit.id) {
        activePomodoroHabit.value = null;
      }
    }
  }, 1000);
};

// æ ¹æ®ç•ªèŒ„é’ŸçŠ¶æ€è¿”å›å¯¹åº”çš„CSSç±»
const pomodoroStateClass = (state?: 'work' | 'shortBreak' | 'longBreak') => {
  if (!state) return 'pomodoro-running';
  
  switch (state) {
    case 'work':
      return 'pomodoro-running';
    case 'shortBreak':
      return 'pomodoro-short-break';
    case 'longBreak':
      return 'pomodoro-long-break';
    default:
      return 'pomodoro-running';
  }
};

// åˆ é™¤ä¹ æƒ¯
const deleteHabit = async (habitId: string) => {
  if (!confirm(t('habitTracker.confirmDelete'))) {
    return;
  }
  
  habits.value = habits.value.filter(h => h.id !== habitId);
  await saveHabits(habits.value);
  
  // å…³é—­ç»Ÿè®¡é¡µé¢
  selectedHabit.value = null;
};



// è®¡ç®—å¤§å°ºå¯¸é¥¼çŠ¶å›¾è¿›åº¦è·¯å¾„ï¼ˆç”¨äºè£å‰ªï¼‰
const getLargePiePath = (habit: Habit) => {
  const completedCount = getTodayCompletionCount(habit);
  const targetCount = habit.timesPerDay || 1;
  const progress = Math.min(1, Math.max(0, completedCount / targetCount)); // ç¡®ä¿è¿›åº¦åœ¨0-1ä¹‹é—´
  
  // åœ†å¿ƒåæ ‡å’ŒåŠå¾„ï¼ˆä½¿ç”¨æ›´å¤§çš„åŠå¾„ä»¥å¡«å……çŸ©å½¢ï¼‰
  const cx = 13; // ä¸­å¿ƒç‚¹è°ƒæ•´ä¸º13ï¼ˆ26/2ï¼‰
  const cy = 13; // ä¸­å¿ƒç‚¹è°ƒæ•´ä¸º13ï¼ˆ26/2ï¼‰
  const r = 16; // ä½¿ç”¨æ›´å¤§çš„åŠå¾„ä»¥å¡«å……çŸ©å½¢
  
  // è®¡ç®—è§’åº¦ï¼ˆä»12ç‚¹é’Ÿæ–¹å‘å¼€å§‹ï¼Œé¡ºæ—¶é’ˆï¼‰
  const startAngle = -Math.PI / 2; // ä»é¡¶éƒ¨å¼€å§‹
  const endAngle = startAngle + 2 * Math.PI * progress;
  
  // è®¡ç®—èµ·ç‚¹å’Œç»ˆç‚¹åæ ‡
  const startX = cx + r * Math.cos(startAngle);
  const startY = cy + r * Math.sin(startAngle);
  const endX = cx + r * Math.cos(endAngle);
  const endY = cy + r * Math.sin(endAngle);
  
  // åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å¤§å¼§å½¢
  const largeArcFlag = progress > 0.5 ? 1 : 0;
  
  // æ„å»ºè·¯å¾„
  if (progress === 0) {
    return `M ${cx} ${cy}`; // ä¸­å¿ƒç‚¹
  } else if (progress === 1) {
    // å®Œæ•´é¥¼å›¾ï¼Œä»ä¸­å¿ƒå‡ºå‘ç”»ä¸€ä¸ªå®Œæ•´çš„åœ†ç„¶åå›åˆ°ä¸­å¿ƒ
    return `M ${cx} ${cy} L ${cx} ${cy - r} A ${r} ${r} 0 1 1 ${cx - 0.01} ${cy - r} Z`;
  } else {
    // æ‰‡å½¢è·¯å¾„ï¼šä»ä¸­å¿ƒåˆ°èµ·ç‚¹ï¼Œç”»å¼§åˆ°ç»ˆç‚¹ï¼Œå†å›åˆ°ä¸­å¿ƒ
    return `M ${cx} ${cy} L ${startX} ${startY} A ${r} ${r} 0 ${largeArcFlag} 1 ${endX} ${endY} Z`;
  }
};


// è®¡ç®—æœ¬æœˆå®Œæˆç‡
const calculateCompletionRate = (habit: Habit) => {
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();
  
  // è·å–ä¹ æƒ¯çš„åˆ›å»ºæ—¥æœŸ
  // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–¹æ³•å¤„ç†ISOæ—¥æœŸå­—ç¬¦ä¸²ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const creationDateISO = habit.createdAt;
  let creationDate: Date;
  
  if (creationDateISO.endsWith('Z')) {
    // å¦‚æœæ˜¯UTCæ—¶é—´æ ¼å¼ï¼Œç›´æ¥è§£æ
    creationDate = new Date(creationDateISO);
  } else {
    // å¦‚æœåŒ…å«æ—¶åŒºä¿¡æ¯ï¼Œç›´æ¥è§£æ
    creationDate = new Date(creationDateISO);
  }
  
  // å°†åˆ›å»ºæ—¥æœŸè°ƒæ•´ä¸ºæœ¬åœ°æ—¥æœŸçš„å¼€å§‹æ—¶é—´ï¼Œä»¥ç¡®ä¿æ­£ç¡®æ¯”è¾ƒ
  // ä½¿ç”¨æœ¬åœ°æ—¶é—´çš„å¹´æœˆæ—¥åˆ›å»ºæ–°æ—¥æœŸï¼Œé¿å…æ—¶åŒºé—®é¢˜
  const localCreationDate = new Date(creationDate.getFullYear(), creationDate.getMonth(), creationDate.getDate());
  creationDate = localCreationDate;
  
  // åˆ›å»ºä¸€ä¸ªå›ºå®šçš„åˆ›å»ºæ—¥æœŸå‰¯æœ¬ï¼Œé˜²æ­¢åç»­å¤„ç†ä¸­è¢«ä¿®æ”¹
  const fixedCreationDate = new Date(creationDate);
  
  // ä½¿ç”¨å›ºå®šçš„åˆ›å»ºæ—¥æœŸè¿›è¡Œåç»­è®¡ç®—
  const creationDateForCalculation = fixedCreationDate;
  


  

  
  // è¿‡æ»¤å‡ºæœ¬æœˆçš„æ‰“å¡è®°å½•ï¼Œä½†ä»…åŒ…æ‹¬åˆ›å»ºæ—¥æœŸåŠä¹‹åçš„è®°å½•
  const monthRecords = habit.calendar.filter(record => {
    const recordDate = new Date(record.date);
    // å°†è®°å½•æ—¥æœŸä¹Ÿè®¾ç½®ä¸ºå½“å¤©å¼€å§‹æ—¶é—´ï¼Œä»¥ç¡®ä¿æ­£ç¡®æ¯”è¾ƒ
    recordDate.setHours(0, 0, 0, 0);
    return recordDate.getFullYear() === currentYear && 
           recordDate.getMonth() === currentMonth &&
           recordDate >= creationDateForCalculation; // åªç»Ÿè®¡åˆ›å»ºæ—¥æœŸåŠä¹‹åçš„è®°å½•
  });
  

  
  if (habit.frequency.startsWith('weekly')) {
    // å¯¹äºå‘¨é¢‘æ¬¡ä¹ æƒ¯ï¼Œè®¡ç®—åŸºäºåº”å®Œæˆæ¬¡æ•°çš„å®Œæˆç‡
    
    // ç¡®å®šæ¯å‘¨éœ€è¦å®Œæˆçš„æ¬¡æ•°
    let weeklyTarget = 1; // é»˜è®¤ä¸º1æ¬¡
    if (habit.frequency === 'weekly2') weeklyTarget = 2;
    else if (habit.frequency === 'weekly3') weeklyTarget = 3;
    else if (habit.frequency === 'weekly4') weeklyTarget = 4;
    else if (habit.frequency === 'weekly5') weeklyTarget = 5;
    else if (habit.frequency === 'weekly6') weeklyTarget = 6;
    

    
    // è®¡ç®—æœ¬å‘¨çš„å‘¨ä¸€å’Œå‘¨æ—¥ï¼ˆä»…ç”¨äºç¡®å®šæœˆä»½çš„ç»“æŸæ—¥æœŸï¼‰
    const todayWeekday = today.getDay();
    const daysToMonday = todayWeekday === 0 ? -6 : 1 - todayWeekday; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨6å¤©åˆ°å‘¨ä¸€
    const thisWeekMonday = new Date(today);
    thisWeekMonday.setDate(today.getDate() + daysToMonday);
    
    const daysToSunday = todayWeekday === 0 ? 0 : 7 - todayWeekday;
    const thisWeekSunday = new Date(today);
    thisWeekSunday.setDate(today.getDate() + daysToSunday);
    
    // å¯¹äºå‘¨é¢‘æ¬¡ä¹ æƒ¯ï¼Œæˆ‘ä»¬ç»Ÿè®¡å®Œæˆå‘¨æ•°è€Œä¸æ˜¯å®Œæˆæ¬¡æ•°
    // è®¡ç®—å®é™…å®Œæˆçš„å‘¨æ•°
    let completedWeeks = 0;
    
    // è®¡ç®—ä»åˆ›å»ºæ—¥æœŸæ‰€åœ¨å‘¨çš„å‘¨ä¸€åˆ°æœ¬å‘¨å‘¨æ—¥çš„æ‰€æœ‰å‘¨ï¼ˆä¸åŒ…æ‹¬æœªæ¥å‘¨ï¼‰
    const creationWeekStart = new Date(creationDateForCalculation);
    const creationWeekday = creationDateForCalculation.getDay();
    const daysToCreationMonday = creationWeekday === 0 ? -6 : 1 - creationWeekday; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨åˆ°å‘¨ä¸€
    creationWeekStart.setDate(creationDateForCalculation.getDate() + daysToCreationMonday);
    
    // è®¡ç®—æœ¬å‘¨çš„å‘¨æ—¥ï¼ˆä»Šå¤©æ‰€åœ¨çš„å‘¨ï¼‰
    const currentTodayWeekday = today.getDay();
    const currentDaysToSunday = currentTodayWeekday === 0 ? 0 : 7 - currentTodayWeekday; // å¦‚æœä»Šå¤©æ˜¯å‘¨æ—¥ï¼Œåˆ™æ˜¯0å¤©å
    const currentWeekSunday = new Date(today);
    currentWeekSunday.setDate(today.getDate() + currentDaysToSunday);
    

    
    // è®¡ç®—éœ€è¦å¤„ç†çš„å‘¨æ•°
    const totalCalculatedWeeks = [];
    let tempWeekStart = new Date(creationWeekStart);
    
    // æ”¶é›†æ‰€æœ‰éœ€è¦æ£€æŸ¥çš„å‘¨ï¼Œä»åˆ›å»ºæ—¥æœŸæ‰€åœ¨å‘¨åˆ°æœ¬å‘¨å‘¨æ—¥
    while (tempWeekStart <= currentWeekSunday) {
      const tempWeekEnd = new Date(tempWeekStart);
      tempWeekEnd.setDate(tempWeekStart.getDate() + 6); // å‘¨æ—¥
      
      // ç¡®ä¿å‘¨çš„ç»“æŸæ—¥æœŸä¸è¶…è¿‡æœ¬å‘¨å‘¨æ—¥ï¼ˆé¿å…åŒ…å«æœªæ¥å‘¨ï¼‰
      if (tempWeekEnd > currentWeekSunday) {
        tempWeekEnd.setTime(currentWeekSunday.getTime());
      }
      
      // åªç»Ÿè®¡åˆ›å»ºæ—¥æœŸä¹‹åçš„å‘¨ï¼Œæ³¨æ„è¿™é‡Œåº”è¯¥æ˜¯åˆ¤æ–­å‘¨ç»“æŸæ—¥æœŸæ˜¯å¦æ™šäºåˆ›å»ºæ—¥æœŸ
      // å› ä¸ºä¸€å‘¨å†…çš„ä»»ä½•ä¸€å¤©å®Œæˆæ‰“å¡éƒ½åº”è®¡å…¥è¯¥å‘¨
      if (tempWeekEnd >= creationDateForCalculation) {
        totalCalculatedWeeks.push({
          start: new Date(tempWeekStart),
          end: tempWeekEnd
        });
      }
      
      tempWeekStart.setDate(tempWeekStart.getDate() + 7); // ä¸‹ä¸€å‘¨
    }
    
    // ä¸å†éœ€è¦è®¡ç®— totalWeeksï¼Œä½¿ç”¨ totalCalculatedWeeks.length
    

    
    // æ£€æŸ¥æ¯ä¸€å‘¨çš„å®Œæˆæƒ…å†µ
    for (const week of totalCalculatedWeeks) {
      // æ£€æŸ¥è¿™ä¸€å‘¨å†…æ˜¯å¦å®Œæˆäº†ç›®æ ‡æ¬¡æ•°
      let weekCompletedCount = 0;
      for (const record of habit.calendar) {
        const recordDate = new Date(record.date);
        // å°†è®°å½•æ—¥æœŸè®¾ç½®ä¸ºå½“å¤©çš„å¼€å§‹æ—¶é—´ï¼Œä»¥ç¡®ä¿æ­£ç¡®æ¯”è¾ƒ
        recordDate.setHours(0, 0, 0, 0);
        
        // æ£€æŸ¥è¿™ä¸ªè®°å½•æ˜¯å¦åœ¨å½“å‰å‘¨å†…
        if (recordDate >= week.start && recordDate <= week.end && record.completed) {
          weekCompletedCount += record.completedCount || 1;
        }
      }
      

      
      // å¦‚æœè¿™ä¸€å‘¨å®Œæˆäº†ç›®æ ‡æ¬¡æ•°ï¼Œåˆ™ç®—ä½œå®Œæˆä¸€å‘¨
      if (weekCompletedCount >= weeklyTarget) {
        completedWeeks++;

      }
    }
    

    
    // è®¡ç®—å®Œæˆç‡ï¼šå®Œæˆçš„å‘¨æ•° / æ€»å‘¨æ•° * 100%
    const totalCalculatedWeeksCount = totalCalculatedWeeks.length;
    const completionRate = totalCalculatedWeeksCount > 0 ? (completedWeeks / totalCalculatedWeeksCount) * 100 : 0;
    const roundedRate = Math.round(completionRate);
    

    
    return roundedRate;
  } else {
    // å¯¹äºæ—¥é¢‘æ¬¡ä¹ æƒ¯ï¼Œè®¡ç®—åŸºäºå¤©æ•°çš„å®Œæˆç‡
    

    
    // è®¡ç®—æœ¬æœˆå·²å®Œæˆçš„å¤©æ•°
    const completedDays = monthRecords.filter(record => record.completed).length;
    
    // å¦‚æœä¹ æƒ¯æ˜¯æœ¬æœˆåˆ›å»ºçš„ï¼Œè®¡ç®—ä»åˆ›å»ºæ—¥æœŸåˆ°ä»Šå¤©çš„å¤©æ•°
    let totalDaysInPeriod = 0;
    
    if (creationDateForCalculation.getMonth() === currentMonth && creationDateForCalculation.getFullYear() === currentYear) {
      // æœ¬æœˆåˆ›å»ºçš„ä¹ æƒ¯ï¼šä»åˆ›å»ºæ—¥æœŸåˆ°ä»Šå¤©ï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰
      // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼æ¥é¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
      const creationDateLocal = new Date(creationDateForCalculation.getFullYear(), creationDateForCalculation.getMonth(), creationDateForCalculation.getDate());
      const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      
      // è®¡ç®—ä»åˆ›å»ºæ—¥æœŸåˆ°ä»Šå¤©çš„å¤©æ•°ï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰
      totalDaysInPeriod = Math.floor((todayLocal.getTime() - creationDateLocal.getTime()) / (1000 * 60 * 60 * 24)) + 1;
      

    } else {
      // éæœ¬æœˆåˆ›å»ºçš„ä¹ æƒ¯ï¼šä»æœˆåˆåˆ°ä»Šå¤©
      const dayOfMonth = today.getDate();
      totalDaysInPeriod = dayOfMonth;
    }
    
    // æ£€æŸ¥åˆ›å»ºå½“å¤©æ˜¯å¦å·²å®Œæˆæ‰“å¡ï¼ˆå¦‚æœåˆ›å»ºå½“å¤©å°±æ˜¯ä»Šå¤©ï¼Œå¹¶ä¸”æ˜¯æœ¬æœˆåˆ›å»ºï¼‰
    if (creationDateForCalculation.getMonth() === currentMonth && 
        creationDateForCalculation.getFullYear() === currentYear &&
        creationDateForCalculation.getDate() === today.getDate() && 
        creationDateForCalculation.getMonth() === today.getMonth() &&
        creationDateForCalculation.getFullYear() === today.getFullYear()) {
      // å¦‚æœæ˜¯æœ¬æœˆåˆ›å»ºä¸”åˆ›å»ºå½“å¤©å°±æ˜¯ä»Šå¤©ï¼Œä¸”ä»Šå¤©å·²å®Œæˆæ‰“å¡
      const todayRecord = habit.calendar.find(record => record.date === formatDate(today));
      if (todayRecord && todayRecord.completed) {
        
        return 100;
      }
    }
    

    
    // è®¡ç®—å®Œæˆç‡ï¼šå·²å®Œæˆå¤©æ•° / ç»Ÿè®¡å‘¨æœŸå†…æ€»å¤©æ•° * 100%
    const completionRate = totalDaysInPeriod > 0 ? (completedDays / totalDaysInPeriod) * 100 : 0;
    const roundedRate = Math.round(completionRate);
    

    
    return roundedRate;
  }
};

// è·å–æ ‡å‡†åŒ–çš„åˆ›å»ºæ—¥æœŸ
const getNormalizedCreationDate = (habit: Habit) => {
  const creationDate = new Date(habit.createdAt);
  creationDate.setHours(0, 0, 0, 0); // å°†åˆ›å»ºæ—¥æœŸè°ƒæ•´ä¸ºå½“å¤©çš„å¼€å§‹æ—¶é—´
  return creationDate;
};

// è·å–æ ‡å‡†åŒ–çš„æ—¥æœŸå¯¹è±¡
const getNormalizedDate = (date: Date | string) => {
  const normalizedDate = new Date(date);
  normalizedDate.setHours(0, 0, 0, 0);
  return normalizedDate;
};



// è·å–æœ¬æœˆçš„æ‰“å¡è®°å½•
const getMonthRecords = (habit: Habit, currentYear: number, currentMonth: number) => {
  const creationDate = getNormalizedCreationDate(habit);
  
  return habit.calendar.filter(record => {
    const recordDate = getNormalizedDate(record.date);
    return recordDate.getFullYear() === currentYear && 
           recordDate.getMonth() === currentMonth &&
           recordDate >= creationDate; // åªç»Ÿè®¡åˆ›å»ºæ—¥æœŸä¹‹åçš„è®°å½•
  });
};

// è®¡ç®—æœ¬æœˆè¿ç»­æ‰“å¡å¤©æ•°
const calculateCurrentMonthStreak = (habit: Habit) => {
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();
  
  const creationDate = getNormalizedCreationDate(habit);
  
  // è¿‡æ»¤å‡ºæœ¬æœˆçš„æ‰“å¡è®°å½•
  const monthRecords = getMonthRecords(habit, currentYear, currentMonth)
    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
  
  if (monthRecords.length === 0) {
    return 0; // å¦‚æœæœ¬æœˆæ²¡æœ‰è®°å½•ï¼Œåˆ™è¿ç»­å¤©æ•°ä¸º0
  }
  
  let streak = 0;
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  const todayStr = getToday();
  let currentDate = new Date(today);
  
  // æ£€æŸ¥æ˜¯å¦ä»Šå¤©å·²å®Œæˆ
  const todayRecord = habit.calendar.find(record => record.date === todayStr);
  if (todayRecord && todayRecord.completed) {
    streak++;
  }
  
  // å¾€å‰æ£€æŸ¥è¿ç»­çš„å®Œæˆæ—¥æœŸ
  for (let i = 1; ; i++) {
    const checkDate = new Date(currentDate);
    checkDate.setDate(currentDate.getDate() - i);
    
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
    const checkDateStr = formatDate(checkDate);
    
    // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨å½“å‰æœˆä»½
    if (checkDate.getMonth() !== currentMonth || checkDate.getFullYear() !== currentYear) {
      break; // å·²ç»è¶…å‡ºå½“å‰æœˆä»½ï¼Œåœæ­¢è®¡ç®—
    }
    
    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨åˆ›å»ºæ—¥æœŸä¹‹å
    if (checkDate < creationDate) {
      break; // å·²ç»è¶…å‡ºåˆ›å»ºæ—¥æœŸï¼Œåœæ­¢è®¡ç®—
    }
    
    const record = habit.calendar.find(r => r.date === checkDateStr);
    if (record && record.completed) {
      streak++;
    } else {
      break; // é‡åˆ°æœªå®Œæˆçš„æ—¥æœŸï¼Œåœæ­¢è®¡ç®—
    }
  }
  
  return streak;
};

// è®¡ç®—æœ¬æœˆæ€»æ‰“å¡æ•°
const calculateTotalMonthCompletions = (habit: Habit) => {
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();
  
  // ä½¿ç”¨å…¬å…±å‡½æ•°è·å–æœ¬æœˆçš„æ‰“å¡è®°å½•
  const monthRecords = getMonthRecords(habit, currentYear, currentMonth);
  
  // è¿‡æ»¤å‡ºå·²å®Œæˆçš„è®°å½•å¹¶è®¡ç®—æ•°é‡
  return monthRecords.filter(record => record.completed).length;
};

// ç¼“å­˜å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨æœ€é•¿è¿ç»­æ‰“å¡è®¡ç®—ç»“æœ
const longestStreakCache = new Map<string, {result: { streak: number, startDate: Date | null, endDate: Date | null }, timestamp: number}>();

// è®¡ç®—æœ€é•¿è¿ç»­æ‰“å¡æ•°
const calculateLongestStreak = (habit: Habit) => {
  // åˆ›å»ºç¼“å­˜é”®
  const cacheKey = `${habit.id}-longestStreak-${Date.now() - (Date.now() % 86400000)}`; // åŒ…å«æ—¥æœŸä½†å¿½ç•¥æ—¶é—´
  
  // æ£€æŸ¥ç¼“å­˜ï¼ˆæ¯æ—¥é‡ç½®ï¼‰
  const cached = longestStreakCache.get(cacheKey);
  if (cached && (Date.now() - cached.timestamp) < 86400000) { // ä¸€å¤©å†…æœ‰æ•ˆ
    return cached.result;
  }
  
  if (!habit.calendar || habit.calendar.length === 0) {
    // ç¼“å­˜ç»“æœ
    const result = { streak: 0, startDate: null, endDate: null };
    longestStreakCache.set(cacheKey, {result, timestamp: Date.now()});
    return result;
  }
  
  // æŒ‰æ—¥æœŸæ’åºæ‰“å¡è®°å½•
  const sortedCalendar = [...habit.calendar]
    .filter(record => record.completed) // åªè€ƒè™‘å·²å®Œæˆçš„è®°å½•
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
  
  if (sortedCalendar.length === 0) {
    // ç¼“å­˜ç»“æœ
    const result = { streak: 0, startDate: null, endDate: null };
    longestStreakCache.set(cacheKey, {result, timestamp: Date.now()});
    return result;
  }
  
  let maxStreak = 0;
  let currentStreak = 0;
  let previousDate: Date | null = null;
  
  // è¿½è¸ªæœ€é•¿è¿ç»­åºåˆ—çš„èµ·å§‹å’Œç»“æŸæ—¥æœŸ
  let maxStreakStartDate: Date | null = null;
  let maxStreakEndDate: Date | null = null;
  
  // è¿½è¸ªå½“å‰è¿ç»­åºåˆ—çš„èµ·å§‹æ—¥æœŸ
  let currentStreakStartDate: Date | null = null;
  
  for (const record of sortedCalendar) {
    const currentDate = new Date(record.date);
    
    if (previousDate === null) {
      // ç¬¬ä¸€ä¸ªè®°å½•
      currentStreak = 1;
      currentStreakStartDate = new Date(currentDate);
    } else {
      // è®¡ç®—ä¸å‰ä¸€å¤©çš„å·®å€¼
      const diffDays = Math.floor((currentDate.getTime() - previousDate.getTime()) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 1) {
        // è¿ç»­çš„å¤©
        currentStreak++;
      } else if (diffDays > 1) {
        // ä¸­æ–­äº†ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æœ€å¤§è¿ç»­æ•°
        if (currentStreak > maxStreak) {
          maxStreak = currentStreak;
          maxStreakStartDate = currentStreakStartDate;
          // ç»“æŸæ—¥æœŸæ˜¯å‰ä¸€ä¸ªæ—¥æœŸ
          maxStreakEndDate = new Date(previousDate);
        }
        // é‡ç½®å½“å‰è¿ç»­æ•°
        currentStreak = 1;
        currentStreakStartDate = new Date(currentDate);
      }
      // å¦‚æœdiffDays === 0ï¼Œè¯´æ˜æ˜¯åŒä¸€å¤©ï¼Œä¸åšå¤„ç†
    }
    
    previousDate = currentDate;
  }
  
  // æ£€æŸ¥æœ€åä¸€ä¸ªè¿ç»­åºåˆ—
  if (currentStreak > maxStreak) {
    maxStreak = currentStreak;
    maxStreakStartDate = currentStreakStartDate;
    maxStreakEndDate = previousDate;
  } else if (maxStreak === 0 && currentStreak > 0) {
    // å¦‚æœæ•´ä¸ªåºåˆ—éƒ½æ˜¯è¿ç»­çš„
    maxStreak = currentStreak;
    maxStreakStartDate = currentStreakStartDate;
    maxStreakEndDate = previousDate;
  }
  
  // ç¼“å­˜ç»“æœ
  const result = {
    streak: maxStreak,
    startDate: maxStreakStartDate,
    endDate: maxStreakEndDate
  };
  longestStreakCache.set(cacheKey, {result, timestamp: Date.now()});
  
  return result;
};

// è®¡ç®—å¸¸è§æ‰“å¡æ—¶æ®µ
const calculateCommonTimeSlot = (habit: Habit) => {
  // ä»æ‰“å¡è®°å½•ä¸­æå–æ—¶é—´æˆ³ï¼Œåˆ†æå¸¸è§æ‰“å¡æ—¶æ®µ
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æ—¶é—´æˆ³æ•°æ®
  const completedRecordsWithTimestamp = habit.calendar.filter(record => record.completed && record.timestamp);
  
  if (completedRecordsWithTimestamp.length === 0) {
    return 'æœªæ‰“å¡';
  }
  
  // æå–å°æ—¶ä¿¡æ¯å¹¶ç»Ÿè®¡å„å°æ—¶çš„æ‰“å¡æ¬¡æ•°
  const hourCounts: { [key: number]: number } = {};
  
  for (const record of completedRecordsWithTimestamp) {
    if (record.timestamp) {
      const date = new Date(record.timestamp);
      const hour = date.getHours(); // è·å–å°æ—¶ï¼ˆ0-23ï¼‰
      hourCounts[hour] = (hourCounts[hour] || 0) + 1;
    }
  }
  
  // æ‰¾åˆ°æ‰“å¡æ¬¡æ•°æœ€å¤šçš„å°æ—¶
  let mostCommonHour = -1;
  let maxCount = 0;
  
  for (const hourStr in hourCounts) {
    const hour = parseInt(hourStr);
    const count = hourCounts[hour];
    
    if (count > maxCount) {
      maxCount = count;
      mostCommonHour = hour;
    }
  }
  
  if (mostCommonHour === -1) {
    return 'æœªæ‰“å¡';
  }
  
  // è¿”å›æ ¼å¼ä¸º "X~X+1ç‚¹" çš„æ—¶é—´æ®µï¼Œå…¶ä¸­"ç‚¹"å­—ç”¨spanåŒ…è£…
  return `${mostCommonHour}~${mostCommonHour + 1}<span style="font-size: 12px;"> ç‚¹</span>`;
};

// è·å–å°æ—¶åˆ†å¸ƒæ•°æ®ç”¨äºç»˜åˆ¶æ¡å½¢å›¾
const getHourDistribution = (habit: Habit) => {
  // ä»æ‰“å¡è®°å½•ä¸­æå–æ—¶é—´æˆ³ï¼Œåˆ†æå„å°æ—¶çš„æ‰“å¡åˆ†å¸ƒ
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æ—¶é—´æˆ³æ•°æ®
  const completedRecordsWithTimestamp = habit.calendar.filter(record => record.completed && record.timestamp);
  
  if (completedRecordsWithTimestamp.length === 0) {
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè¿”å›å…¨ä¸º0çš„åˆ†å¸ƒ
    const distribution = [];
    for (let i = 0; i < 24; i++) {
      distribution.push({ hour: i, count: 0 });
    }
    return distribution;
  }
  
  // æå–å°æ—¶ä¿¡æ¯å¹¶ç»Ÿè®¡å„å°æ—¶çš„æ‰“å¡æ¬¡æ•°
  const hourCounts: { [key: number]: number } = {};
  
  for (const record of completedRecordsWithTimestamp) {
    if (record.timestamp) {
      const date = new Date(record.timestamp);
      const hour = date.getHours(); // è·å–å°æ—¶ï¼ˆ0-23ï¼‰
      hourCounts[hour] = (hourCounts[hour] || 0) + 1;
    }
  }
  
  // ç”Ÿæˆ24å°æ—¶çš„åˆ†å¸ƒæ•°æ®
  const distribution = [];
  for (let i = 0; i < 24; i++) {
    distribution.push({ hour: i, count: hourCounts[i] || 0 });
  }
  
  return distribution;
};

// ç¼“å­˜å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨å„ç§è®¡ç®—ç»“æœ
const completionRateCache = new Map<string, {result: number, timestamp: number}>();
const weeklyCompletionCache = new Map<string, {result: boolean, timestamp: number}>();

// è®¡ç®—æ€»å®Œæˆç‡
const calculateTotalCompletionRate = (habit: Habit) => {
  // åˆ›å»ºç¼“å­˜é”®
  const cacheKey = `${habit.id}-completionRate-${Date.now() - (Date.now() % 86400000)}`; // åŒ…å«æ—¥æœŸä½†å¿½ç•¥æ—¶é—´
  
  // æ£€æŸ¥ç¼“å­˜ï¼ˆæ¯æ—¥é‡ç½®ï¼‰
  const cached = completionRateCache.get(cacheKey);
  if (cached && (Date.now() - cached.timestamp) < 86400000) { // ä¸€å¤©å†…æœ‰æ•ˆ
    return cached.result;
  }
  
  if (!habit.calendar || habit.calendar.length === 0) {
    // ç¼“å­˜ç»“æœ
    const result = 0;
    completionRateCache.set(cacheKey, {result, timestamp: Date.now()});
    return result;
  }
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºå‘¨é¢‘ç‡ä¹ æƒ¯
  if (habit.frequency.startsWith('weekly')) {
    // å¯¹äºå‘¨é¢‘ç‡ä¹ æƒ¯ï¼Œéœ€è¦æŒ‰å‘¨æ¥è®¡ç®—å®Œæˆç‡
    const result = calculateWeeklyHabitCompletionRate(habit);
    completionRateCache.set(cacheKey, {result, timestamp: Date.now()});
    return result;
  }
  
  // å¯¹äºéå‘¨é¢‘ç‡ä¹ æƒ¯ï¼Œè®¡ç®—æ‰“å¡å¤©æ•°/åˆ›å»ºå¤©æ•°*100%
  // ä½¿ç”¨reduceæ›¿ä»£å¾ªç¯æ¥è®¡ç®—å®Œæˆæ•°é‡ï¼Œæé«˜æ€§èƒ½
  const completedCount = habit.calendar.reduce((count, record) => record.completed ? count + 1 : count, 0);
  
  // è®¡ç®—ä»åˆ›å»ºæ—¥æœŸåˆ°ä»Šå¤©çš„æ€»å¤©æ•°
  const creationDate = new Date(habit.createdAt);
  const today = new Date();
  
  // è®¾ç½®æ—¶é—´ä¸º0ç‚¹0åˆ†0ç§’ï¼Œé¿å…æ—¶åŒºé—®é¢˜
  creationDate.setHours(0, 0, 0, 0);
  today.setHours(0, 0, 0, 0);
  
  // è®¡ç®—æ€»å¤©æ•°ï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰
  const totalDays = Math.floor((today.getTime() - creationDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
  
  if (totalDays <= 0) {
    const result = 0;
    completionRateCache.set(cacheKey, {result, timestamp: Date.now()});
    return result;
  }
  
  const rate = (completedCount / totalDays) * 100;
  const finalResult = Math.round(rate);
  
  // ç¼“å­˜ç»“æœ
  completionRateCache.set(cacheKey, {result: finalResult, timestamp: Date.now()});
  return finalResult;
};

// è®¡ç®—å‘¨é¢‘ç‡ä¹ æƒ¯çš„æ€»å®Œæˆç‡
const calculateWeeklyHabitCompletionRate = (habit: Habit) => {
  // è®¡ç®—ä»åˆ›å»ºæ—¥æœŸåˆ°ä»Šå¤©çš„å‘¨æ•°
  const creationDate = new Date(habit.createdAt);
  const today = new Date();
  
  // è®¾ç½®æ—¶é—´ä¸º0ç‚¹0åˆ†0ç§’ï¼Œé¿å…æ—¶åŒºé—®é¢˜
  creationDate.setHours(0, 0, 0, 0);
  today.setHours(0, 0, 0, 0);
  
  // è®¡ç®—åˆ›å»ºæ—¥æœŸæ‰€åœ¨å‘¨çš„å‘¨ä¸€
  const creationWeekday = creationDate.getDay();
  const daysToCreationMonday = creationWeekday === 0 ? -6 : 1 - creationWeekday; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦å‘å‰æ¨åˆ°å‘¨ä¸€
  const creationWeekStart = new Date(creationDate);
  creationWeekStart.setDate(creationDate.getDate() + daysToCreationMonday);
  
  // è®¡ç®—æœ¬å‘¨çš„å‘¨æ—¥ï¼ˆä»Šå¤©æ‰€åœ¨çš„å‘¨ï¼‰
  const currentTodayWeekday = today.getDay();
  const currentDaysToSunday = currentTodayWeekday === 0 ? 0 : 7 - currentTodayWeekday; // å¦‚æœä»Šå¤©æ˜¯å‘¨æ—¥ï¼Œåˆ™æ˜¯0å¤©å
  const currentWeekSunday = new Date(today);
  currentWeekSunday.setDate(today.getDate() + currentDaysToSunday);
  
  // è®¡ç®—éœ€è¦å¤„ç†çš„å‘¨æ•°
  const totalCalculatedWeeks = [];
  let tempWeekStart = new Date(creationWeekStart);
  
  // æ”¶é›†æ‰€æœ‰éœ€è¦æ£€æŸ¥çš„å‘¨ï¼Œä»åˆ›å»ºæ—¥æœŸæ‰€åœ¨å‘¨åˆ°æœ¬å‘¨å‘¨æ—¥
  while (tempWeekStart <= currentWeekSunday) {
    const tempWeekEnd = new Date(tempWeekStart);
    tempWeekEnd.setDate(tempWeekStart.getDate() + 6); // å‘¨æ—¥
    
    // ç¡®ä¿å‘¨çš„ç»“æŸæ—¥æœŸä¸è¶…è¿‡æœ¬å‘¨å‘¨æ—¥ï¼ˆé¿å…åŒ…å«æœªæ¥å‘¨ï¼‰
    if (tempWeekEnd > currentWeekSunday) {
      tempWeekEnd.setTime(currentWeekSunday.getTime());
    }
    
    // åªç»Ÿè®¡åˆ›å»ºæ—¥æœŸä¹‹åçš„å‘¨ï¼Œæ³¨æ„è¿™é‡Œåº”è¯¥æ˜¯åˆ¤æ–­å‘¨ç»“æŸæ—¥æœŸæ˜¯å¦æ™šäºåˆ›å»ºæ—¥æœŸ
    // å› ä¸ºä¸€å‘¨å†…çš„ä»»ä½•ä¸€å¤©å®Œæˆæ‰“å¡éƒ½åº”è®¡å…¥è¯¥å‘¨
    if (tempWeekEnd >= creationDate) {
      totalCalculatedWeeks.push({
        start: new Date(tempWeekStart),
        end: tempWeekEnd
      });
    }
    
    tempWeekStart.setDate(tempWeekStart.getDate() + 7); // ä¸‹ä¸€å‘¨
  }
  
  // è·å–æ¯å‘¨ç›®æ ‡æ¬¡æ•°
  let weeklyTarget = 1; // é»˜è®¤ä¸º1æ¬¡
  if (habit.frequency === 'weekly2') weeklyTarget = 2;
  else if (habit.frequency === 'weekly3') weeklyTarget = 3;
  else if (habit.frequency === 'weekly4') weeklyTarget = 4;
  else if (habit.frequency === 'weekly5') weeklyTarget = 5;
  else if (habit.frequency === 'weekly6') weeklyTarget = 6;
  
  // è®¡ç®—æ¯å‘¨çš„å®Œæˆæƒ…å†µ
  let completedWeeks = 0;
  
  // æ£€æŸ¥æ¯ä¸€å‘¨çš„å®Œæˆæƒ…å†µ
  for (const week of totalCalculatedWeeks) {
    // æ£€æŸ¥è¿™ä¸€å‘¨å†…æ˜¯å¦å®Œæˆäº†ç›®æ ‡æ¬¡æ•°
    let weekCompletedCount = 0;
    for (const record of habit.calendar) {
      const recordDate = new Date(record.date);
      // å°†è®°å½•æ—¥æœŸè®¾ç½®ä¸ºå½“å¤©çš„å¼€å§‹æ—¶é—´ï¼Œä»¥ç¡®ä¿æ­£ç¡®æ¯”è¾ƒ
      recordDate.setHours(0, 0, 0, 0);
      
      // æ£€æŸ¥è¿™ä¸ªè®°å½•æ˜¯å¦åœ¨å½“å‰å‘¨å†…
      if (recordDate >= week.start && recordDate <= week.end && record.completed) {
        weekCompletedCount += record.completedCount || 1;
      }
    }
    
    // å¦‚æœè¿™ä¸€å‘¨å®Œæˆäº†ç›®æ ‡æ¬¡æ•°ï¼Œåˆ™ç®—ä½œå®Œæˆä¸€å‘¨
    if (weekCompletedCount >= weeklyTarget) {
      completedWeeks++;
    }
  }
  
  const totalCalculatedWeeksCount = totalCalculatedWeeks.length;
  const rate = totalCalculatedWeeksCount > 0 ? (completedWeeks / totalCalculatedWeeksCount) * 100 : 0;
  return Math.round(rate);
};

// è®¡ç®—æ¡å½¢å›¾é«˜åº¦
const calculateBarHeight = (count: number) => {
  // æ ¹æ®æ‰“å¡æ¬¡æ•°è®¡ç®—æ¡å½¢å›¾é«˜åº¦ï¼Œæœ€å¤§é«˜åº¦è®¾ä¸º80%
  // å¦‚æœæ²¡æœ‰æ‰“å¡è®°å½•ï¼Œè¿”å›æœ€å°é«˜åº¦
  if (count <= 0) return 5;
  
  // æ‰¾åˆ°æ‰€æœ‰å°æ—¶ä¸­çš„æœ€å¤§æ‰“å¡æ¬¡æ•°
  const hourDistribution = getHourDistribution(selectedHabit.value);
  const maxCount = Math.max(...hourDistribution.map(h => h.count), 1);
  
  // è®¡ç®—ç›¸å¯¹é«˜åº¦ï¼Œæœ€å¤§ä¸º80%
  return Math.max(5, (count / maxCount) * 80);
};

// è·å–è¿‘18å‘¨çš„æ‰“å¡æ•°æ®ç”¨äºçƒ­åŠ›å›¾
const getHeatmapData = () => {
  // åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„æ¥å­˜å‚¨18å‘¨çš„æ•°æ®
  const heatmapData = [];
  
  // è·å–å½“å‰æ—¥æœŸ
  const today = new Date();
  
  // è®¡ç®—18å‘¨å‰çš„æ—¥æœŸï¼Œç¡®ä¿åŒ…å«æœ¬å‘¨
  const dayOfWeek = today.getDay();
  const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // å‘¨æ—¥(0)æ˜ å°„åˆ°6å¤©å‰ï¼Œå…¶ä»–æ—¥æœŸæ˜ å°„åˆ°ç›¸åº”å¤©æ•°å‰
  const thisMonday = new Date(today);
  thisMonday.setDate(today.getDate() - daysToSubtract);
  
  // ä»18å‘¨å‰çš„å‘¨ä¸€å¼€å§‹è®¡ç®—ï¼Œç¡®ä¿åŒ…å«æœ¬å‘¨
  const startDate = new Date(thisMonday);
  startDate.setDate(thisMonday.getDate() - 17 * 7); // 17å‘¨å‰çš„å‘¨ä¸€ï¼Œè¿™æ ·æ€»å…±åŒ…å«18å‘¨ï¼ˆå«æœ¬å‘¨ï¼‰
  
  // éå†æ‰€æœ‰ä¹ æƒ¯
  for (const habit of habits.value) {
    // éå†ä¹ æƒ¯çš„æ‰“å¡è®°å½•
    for (const record of habit.calendar) {
      if (record.completed) { // åªè€ƒè™‘å·²å®Œæˆçš„è®°å½•
        const recordDate = new Date(record.date);
        
        // æ£€æŸ¥è®°å½•æ˜¯å¦åœ¨18å‘¨èŒƒå›´å†…
        if (recordDate >= startDate && recordDate <= today) {
          // å°†æ—¥æœŸè½¬æ¢ä¸ºYYYY-MM-DDæ ¼å¼å­—ç¬¦ä¸²
          const dateStr = formatDate(recordDate);
          
          // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰è¯¥æ—¥æœŸçš„è®°å½•
          let dateEntry = heatmapData.find(entry => entry.date === dateStr);
          
          if (!dateEntry) {
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ›å»ºæ–°çš„æ—¥æœŸè®°å½•
            dateEntry = {
              date: dateStr,
              count: 0
            };
            heatmapData.push(dateEntry);
          }
          
          // å¢åŠ è¯¥æ—¥æœŸçš„æ‰“å¡æ¬¡æ•°
          dateEntry.count++;
        }
      }
    }
  }
  
  // æŒ‰æ—¥æœŸæ’åº
  heatmapData.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
  
  // è®¡ç®—æœ€å¤§æ‰“å¡æ¬¡æ•°ï¼ˆç”¨äºé¢œè‰²æ·±åº¦ï¼‰
  const maxCount = heatmapData.length > 0 ? Math.max(...heatmapData.map(d => d.count), 1) : 1;
  
  // è¿”å›çƒ­åŠ›å›¾æ•°æ®å’Œæœ€å¤§å€¼
  return {
    data: heatmapData,
    maxCount
  };
};

// è·å–çƒ­åŠ›å›¾çš„æ˜ŸæœŸå’Œæ—¥æœŸæ•°æ®
const getHeatmapGridData = () => {
  const today = new Date();
  
  // è®¡ç®—18å‘¨å‰çš„å¼€å§‹æ—¥æœŸï¼Œç¡®ä¿åŒ…å«æœ¬å‘¨
  // è®¡ç®—åˆ°æœ¬å‘¨å‘¨ä¸€çš„æ—¥æœŸï¼ˆç¡®ä¿åŒ…å«æœ¬å‘¨ï¼‰
  const dayOfWeek = today.getDay();
  const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // å‘¨æ—¥(0)æ˜ å°„åˆ°6å¤©å‰ï¼Œå…¶ä»–æ—¥æœŸæ˜ å°„åˆ°ç›¸åº”å¤©æ•°å‰
  const thisMonday = new Date(today);
  thisMonday.setDate(today.getDate() - daysToSubtract);
  
  // ä»18å‘¨å‰çš„å‘¨ä¸€å¼€å§‹è®¡ç®—
  const startMonday = new Date(thisMonday);
  startMonday.setDate(thisMonday.getDate() - 17 * 7); // 17å‘¨å‰çš„å‘¨ä¸€ï¼Œè¿™æ ·æ€»å…±åŒ…å«18å‘¨ï¼ˆå«æœ¬å‘¨ï¼‰
  
  // è·å–çƒ­åŠ›å›¾æ•°æ®
  const { data: heatmapData, maxCount } = getHeatmapData();
  
  // åˆ›å»ºä¸€ä¸ªæ˜ å°„ï¼Œä»¥ä¾¿å¿«é€ŸæŸ¥æ‰¾ç‰¹å®šæ—¥æœŸçš„æ‰“å¡æ¬¡æ•°
  const dateMap = {};
  heatmapData.forEach(item => {
    dateMap[item.date] = item.count;
  });
  
  // ç”Ÿæˆæ•°æ®ï¼šæŒ‰æ˜ŸæœŸç»„ç»‡ï¼Œæ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„æ˜ŸæœŸå‡ 
  const weeks = [[], [], [], [], [], [], []]; // æ¯ä¸ªæ•°ç»„ä»£è¡¨ä¸€ä¸ªæ˜ŸæœŸä¸­çš„æŸä¸€å¤©ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
  
  // è®¡ç®—ä»å¼€å§‹æ—¥æœŸåˆ°å½“å‰æ—¥æœŸçš„æ€»å¤©æ•°
  const totalDays = 18 * 7;
  let currentDate = new Date(startMonday);
  
  // ä¸ºæ¯ä¸€å¤©ç”Ÿæˆæ•°æ®
  for (let i = 0; i < totalDays; i++) {
    // è®¾ç½®ä¸ºå½“å¤©çš„å¼€å§‹æ—¶é—´ä»¥é¿å…æ—¶åŒºé—®é¢˜
    currentDate.setHours(0, 0, 0, 0);
    
    // ç”Ÿæˆæ—¥æœŸå­—ç¬¦ä¸²
    const dateStr = formatDate(currentDate);
    
    // è·å–å½“å¤©çš„æ‰“å¡æ¬¡æ•°
    const count = dateMap[dateStr] || 0;
    
    // è·å–æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­)
    const dayOfWeek = currentDate.getDay();
    // å°†å‘¨æ—¥(0)è½¬æ¢ä¸º6ï¼Œå‘¨ä¸€åˆ°å‘¨å…­åˆ†åˆ«æ˜¯1-6ï¼Œç„¶åæ˜ å°„åˆ°æ•°ç»„ç´¢å¼•0-6
    const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // å‘¨æ—¥(0)æ˜ å°„åˆ°ç´¢å¼•6ï¼Œå‘¨ä¸€(1)åˆ°å‘¨å…­(6)æ˜ å°„åˆ°ç´¢å¼•0-5
    
    // è®¡ç®—é¢œè‰²å¼ºåº¦ (0-4)
    let intensity = 0;
    if (maxCount > 0) {
      if (count === 0) {
        intensity = 0; // æ— æ‰“å¡
      } else if (count < maxCount * 0.25) {
        intensity = 1; // è½»å¾®æ‰“å¡
      } else if (count < maxCount * 0.5) {
        intensity = 2; // ä¸­ç­‰æ‰“å¡
      } else if (count < maxCount * 0.75) {
        intensity = 3; // é«˜åº¦æ‰“å¡
      } else {
        intensity = 4; // æœ€é«˜æ‰“å¡
      }
    }
    
    // å°†æ•°æ®æ·»åŠ åˆ°å¯¹åº”çš„æ˜ŸæœŸæ•°ç»„ä¸­
    weeks[dayIndex].push({
      date: dateStr,
      count: count,
      intensity: intensity,
      isCurrentYear: currentDate.getFullYear() === today.getFullYear()
    });
    
    // ç§»åŠ¨åˆ°ä¸‹ä¸€å¤©
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  // é‡æ–°ç»„ç»‡æ•°æ®ï¼šweeksç°åœ¨æ˜¯ä¸€ä¸ªåŒ…å«7ä¸ªæ•°ç»„çš„æ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„ä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„æ˜ŸæœŸå‡ 
  // weeks[0] = å‘¨ä¸€æ•°æ®, weeks[1] = å‘¨äºŒæ•°æ®, ..., weeks[6] = å‘¨æ—¥æ•°æ®
  return {
    weeks,
    startDate: formatDate(startMonday),
    endDate: formatDate(currentDate),
    maxCount
  };
};

// è®¡ç®—æ€»ä¹ æƒ¯æ•°
const totalHabitsCount = computed(() => {
  return habits.value.length;
});

// è®¡ç®—æ€»å®Œæˆæ•°
const totalCompletionsCount = computed(() => {
  let total = 0;
  for (const habit of habits.value) {
    // ä½¿ç”¨reduceæ›¿ä»£filter+lengthï¼Œä¸€æ¬¡éå†å®Œæˆè®¡ç®—
    total += habit.calendar.reduce((count, record) => record.completed ? count + 1 : count, 0);
  }
  return total;
});

// è®¡ç®—æœ€é•¿è¿ç»­åšæŒå¤©æ•°
const longestStreak = computed(() => {
  let maxStreak = 0;
  
  for (const habit of habits.value) {
    // ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬çš„è®¡ç®—å‡½æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    const streakResult = calculateLongestStreak(habit);
    if (streakResult.streak > maxStreak) {
      maxStreak = streakResult.streak;
    }
  }
  
  return maxStreak;
});

// çƒ­åŠ›å›¾ç½‘æ ¼æ•°æ®
const heatmapGridData = computed(() => {
  return getHeatmapGridData();
});

// çƒ­åŠ›å›¾æœˆä»½æ ‡ç­¾
const heatmapMonths = computed(() => {
  const months = [];
  
  // ä»çƒ­åŠ›å›¾æ•°æ®ä¸­è·å–æœˆä»½ä¿¡æ¯
  const heatmapData = heatmapGridData.value;
  const weeks = heatmapData.weeks;
  

  
  // ç”±äºçƒ­åŠ›å›¾æ˜¯æ¨ªå‘å¸ƒå±€ï¼Œæ˜ŸæœŸä½œä¸ºYè½´ï¼Œæ—¥æœŸä½œä¸ºXè½´
  // weeksæ•°ç»„ä¸­æœ‰7ä¸ªå­æ•°ç»„ï¼Œæ¯ä¸ªå­æ•°ç»„ä»£è¡¨ä¸€ä¸ªæ˜ŸæœŸä¸­çš„æŸä¸€å¤©ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
  // æ¯ä¸ªå­æ•°ç»„ä¸­çš„å…ƒç´ æ˜¯æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„ï¼ˆä»è¿‡å»åˆ°ç°åœ¨ï¼‰
  
  // ä¸ºäº†æ­£ç¡®è®¡ç®—æœˆä»½æ ‡ç­¾çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“åœ¨Xè½´æ–¹å‘ä¸Šæ¯ä¸ªæœˆçš„èµ·å§‹æ—¥æœŸä½ç½®
  // å› ä¸ºXè½´æ˜¯æ—¶é—´è½´ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ‰€æœ‰æ—¥æœŸä¸­æ¯ä¸ªæœˆçš„é¦–æ¬¡å‡ºç°ä½ç½®
  
  // åˆ›å»ºä¸€ä¸ªæ˜ å°„æ¥å­˜å‚¨æ¯ä¸ªæ—¥æœŸåœ¨Xè½´ä¸Šçš„ä½ç½®
  const datePositions = new Map();
  
  // éå†çƒ­åŠ›å›¾æ•°æ®ï¼Œè®°å½•æ¯ä¸ªæ—¥æœŸåœ¨Xè½´ä¸Šçš„ä½ç½®
  // å¯¹äºæ¯ä¸ªæ˜ŸæœŸä¸­çš„æŸä¸€å¤©ï¼ˆæ¯”å¦‚æ‰€æœ‰å‘¨ä¸€ã€æ‰€æœ‰å‘¨äºŒç­‰ï¼‰ï¼Œå®ƒä»¬åœ¨Xè½´ä¸Šæ˜¯æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„
  for (let dayOfWeek = 0; dayOfWeek < weeks.length; dayOfWeek++) {
    const daysOfThisWeekday = weeks[dayOfWeek];
    
    for (let dateIndex = 0; dateIndex < daysOfThisWeekday.length; dateIndex++) {
      const day = daysOfThisWeekday[dateIndex];
      const date = new Date(day.date);
      const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
      
      // å¦‚æœè¿™ä¸ªæœˆä»½è¿˜æ²¡æœ‰è®°å½•ä½ç½®ï¼Œåˆ™è®°å½•è¿™ä¸ªæ—¥æœŸåœ¨Xè½´ä¸Šçš„ä½ç½®
      if (!datePositions.has(monthKey)) {
        // è¿™ä¸ªæ—¥æœŸåœ¨Xè½´ä¸Šçš„ä½ç½®æ˜¯ dateIndex
        datePositions.set(monthKey, {
          year: date.getFullYear(),
          month: date.getMonth(),
          position: dateIndex
        });
      }
    }
  }
  
  // å°†ä½ç½®æ˜ å°„è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰ä½ç½®æ’åº
  const sortedPositions = Array.from(datePositions.values()).sort((a, b) => a.position - b.position);
  
  // ä¸ºæ¯ä¸ªå”¯ä¸€çš„æœˆä»½åˆ›å»ºæ ‡ç­¾ï¼Œè·³è¿‡ç¬¬ä¸€ä¸ªæœˆ
  for (let i = 1; i < sortedPositions.length; i++) { // ä»ç´¢å¼•1å¼€å§‹ï¼Œè·³è¿‡ç¬¬ä¸€ä¸ªæœˆ
    const pos = sortedPositions[i];
    
    // ä½¿ç”¨ç›¸å¯¹ä½ç½®è®¡ç®—ï¼ŒåŸºäºæ•°ç»„é•¿åº¦
    // æ¯ä¸ªæ˜ŸæœŸæ•°ç»„çš„é•¿åº¦æ˜¯18ï¼ˆä»£è¡¨18å‘¨ï¼‰
    const totalPoints = 18; // æ¯ä¸ªæ˜ŸæœŸæ•°ç»„åŒ…å«18ä¸ªæ•°æ®ç‚¹ï¼ˆ18å‘¨ï¼‰
    
    // è®¡ç®—ç›¸å¯¹ä½ç½®ï¼Œè€ƒè™‘åˆ°éœ€è¦åœ¨æ—¥æœŸæ ¼å­çš„ä¸­å¿ƒæ˜¾ç¤ºæœˆä»½æ ‡ç­¾
    const relativePosition = pos.position / (totalPoints - 1); // å½’ä¸€åŒ–åˆ°0-1èŒƒå›´
    
    // è½¬æ¢ä¸ºç™¾åˆ†æ¯”
    const offset = relativePosition * 100; // ç™¾åˆ†æ¯”å½¢å¼
    
    months.push({
      monthLabel: `${String(pos.month + 1).padStart(2, '0')}æœˆ`,
      offset: offset // è¿™ä¸ªå€¼å°†ç”¨ä½œç™¾åˆ†æ¯”
    });
  }
  
  return months;
});


// åˆå§‹åŒ–ä¹ æƒ¯è§†å›¾æ¨¡å¼
const initializeHabitViewMode = (habit: Habit) => {
  if (habit.currentWeekOffset === undefined) {
    habit.currentWeekOffset = 0;
  }
};

// åˆå§‹åŒ–ç»Ÿè®¡é¡µé¢è§†å›¾æ¨¡å¼
const initializeStatsViewMode = (habit: Habit) => {
  if (!habit.statsViewMode) {
    habit.statsViewMode = 'month'; // ç»Ÿè®¡é¡µé¢é»˜è®¤ä¸ºæœˆè§†å›¾
  }
  if (habit.statsMonthOffset === undefined) {
    habit.statsMonthOffset = 0;
  }

};

// è·å–æ—¥å†è§†å›¾æ•°æ®ï¼ˆç”¨äºä¹ æƒ¯é¡¹ï¼Œå›ºå®šä¸ºå‘¨è§†å›¾ï¼‰
const getCalendarViewData = (habit: Habit) => {
  initializeHabitViewMode(habit);
  
  // ç›´æ¥ä½¿ç”¨å½“å‰æ—¥æœŸï¼Œç¡®ä¿è·å–æœ€æ–°çš„æ—¥æœŸ
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  
  return getWeekViewData(habit);
};

// è·å–å‘¨è§†å›¾æ•°æ®
const getWeekViewData = (habit: Habit) => {
  const todayDate = new Date();
  const targetDate = new Date(todayDate);
  targetDate.setDate(todayDate.getDate() + (habit.currentWeekOffset || 0) * 7);
  
  // æ‰¾åˆ°è¿™ä¸€å‘¨çš„å¼€å§‹ï¼ˆå‘¨ä¸€ï¼‰
  const startOfWeek = getWeekStart(targetDate);
  
  // è®¡ç®—æœ¬å‘¨å®Œæˆæƒ…å†µ
  const weekCompletionData = getWeekCompletionData(habit, startOfWeek);
  
  // ç”Ÿæˆä¸€å‘¨çš„æ•°æ®ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
  const weekData = [];
  
  for (let i = 0; i < 7; i++) {
    const currentDate = new Date(startOfWeek);
    currentDate.setDate(startOfWeek.getDate() + i);
    
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
    const dateStr = formatDate(currentDate);
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è¿›è¡Œæ¯”è¾ƒ
    const isTodayActual = isToday(dateStr);
    
    // æŸ¥æ‰¾å¯¹åº”çš„æ‰“å¡è®°å½•
    const calendarRecord = habit.calendar.find(day => day.date === dateStr);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è¿‡å»çš„æ—¥æœŸï¼ˆä»Šå¤©ä¹‹å‰çš„æ—¥æœŸï¼‰
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ¯”è¾ƒï¼Œé¿å…æ—¶åŒºé—®é¢˜
    const todayLocalDateStr = getToday();
    const isPast = dateStr < todayLocalDateStr;
    // æ£€æŸ¥æ˜¯å¦æ˜¯æœªæ¥çš„æ—¥æœŸï¼ˆä»Šå¤©ä¹‹åçš„æ—¥æœŸï¼‰
    const isFuture = dateStr > todayLocalDateStr;
    
    // å¯¹äºweeklyNä¹ æƒ¯ï¼Œå¦‚æœæœ¬å‘¨å·²ç»å®Œæˆæ‰€éœ€çš„æ‰“å¡æ¬¡æ•°ï¼Œåˆ™æ‰€æœ‰æ—¥æœŸéƒ½æ˜¾ç¤ºä¸ºå®ŒæˆçŠ¶æ€
    const actualCompleted = calendarRecord ? calendarRecord.completed : false;
    const isCompleted = weekCompletionData.hasCompletedRequiredThisWeek ? true : actualCompleted;
    // æ ‡è¯†æ˜¯å¦å› ä¸ºå‘¨é¢‘æ¬¡é€»è¾‘è€Œæ˜¾ç¤ºä¸ºå®Œæˆï¼ˆè€Œéå®é™…å®Œæˆå½“å¤©ä»»åŠ¡ï¼‰
    const isCompletedByWeeklyRule = weekCompletionData.hasCompletedRequiredThisWeek && !actualCompleted;
    
    weekData.push({
      date: dateStr,
      completed: isCompleted,
      completedCount: calendarRecord ? calendarRecord.completedCount || 0 : 0,
      targetCount: calendarRecord ? calendarRecord.targetCount || 1 : 1,
      isPast,
      isFuture,
      isToday: isTodayActual,
      isCompletedByWeeklyRule
    });
  }
  
  return weekData;
};

// é€šç”¨çš„æœˆä»½æ•°æ®ç”Ÿæˆå‡½æ•°
const generateMonthViewData = (targetDate: Date, calendarData?: any[], moodData?: any) => {
  // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
  const firstDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
  const lastDay = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0);

  // è®¡ç®—å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­)
  const prevMonthDays = calculatePrevMonthDays(firstDay);

  // è®¡ç®—éœ€è¦æ˜¾ç¤ºçš„æ€»å¤©æ•°ï¼ˆæœ€å¤š5è¡Œ7åˆ—ï¼‰
  const daysInMonth = lastDay.getDate();
  const daysNeeded = 35; // 5è¡Œ7åˆ—

  const monthData = [];

  // é¢„è®¡ç®—å¹´ä»½å’Œæœˆä»½ï¼Œé¿å…é‡å¤è®¿é—®
  const targetYear = targetDate.getFullYear();
  const targetMonth = targetDate.getMonth();

  // é€šç”¨å‡½æ•°ï¼šæ ¹æ®æ—¥æœŸè·å–æ•°æ®
  const getDayData = (date: Date) => {
    const dateStr = formatDate(date);
    let dayData;
    if (calendarData !== undefined) {
      // å¤„ç†æ‰“å¡æ—¥å†æ•°æ®
      dayData = calendarData.find(day => day.date === dateStr);
    } else if (moodData !== undefined) {
      // å¤„ç†æƒ…ç»ªæ—¥å†æ•°æ®
      dayData = moodData[dateStr];
    } else {
      // ä»…è¿”å›æ—¥æœŸä¿¡æ¯
      dayData = null;
    }
    
    // æ›´ç²¾ç¡®åœ°åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æœˆ
    const isCurrentMonth = (date.getMonth() === targetDate.getMonth() && 
                          date.getFullYear() === targetDate.getFullYear());
    
    return {
      date: dateStr,
      data: dayData || null,
      isCurrentMonth: isCurrentMonth,
      isToday: dateStr === getToday()
    };
  };

  // æ·»åŠ ä¸Šä¸ªæœˆçš„æ—¥æœŸ
  for (let i = prevMonthDays; i > 0; i--) {
    const date = new Date(targetYear, targetMonth, -i + 1);
    monthData.push(getDayData(date));
  }

  // æ·»åŠ å½“å‰æœˆçš„æ—¥æœŸ
  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(targetYear, targetMonth, i);
    monthData.push(getDayData(date));
  }

  // æ·»åŠ ä¸‹ä¸ªæœˆçš„æ—¥æœŸä»¥å¡«æ»¡ç½‘æ ¼
  const remainingDays = daysNeeded - monthData.length;
  for (let i = 1; i <= remainingDays; i++) {
    const date = new Date(targetYear, targetMonth + 1, i);
    monthData.push(getDayData(date));
  }

  return monthData;
};

// è·å–ç»Ÿè®¡é¡µé¢æœˆè§†å›¾æ•°æ®
const getStatsMonthViewData = (habit: Habit) => {
  initializeStatsViewMode(habit);
  const today = new Date();
  const targetDate = new Date(today.getFullYear(), today.getMonth() + (habit.statsMonthOffset || 0), 1);

  // ä½¿ç”¨é€šç”¨çš„æœˆä»½æ•°æ®ç”Ÿæˆå‡½æ•°
  const rawData = generateMonthViewData(targetDate, habit.calendar);
  
  // æ ¼å¼åŒ–ä¸ºç»Ÿè®¡é¡µé¢éœ€è¦çš„æ ¼å¼
  return rawData.map(item => ({
    date: item.date,
    completed: item.data ? item.data.completed : false,
    completedCount: item.data ? (item.data.completedCount || 0) : 0,
    targetCount: item.data ? (item.data.targetCount || 1) : 1,
    isCurrentMonth: item.isCurrentMonth
  }));
};

// æ›´æ”¹ç»Ÿè®¡é¡µé¢æ—¥å†æ—¶é—´æ®µ
const changeStatsCalendarPeriod = (habit: Habit, direction: number) => {
  initializeStatsViewMode(habit);
  
  habit.statsMonthOffset = (habit.statsMonthOffset || 0) + direction;
};

// è·å–å½“å‰æ—¶é—´æ®µæ–‡æœ¬
const getCurrentPeriodText = (habit: Habit) => {
  initializeStatsViewMode(habit);
  
  const today = new Date();
  const targetDate = new Date(today.getFullYear(), today.getMonth() + (habit.statsMonthOffset || 0), 1);
  
  const year = targetDate.getFullYear();
  const month = targetDate.getMonth() + 1;
  
  // æœˆä»½å§‹ç»ˆä½¿ç”¨é˜¿æ‹‰ä¼¯æ•°å­—
  return `${year}å¹´${month}æœˆ`;
};



// å½“å‰é€‰ä¸­çš„ä¹ æƒ¯
const selectedHabit = ref<Habit | null>(null);

// é€‰ä¸­ä¹ æƒ¯çš„æœ€é•¿è¿ç»­æ‰“å¡ - ç¼“å­˜è®¡ç®—ç»“æœé¿å…é‡å¤è®¡ç®—
const selectedHabitLongestStreak = computed(() =>
  selectedHabit.value ? calculateLongestStreak(selectedHabit.value) : { streak: 0, startDate: null, endDate: null }
);


// å½“å¤©æ—¥å†ç›¸å…³
const currentDayInfo = ref({
  // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼è€Œä¸æ˜¯toISOString()ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
  date: formatDate(new Date()),
  dayOfWeek: new Date().getDay(),
  dayOfMonth: new Date().getDate(),
  month: new Date().getMonth() + 1,
  year: new Date().getFullYear(),
});

// æ˜ŸæœŸåç§°æ•°ç»„ï¼Œæ”¯æŒå›½é™…åŒ–
const weekdaysForCalendar = computed(() => {
  // é»˜è®¤ä½¿ç”¨ä¸­æ–‡ï¼Œæ ¹æ®å½“å‰è¯­è¨€ç¯å¢ƒè¿”å›ç›¸åº”çš„æ˜ŸæœŸåç§°
  if (window.siyuan?.languages?.zh_CN) {
    return ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
  } else {
    // é»˜è®¤ä½¿ç”¨ä¸­æ–‡
    return ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
  }
});



// è®¡ç®—å½“æœˆç¬¬ä¸€å¤©å‰éœ€è¦æ˜¾ç¤ºçš„å¤©æ•°
const calculatePrevMonthDays = (firstDay: Date) => {
  // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­)
  const dayOfWeek = firstDay.getDay();
  // è®¡ç®—å‰é¢éœ€è¦å¤šå°‘å¤©æ¥è‡ªä¸Šä¸ªæœˆ
  // ä¸ºäº†è®©æ—¥æœŸæ­£ç¡®å¯¹åº”åˆ°æ˜ŸæœŸæ ‡é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—æ­£ç¡®çš„åç§»é‡
  // æ˜ŸæœŸä¸€(1) â†’ 0å¤©åç§», æ˜ŸæœŸäºŒ(2) â†’ 1å¤©åç§», ..., æ˜ŸæœŸæ—¥(0) â†’ 6å¤©åç§»
  return dayOfWeek === 0 ? 6 : dayOfWeek - 1;
};

// è®¡ç®—å½“å‰æ—¥æœŸå­—ç¬¦ä¸²
const currentDateString = computed(() => {
  const date = new Date(); // ç›´æ¥è·å–å½“å‰æ—¥æœŸï¼Œè€Œä¸æ˜¯ä½¿ç”¨currentDayInfo
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  return `${month}/${day}/å‘¨${weekdays[date.getDay()]}`;
});

// è·å–ä¹ æƒ¯æ‰“å¡é¢‘ç‡çš„æ–‡æœ¬æè¿°
const getFrequencyText = (habit: Habit) => {
  if (!habit.frequency) return 'æ¯å¤©';
  if (habit.frequency === 'daily') return 'æ¯å¤©';
  if (habit.frequency === 'weekly') return 'æ¯å‘¨1å¤©';
  if (habit.frequency === 'weekly1') return 'æ¯å‘¨1å¤©';
  if (habit.frequency === 'weekly2') return 'æ¯å‘¨2å¤©';
  if (habit.frequency === 'weekly3') return 'æ¯å‘¨3å¤©';
  if (habit.frequency === 'weekly4') return 'æ¯å‘¨4å¤©';
  if (habit.frequency === 'weekly5') return 'æ¯å‘¨5å¤©';
  if (habit.frequency === 'weekly6') return 'æ¯å‘¨6å¤©';
  // æ£€æŸ¥æ˜¯å¦å­˜åœ¨customFrequencyå±æ€§
  if (habit.frequency === 'custom' && 'customFrequency' in habit && habit.customFrequency) {
    return `æ¯å‘¨${habit.customFrequency}å¤©`;
  }
  return 'æ¯å¤©'; // é»˜è®¤
};

// è·å–ä¹ æƒ¯åˆ›å»ºæ—¥æœŸçš„æ–‡æœ¬æè¿°
const getCreatedDateText = (habit: Habit) => {
  if (!habit.createdAt) return '';
  const date = new Date(habit.createdAt);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `åˆ›å»ºäº ${year}-${month}-${day}`;
};

// æ˜¾ç¤ºä¹ æƒ¯ç»Ÿè®¡é¡µé¢
const showHabitStats = (habit: Habit) => {
  selectedHabit.value = habit;
};

// æ˜¾ç¤ºç¼–è¾‘ä¹ æƒ¯æ¨¡æ€æ¡†
const showEditHabitModal = ref(false);
const editedHabit = ref<Habit | null>(null);

// æ‰“å¼€ç¼–è¾‘ä¹ æƒ¯æ¨¡æ€æ¡†
const openEditHabitModal = () => {
  if (selectedHabit.value) {
    // åˆ›å»ºä¹ æƒ¯çš„å‰¯æœ¬ä»¥é¿å…ç›´æ¥ä¿®æ”¹åŸå¯¹è±¡
    editedHabit.value = JSON.parse(JSON.stringify(selectedHabit.value));
    showEditHabitModal.value = true;
  }
};

// å…³é—­ç¼–è¾‘ä¹ æƒ¯æ¨¡æ€æ¡†
const closeEditHabitModal = () => {
  showEditHabitModal.value = false;
  editedHabit.value = null;
};

// ä¸ºç¼–è¾‘ä¹ æƒ¯é€‰æ‹©emoji
const selectEmojiForEdit = (emoji: string) => {
  if (editedHabit.value) {
    editedHabit.value.emoji = emoji;
    showEmojiPicker.value = false;
  }
};

// å¤„ç†timesPerDayå˜æ›´
const onTimesPerDayChange = (value: string | number) => {
  if (editedHabit.value) {
    editedHabit.value.timesPerDay = typeof value === 'string' ? parseInt(value) || 1 : value;
  }
};

// ä¿å­˜ç¼–è¾‘åçš„ä¹ æƒ¯
const saveEditedHabit = async () => {
  if (editedHabit.value && selectedHabit.value) {
    // ç¡®ä¿timesPerDayæ˜¯æ•°å­—ç±»å‹
    if (typeof editedHabit.value.timesPerDay === 'string') {
      editedHabit.value.timesPerDay = parseInt(editedHabit.value.timesPerDay) || 1;
    }
    
    // æ›´æ–°åŸå§‹ä¹ æƒ¯å¯¹è±¡
    Object.assign(selectedHabit.value, editedHabit.value);
    
    // ä¿å­˜åˆ°å­˜å‚¨
    await immediateSaveHabits(habits.value);
    
    // å…³é—­æ¨¡æ€æ¡†
    closeEditHabitModal();
  }
};

// æš‚åœæˆ–æ¢å¤ä¹ æƒ¯æ‰“å¡
const togglePauseHabit = async (habit: Habit) => {
  if (habit) {
    // åˆ‡æ¢æš‚åœçŠ¶æ€
    habit.isPaused = !habit.isPaused;
    
    // ä¿å­˜åˆ°å­˜å‚¨
    await immediateSaveHabits(habits.value);
  }
};

// å…³é—­ç»Ÿè®¡é¡µé¢
const closeHabitStats = () => {
  selectedHabit.value = null;
};

// æƒ…ç»ªæ•°æ®
const moodData = ref<MoodData>({});

// æƒ…ç»ªæ‰“å¡ç›¸å…³
const showMoodTracker = ref(false);
const selectedDate = ref('');
const moodEntry = ref({
  emoji: '',
  note: ''
});

// è‡ªå®šä¹‰æç¤ºæ¡†ç›¸å…³
const tooltipVisible = ref(false);
const tooltipContent = ref('');
const tooltipStyle = ref({
  top: '0px',
  left: '0px'
});

// æ‰“å¼€æƒ…ç»ªæ‰“å¡é¢æ¿
const openMoodTracker = async (date: string) => {
  selectedDate.value = date;
  // å°è¯•åŠ è½½å·²ä¿å­˜çš„æƒ…ç»ªæ•°æ®
  const moodData = await getMoodData();
  const dateEntry = moodData[date];
  if (dateEntry) {
    moodEntry.value = {
      emoji: dateEntry.emoji || '',
      note: dateEntry.note || ''
    };
  } else {
    moodEntry.value = {
      emoji: '',
      note: ''
    };
  }
  showMoodTracker.value = true;
};

// ä¿å­˜æƒ…ç»ªæ‰“å¡æ•°æ®
const saveMoodEntry = async () => {
  try {
    // è·å–ç°æœ‰çš„æƒ…ç»ªæ•°æ®
    const moodDataLocal = await getMoodData();
    
    // æ›´æ–°å½“å‰æ—¥æœŸçš„æƒ…ç»ªæ•°æ®
    moodDataLocal[selectedDate.value] = {
      emoji: moodEntry.value.emoji,
      note: moodEntry.value.note,
      timestamp: new Date().toISOString()
    };
    
    // ä¿å­˜åˆ°æ’ä»¶æ•°æ®
    await saveMoodData(moodDataLocal);
    
    // æ›´æ–°æœ¬åœ°æƒ…ç»ªæ•°æ®ç¼“å­˜
    moodData.value = moodDataLocal;
    
    // å…³é—­é¢æ¿
    showMoodTracker.value = false;
    

  } catch (error) {
    console.error('ä¿å­˜æƒ…ç»ªæ•°æ®å¤±è´¥:', error);
  }
};

// åˆ é™¤æƒ…ç»ªæ‰“å¡æ•°æ®
const deleteMoodEntry = async () => {
  if (selectedDate.value) {
    try {
      // è·å–ç°æœ‰çš„æƒ…ç»ªæ•°æ®
      const moodDataLocal = await getMoodData();
      
      // åˆ é™¤å½“å‰æ—¥æœŸçš„æƒ…ç»ªæ•°æ®
      delete moodDataLocal[selectedDate.value];
      
      // ä¿å­˜åˆ°æ’ä»¶æ•°æ®
      await saveMoodData(moodDataLocal);
      
      // æ›´æ–°æœ¬åœ°æƒ…ç»ªæ•°æ®ç¼“å­˜
      moodData.value = moodDataLocal;
      
      // å…³é—­é¢æ¿
      showMoodTracker.value = false;
      

    } catch (error) {
      console.error('åˆ é™¤æƒ…ç»ªæ•°æ®å¤±è´¥:', error);
    }
  }
};

// å…³é—­æƒ…ç»ªæ‰“å¡é¢æ¿
const closeMoodTracker = () => {
  showMoodTracker.value = false;
  moodEntry.value = {
    emoji: '',
    note: ''
  };
};

// é€‰æ‹©æƒ…ç»ªemoji
const selectMoodEmoji = (emoji: string) => {
  moodEntry.value.emoji = emoji;
  showEmojiPicker.value = false;
};

// æƒ…ç»ªæ‰“å¡æœˆè§†å›¾ç›¸å…³
const moodCalendarCurrentMonth = ref(0); // æœˆåç§»é‡ï¼Œ0è¡¨ç¤ºå½“å‰æœˆï¼Œæ­£æ•°è¡¨ç¤ºæœªæ¥æœˆï¼Œè´Ÿæ•°è¡¨ç¤ºè¿‡å»æœˆ

// è®¡ç®—æƒ…ç»ªæ‰“å¡æœˆè§†å›¾çš„æœˆä»½å¹´ä»½æ˜¾ç¤º
const moodCalendarMonthYear = computed(() => {
  const today = new Date();
  const targetDate = new Date(today.getFullYear(), today.getMonth() + moodCalendarCurrentMonth.value, 1);
  return `${targetDate.getFullYear()}å¹´${targetDate.getMonth() + 1}æœˆ`;
});

// è®¡ç®—æƒ…ç»ªç»Ÿè®¡æ•°æ®
const moodStatsData = computed(() => {
  const today = new Date();
  const targetDate = new Date(today.getFullYear(), today.getMonth() + moodCalendarCurrentMonth.value, 1);
  const currentYear = targetDate.getFullYear();
  const currentMonth = targetDate.getMonth();
  
  // åˆå§‹åŒ–æƒ…ç»ªç»Ÿè®¡æ•°æ®
  const stats = {
    excited: 0,
    happy: 0,
    calm: 0,
    sad: 0,
    angry: 0
  };
  
  // éå†æƒ…ç»ªæ•°æ®ï¼Œç»Ÿè®¡å½“å‰æœˆä»½çš„å„ç±»æƒ…ç»ªæ•°é‡
  for (const [dateStr, mood] of Object.entries(moodData.value)) {
    const [year, month] = dateStr.split('-').map(Number);
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰æœˆä»½
    if (year === currentYear && month - 1 === currentMonth) {
      // æ ¹æ®æƒ…ç»ªemojiåŒ¹é…ç±»å‹å¹¶è®¡æ•°
      if (mood.emoji === 'ğŸ¤©') {
        stats.excited++;
      } else if (mood.emoji === 'ğŸ˜Š') {
        stats.happy++;
      } else if (mood.emoji === 'ğŸ˜Œ') {
        stats.calm++;
      } else if (mood.emoji === 'ğŸ˜¢') {
        stats.sad++;
      } else if (mood.emoji === 'ğŸ˜¡') {
        stats.angry++;
      }
    }
  }
  
  // è®¡ç®—æœ€å¤§å€¼ç”¨äºæŸ±çŠ¶å›¾é«˜åº¦æ¯”ä¾‹
  const maxValue = Math.max(...Object.values(stats), 1);
  
  return {
    data: [
      { type: 'excited', count: stats.excited, emoji: 'ğŸ¤©', label: 'å…´å¥‹' },
      { type: 'happy', count: stats.happy, emoji: 'ğŸ˜Š', label: 'å¼€å¿ƒ' },
      { type: 'calm', count: stats.calm, emoji: 'ğŸ˜Œ', label: 'å¹³é™' },
      { type: 'sad', count: stats.sad, emoji: 'ğŸ˜¢', label: 'éš¾è¿‡' },
      { type: 'angry', count: stats.angry, emoji: 'ğŸ˜¡', label: 'æ„¤æ€’' }
    ],
    maxValue
  };
});

// è·å–æƒ…ç»ªæ‰“å¡æœˆè§†å›¾æ•°æ®
const moodCalendarData = computed(() => {
  const today = new Date();
  const targetDate = new Date(today.getFullYear(), today.getMonth() + moodCalendarCurrentMonth.value, 1);

  // ä½¿ç”¨é€šç”¨çš„æœˆä»½æ•°æ®ç”Ÿæˆå‡½æ•°
  const rawData = generateMonthViewData(targetDate, undefined, moodData.value);
  
  // æ ¼å¼åŒ–ä¸ºæƒ…ç»ªæ—¥å†éœ€è¦çš„æ ¼å¼
  return rawData.map(item => ({
    date: item.date,
    mood: item.data,
    isCurrentMonth: item.isCurrentMonth,
    isToday: item.isToday
  }));
});

// è·å–å½“å‰æœˆä»½çš„æƒ…ç»ªè®°å½•åˆ—è¡¨
const currentMonthMoodEntries = computed(() => {
  const today = new Date();
  const targetDate = new Date(today.getFullYear(), today.getMonth() + moodCalendarCurrentMonth.value, 1);
  const currentYear = targetDate.getFullYear();
  const currentMonth = targetDate.getMonth();
  
  // è¿‡æ»¤å‡ºå½“å‰æœˆä»½çš„æƒ…ç»ªè®°å½•
  const entries: { date: string; mood: { emoji: string; note: string } }[] = [];
  
  // é¿å…é‡å¤åˆ›å»ºDateå¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒ
  for (const [dateStr, mood] of Object.entries(moodData.value)) {
    // æå–å¹´æœˆéƒ¨åˆ†è¿›è¡Œæ¯”è¾ƒï¼Œé¿å…åˆ›å»ºDateå¯¹è±¡
    const [year, month] = dateStr.split('-').map(Number);
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰æœˆä»½
    if (year === currentYear && month - 1 === currentMonth) {
      entries.push({ date: dateStr, mood });
    }
  }
  
  // æŒ‰æ—¥æœŸæ’åºï¼ˆä»æ–°åˆ°æ—§ï¼‰
  entries.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
  
  return entries;
});

// åˆ‡æ¢æƒ…ç»ªæ‰“å¡æœˆè§†å›¾çš„æœˆä»½
const changeMoodCalendarMonth = (offset: number) => {
  moodCalendarCurrentMonth.value += offset;
};

// æ˜¾ç¤ºè‡ªå®šä¹‰æç¤ºæ¡†
const showCustomTooltip = (date: string, event: MouseEvent) => {
  const moodEntry = moodData.value[date];
  if (moodEntry && moodEntry.note) {
    tooltipContent.value = moodEntry.note;
    tooltipVisible.value = true;
    
    // è®¾ç½®æç¤ºæ¡†ä½ç½®ï¼Œç›¸å¯¹äºé¼ æ ‡ä½ç½®
    const tooltipX = event.clientX + 10;
    const tooltipY = event.clientY - 0;
    
    tooltipStyle.value = {
      top: `${tooltipY}px`,
      left: `${tooltipX}px`
    };
  }
};

// éšè—è‡ªå®šä¹‰æç¤ºæ¡†
const hideCustomTooltip = () => {
  tooltipVisible.value = false;
  tooltipContent.value = '';
};

// åˆ‡æ¢ç»Ÿè®¡é¡µé¢è§†å›¾æ¨¡å¼ï¼ˆå·²ç§»é™¤ï¼Œç»Ÿè®¡é¡µé¢åªæ˜¾ç¤ºæœˆè§†å›¾ï¼‰
// const toggleStatsViewMode = (habit: Habit) => {
//   initializeStatsViewMode(habit);
//   habit.statsViewMode = habit.statsViewMode === 'month' ? 'week' : 'month';
// };
</script>

<style lang="scss" scoped>
.Pinch-habit-container {
  width: 100%;
  height: 100%;
  box-sizing: border-box;
  overflow-y: auto;
  padding: 4px;
  
  .Pinch-habit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    
    h2 {
      margin: 0;
      color: var(--b3-theme-on-background);
    }
    
    .icon {
      margin-right: 4px;
      vertical-align: middle;
      width: 16px;
      height: 16px;
    }
    
    #add-habit-btn,#stats-btn,#mood-calendar-btn {
      background: none;
      border: none;
      padding: 0;
      margin: 0 6px 0 0;
      cursor: pointer;
      width: 26px;
      height: 26px;
      
      svg {
        color: var(--b3-theme-on-background);
        width: 26px;
        height: 26px;
      }
    }
  }
  
  .habit-list {
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--b3-font-color1);
      font-size: 16px;
    }
    
    .habits-grid {
      display: grid;
      gap: 8px;
    }
    
    .habits-container {
      display: contents;
    }
    
    .habit-card {
      background: var(--b3-theme-background);
      border-radius: 15px;
      box-shadow: rgba(0, 0, 0, 0.06) 0px 1px 5px 0px;
      
      .habit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        
        .habit-title {
          font-size: 16px;
          font-weight: bold;
          color: var(--b3-theme-on-background);
          flex: 1;
          margin-left: 2px;
        }
        
        .habit-actions {
          display: flex;
          gap: 8px;
        }
      }
      
      .habit-stats {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--b3-border-color);
        
        .stats-item {
          text-align: center;
          
          .stat-label {
            display: block;
            font-size: 10px;
            color: var(--b3-scroll-color);
          }
          
          .stat-value {
            display: block;
            font-weight: bold;
            color: var(--b3-theme-on-background);
          }
        }
      }
      
      .habit-calendar {
        .calendar-controls {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          
          .view-selector {
            display: flex;
            gap: 4px;
            
            .view-btn {
              padding: 4px 8px;
              border: 1px solid var(--b3-border-color);
              background-color: var(--b3-list-background);
              color: var(--b3-font-color1);
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
              
              &.active {
                background-color: var(--b3-theme-primary);
                color: var(--b3-theme-on-primary);
                border-color: var(--b3-theme-primary);
              }
              
              &:hover {
                background-color: var(--b3-list-hover);
              }
            }
          }
          
          .calendar-navigation {
            display: flex;
            align-items: center;
            gap: 8px;
            
            .nav-btn {
              padding: 2px 6px;
              border: 1px solid var(--b3-border-color);
              background-color: var(--b3-list-background);
              color: var(--b3-font-color1);
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
              
              &:hover {
                background-color: var(--b3-list-hover);
              }
            }
            
            .current-period {
              font-size: 12px;
              color: var(--b3-font-color1);
              min-width: 120px;
              text-align: center;
            }
          }
        }
        
        .calendar-weekdays {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          text-align: center;
          font-size: 12px;
          color: var(--b3-font-color1);
          margin-bottom: 4px;
        }
        
        .calendar-days {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 2px;
          
          .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 12px;
            background-color: var(--b3-list-background);
            color: var(--b3-font-color1);
            
            &.completed {
              background-color: var(--b3-success-background);
              color: var(--b3-success-text);
            }
            
            &.today {
              border: 2px solid var(--b3-theme-primary);
            }
            
            .day-number {
              font-size: 14px;
            }
          }
        }
      }
    }
    
    .habit-card.completed {
      box-shadow: inset 0 0 0 100px rgba(0, 0, 0, 0.03), rgba(0, 0, 0, 0.06) 0px 1px 5px 0px;
    }
    
    .habit-card.paused {
      background-image: repeating-linear-gradient(-45deg, var(--b3-border-color), var(--b3-border-color) 5px, var(--b3-list-hover) 0, var(--b3-list-hover) 10px);
      background-color: var(--b3-list-background);
      opacity: 0.7;
    }
  } 
  
  
}

.stats-panel {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 2;
  box-sizing: border-box;
  overflow-y: auto;
  display: flex;
  padding: 10px;
  flex-direction: column;
  --s: 20px; /* control the size*/
  --c1: #2a936a;
  --c2: #32a176;
  --_g: radial-gradient(calc(var(--s)/2),var(--c1) 97%,#0000);
  background:
    var(--_g),var(--_g) calc(2*var(--s)) calc(2*var(--s)),
    repeating-conic-gradient(from 45deg,#0000 0 25%,var(--c2) 0 50%) calc(-.707*var(--s)) calc(-.707*var(--s)),
    repeating-linear-gradient(135deg,var(--c1) calc(var(--s)/-2) calc(var(--s)/2),var(--c2) 0 calc(2.328*var(--s)));
  background-size: calc(4*var(--s)) calc(4*var(--s));
  
  /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
  -ms-overflow-style: none; /* IE å’Œ Edge */
  scrollbar-width: none; /* Firefox */
  
  &::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }
  
  .stats-header {
    display: flex;
    flex-direction: column;
    padding-bottom: 10px;
    
    .stats-emoji {
      font-size: 70px;
      align-self: center;
      height: 100px;
    }
    
    .habit-frequency {
      text-align: center;
      font-size: 10px;
      color: #fff;
      padding: 4px 10px;
      background-color: #21855e;
      border-radius: 12px;
    }
    
    .habit-created {
      text-align: center;
      font-size: 10px;
      color: #fff;
      padding: 4px 10px;
      background-color: #21855e;
      border-radius: 12px;
    }
    
    .habit-meta {
      display: flex;
      justify-content: center;
      gap: 10px;
      width: 100%;
    }
    
    .stats-header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 10px;
    }
    
    .stats-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--b3-theme-background);
    }
    
    .stats-header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
  }
  .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 34px;
      margin-top: 10px;
      padding: 10px 0;
      border-top: 1px solid var(--b3-border-color);
      
      .stat-item {
        text-align: center;
        border-radius: 24px;
        
        .stat-value {
          font-size: 24px;
          font-weight: 600;
          color: var(--b3-theme-on-background);
          margin-bottom: 4px;
          span {
            font-size: 12px;
          }
        }
        
        .stat-label {
          font-size: 12px;
          color: var(--b3-scroll-color);
        }
      }
    }
  .stats-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    
    .calendar-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
      padding: 8px;
      background: var(--b3-list-background);
      border-radius: 4px;
      
      .view-selector {
        display: flex;
        gap: 4px;
        
        .sy-button {
          min-width: 60px;
        }
      }
      
      .calendar-navigation {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        justify-content: center;
        
        .nav-btn {
          background: none;
          border: none;
          padding: 4px;
          cursor: pointer;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background-color 0.2s;
          
          &:hover {
            background-color: var(--b3-list-hover);
          }
          
          &:active {
            background-color: var(--b3-list-hover);
          }
        }
        
        .current-period {
          text-align: center;
          font-size: 14px;
          flex: 1;
          font-weight: 600;
        }
      }
    }
    
    .calendar-container {
      background-color: var(--b3-theme-background);
      padding: 16px 16px 8px 16px;
      border-radius: 24px;
      box-shadow: rgba(0, 0, 0, 0.06) 0px 1px 5px 0px;
    }

    .calendar-view {
      flex: 1;
      margin-bottom: 20px;
      
      .weekdays-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--b3-theme-on-surface);
        gap: 14px;
        font-size: 12px;
      }
      
      .week-view {
        .week-data {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 4px;
        }
      }
      
      .month-view {
        .month-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 14px;
        }
      }
      
      .day {
        position: relative;
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--b3-list-background);
        cursor: default;
        font-weight: 600;
        transition: background-color 0.2s;
        
        &.completed {
          background: #f98f7a;
          color: var(--b3-theme-background);
          font-weight: bold;
        }
        
        &.today:not(.completed) {
          color: #f98f7a;
        }
        
        &.not-current-month:not(.completed) {
          color: var(--b3-theme-on-background);
        }
        &.not-current-month{
          opacity: 0.3;
        }
        
        &.past:not(.completed) {
          color: oklch(68.98% 0.161 30.76 / 0.3);
        }
        
        &.future:not(.completed) {
          color: var(--b3-list-hover);
        }
        
        .day-number {
          font-size: 14px;
        }
      }
    }
    
    .stats-actions {
      display: flex;
      flex-direction: column;
      margin-top: 60px;
      gap: 8px;
      width: 100%;
      
      .sy-button {
        width: 100%;
        min-width: auto;
      }
    }
  }
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: var(--b3-theme-background);
  border-radius: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  max-height: 90vh;
  overflow-y: auto;
  min-width: 400px;
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    
    h3 {
      margin: 0;
      font-size: 16px;
      color: var(--b3-theme-on-background);
    }
  }
  
  .modal-body {
    padding: 20px;
    
    .form-group {
      margin-bottom: 16px;
      
      label {
        display: block;
        margin-bottom: 4px;
        font-size: 14px;
        color: var(--b3-theme-on-background);
      }
    }
    
    .emoji-selector {
      position: relative;
      
      .emoji-grid {
        position: absolute;
        top: 100%;
        left: 0;
        background: var(--b3-theme-background);
        border: 1px solid var(--b3-border-color);
        border-radius: 4px;
        padding: 8px;
        z-index: 1001;
        width: 300px;
        max-height: 200px;
        overflow-y: auto;
      }
    }
  }
  
  .modal-footer {
    padding: 16px 20px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
}

.total-stats-panel {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 2;
  box-sizing: border-box;
  overflow-y: auto;
  display: flex;
  padding: 10px;
  flex-direction: column;
  --s: 20px; /* control the size*/
  --c1: #2a936a;
  --c2: #32a176;
  --_g: radial-gradient(calc(var(--s)/2),var(--c1) 97%,#0000);
  background:
    var(--_g),var(--_g) calc(2*var(--s)) calc(2*var(--s)),
    repeating-conic-gradient(from 45deg,#0000 0 25%,var(--c2) 0 50%) calc(-.707*var(--s)) calc(-.707*var(--s)),
    repeating-linear-gradient(135deg,var(--c1) calc(var(--s)/-2) calc(var(--s)/2),var(--c2) 0 calc(2.328*var(--s)));
  background-size: calc(4*var(--s)) calc(4*var(--s));
  
  /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
  -ms-overflow-style: none; /* IE å’Œ Edge */
  scrollbar-width: none; /* Firefox */
  
  &::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }
  
  .stats-header {
    display: flex;
    flex-direction: column;
    padding-bottom: 10px;
    
    .stats-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--b3-theme-background);
    }
    
    .stats-header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .stats-header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
  }
  .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
      
      .stat-item {
        text-align: center;
        border-radius: 24px;
        padding: 12px;
        
        .stat-value {
          font-size: 24px;
          font-weight: bold;
          color: #ffcb4c;
          margin-bottom: 4px;
          span {
            font-size: 12px;
          }
        }
        
        .stat-label {
          font-weight: bold;
          font-size: 12px;
          color: var(--b3-theme-background);
        }
      }
    }
    
    .heatmap-section {
      margin: 10px 0;
      padding: 15px;
      background: var(--b3-theme-background);
      border-radius: 12px;
      
      .heatmap-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      
      .heatmap-title {
        font-size: 14px;
        font-weight: bold;
        margin: 0;
        color: var(--b3-theme-on-background);
      }
      
      .heatmap-container {
        display: flex;
        flex-direction: column;
        align-items: stretch; /* è®©å­å…ƒç´ èƒ½å¤Ÿæ’‘æ»¡å®¹å™¨å®½åº¦ */
      }
      
      .heatmap-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 4px;
        width: fit-content;
        
        .heatmap-weekday {
          width: 13px;
          height: 13px;
          font-size: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--b3-scroll-color);
        }
      }
      
      .heatmap-grid {
        display: flex;
        flex-direction: row;
        gap: 1%;
        width: 100%; /* ç¡®ä¿å æ»¡çˆ¶å®¹å™¨å®½åº¦ */
        height: 100%;
        
        .heatmap-weekdays {
          display: flex;
          flex-direction: column;
          
          .heatmap-weekday {
            height: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
          }
        }
        
        .heatmap-days-container {
          display: flex;
          flex-direction: column;
          flex-grow: 1;
          width: 100%; /* ç¡®ä¿å æ»¡å¯ç”¨å®½åº¦ */
          height: 100%;
        }
        
        .heatmap-week-row {
          display: flex;
          flex-direction: row;
          gap: 1%; /* ä½¿ç”¨ç™¾åˆ†æ¯”é—´éš™ï¼Œé…åˆåŠ¨æ€æ–¹å—å¤§å° */
          margin-bottom: 4px; /* æ·»åŠ è¡Œä¸è¡Œä¹‹é—´çš„é—´éš™ */
        }
        
        .heatmap-day {
          width: calc(100% / 18); /* æ¯è¡Œ18ä¸ªæ–¹å—ï¼Œå¹³å‡åˆ†é…å®½åº¦ */
          height: 13px; /* å›ºå®šé«˜åº¦ä¸º24px */
          min-width: 8px;
          min-height: 8px;
          border-radius: 3px;
          transition: all 0.2s ease;
          
          &.intensity-0 {
            background-color: var(--b3-list-hover);
          }
          
          &.intensity-1 {
            background-color: rgba(252, 144, 121, 0.3);
          }
          
          &.intensity-2 {
            background-color: rgba(252, 144, 121, 0.5);
          }
          
          &.intensity-3 {
            background-color: rgba(252, 144, 121, 0.7);
          }
          
          &.intensity-4 {
            background-color: rgba(252, 144, 121, 1);
          }
        }
      }
      
      .heatmap-months {
        position: relative;
        height: 20px;
        margin-top: 4px;
        width: 100%; /* å æ»¡å®¹å™¨å®½åº¦ */
        
        .heatmap-month-label {
          position: absolute;
          font-size: 10px;
          color: var(--b3-scroll-color);
          white-space: nowrap;
          transform: translateX(-50%);
          top: 0;
        }
      }
      
      .heatmap-legend {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 10px;
        color: var(--b3-scroll-color);
        
        .legend-colors {
          display: flex;
          gap: 2px;
        }
        
        .legend-color {
          width: 10px;
          height: 10px;
          border-radius: 2px;
          
          &.intensity-0 {
            background-color: var(--b3-list-hover);
          }
          
          &.intensity-1 {
            background-color: rgba(252, 144, 121, 0.3);
          }
          
          &.intensity-2 {
            background-color: rgba(252, 144, 121, 0.5);
          }
          
          &.intensity-3 {
            background-color: rgba(252, 144, 121, 0.7);
          }
          
          &.intensity-4 {
            background-color: rgba(252, 144, 121, 1);
          }
        }
      }
    }
    .habits-stats-list {
    
    .habits-stats-title {
      font-size: 16px;
      font-weight: bold;
      margin: 10px 0;
      color: var(--b3-theme-background);
    }
    
    .habit-stat-item {
      background: var(--b3-theme-background);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      
      .habit-emoji-large {
        text-align: center;
        font-size: 32px;
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .habit-stat-content {
        flex: 1;
        
        .habit-stat-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 8px;
          
          .habit-emoji-large {
            text-align: center;
            font-size: 24px;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 8px;
          }
          
          .habit-name {
            font-weight: bold;
            color: var(--b3-theme-on-background);
            margin-right: auto;
            font-size: 16px;
            flex: 1;
          }
          
          .habit-created {
            font-size: 10px;
            color: var(--b3-theme-on-background);
            white-space: nowrap;
            background-color: var(--b3-list-hover);
            padding: 4px 10px;
            border-radius: 12px;
          }
          
          .habit-completion-rate {
            font-weight: bold;
            color: #ffcb4c;
            background: var(--b3-list-hover);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
          }
        }
        
        .habit-stat-details {
          display: flex;
          justify-content: space-between;
          
          .stat-detail-item {
            text-align: center;
            flex: 1;
            
            .stat-label {
              font-size: 10px;
              color: var(--b3-scroll-color);
              display: block;
            }
            
            .stat-value {
              font-weight: 600;
              color: var(--b3-theme-on-background);
              display: block;
              font-size: 18px;
            }
            .stat-value span{
              font-size: 12px;
            }
          }
        }
      }
    }
  }
  
  .stats-content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
}
.stats-panel{
  background-color: var(--Sv-theme-surface);
}

.habit-list-enter-active, .habit-list-leave-active {
  transition: all 0.3s ease;
}
.habit-list-enter-from, .habit-list-leave-to {
  opacity: 0;
  transform: translateY(30px);
}

.habit-card {
  transition: all 0.3s ease;
  transition-property: transform, opacity, height;
  transition-duration: 0.3s;
  transition-timing-function: ease;
  transition-delay: 0s;
  will-change: transform;
}
.today-calendar {
  margin-bottom: 20px;
  padding: 16px;
  background-color: var(--b3-theme-surface);
  border: 1px solid var(--b3-border-color);
  border-radius: var(--b3-border-radius);
  box-shadow: var(--b3-point-shadow);
  
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--b3-border-color);
    
    h3 {
      margin: 0;
      font-size: 16px;
      color: var(--b3-theme-on-background);
    }
    
    .calendar-actions {
      display: flex;
      gap: 8px;
      
      .sy-button {
        min-width: 40px;
      }
    }
  }
  
  .calendar-day {
    .day-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 8px 0;
      
      .day-date {
        font-size: 18px;
        font-weight: bold;
        color: var(--b3-theme-on-background);
      }
      
      .day-weather {
        font-size: 16px;
      }
    }
    
    .day-habits {
      .habit-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin-bottom: 8px;
        background-color: var(--b3-list-background);
        border-radius: 4px;
        
        &:last-child {
          margin-bottom: 0;
        }
        
        .habit-emoji {
          margin-right: 8px;
          font-size: 18px;
        }
        
        .habit-name {
          flex: 1;
          color: var(--b3-theme-on-background);
        }
        
        .sy-checkbox {
          margin-left: auto;
        }
      }
      
      .no-habits {
        text-align: center;
        padding: 20px;
        color: var(--b3-font-color3);
        font-style: italic;
      }
    }
  }
}

/* å†…è”ç•ªèŒ„é’Ÿæ ·å¼ */
.pomodoro-inline-display {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-around;
  padding: 8px;
  background-color: var(--b3-list-hover);
  border-radius: 8px;
  margin: 0 8px 8px;
}

.pomodoro-timer-inline {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.timer-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}

.pomodoro-timer-inline .timer {
  position: absolute;
  font-size: 18px;
  font-weight: bold;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 70%;
  height: 70%;
  border-radius: 50%;
  background-color: var(--b3-theme-background);
  z-index: 1;
}

.pomodoro-timer-inline .progress-ring {
  width: 100px;
  height: 100px;
  transform: rotate(-90deg);
  position: relative;
  z-index: 0;
  
  circle {
    fill: none;
    stroke-width: 8;
  }
  
  .progress-ring__bg {
    stroke: var(--b3-list-hover);
  }
  
  .progress-ring__progress {
    stroke: #f98f7a;
    stroke-linecap: round;
    transition: stroke-dashoffset 1s ease-in-out;
    transform-origin: 50% 50%;
    
    &.pomodoro-running {
      stroke: #f98f7a;
    }
    
    &.pomodoro-short-break {
      stroke: #3498db;
    }
    
    &.pomodoro-long-break {
      stroke: #2ecc71;
    }
  }
}

.pomodoro-controls-inline {
  display: flex;
  gap: 12px;
}

.pomodoro-controls-inline .stop-btn {
  background-color: #e74c3c;
  color: var(--b3-theme-background);
  border: none;
  border-radius: 8px;
  padding: 10px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pomodoro-controls-inline .pause-btn {
  background-color: #f39c12;
  color: var(--b3-theme-background);
  border: none;
  border-radius: 8px;
  padding: 10px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}



.pomodoro-button {
  margin-right: 8px;
}

.pomodoro-controls-inline .resume-btn {
  background-color: #27ae60;
  color: var(--b3-theme-background);
  border: none;
  border-radius: 8px;
  padding: 10px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.mood-calendar-panel {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 2;
  box-sizing: border-box;
  overflow-y: auto;
  display: flex;
  padding: 10px;
  flex-direction: column;
  --s: 20px; /* control the size*/
  --c1: #2a936a;
  --c2: #32a176;
  --_g: radial-gradient(calc(var(--s)/2),var(--c1) 97%,#0000);
  background:
    var(--_g),var(--_g) calc(2*var(--s)) calc(2*var(--s)),
    repeating-conic-gradient(from 45deg,#0000 0 25%,var(--c2) 0 50%) calc(-.707*var(--s)) calc(-.707*var(--s)),
    repeating-linear-gradient(135deg,var(--c1) calc(var(--s)/-2) calc(var(--s)/2),var(--c2) 0 calc(2.328*var(--s)));
  background-size: calc(4*var(--s)) calc(4*var(--s));
  
  /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
  -ms-overflow-style: none; /* IE å’Œ Edge */
  scrollbar-width: none; /* Firefox */
  
  &::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }
  
  .stats-header {
    display: flex;
    flex-direction: column;
    padding-bottom: 10px;
    
    .stats-emoji {
      font-size: 86px;
      align-self: center;
      height: 150px;
    }
    
    .stats-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--b3-theme-background);
    }
    
    .stats-header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      
      .stats-title {
        margin: 0;
        color: var(--b3-theme-background);
      }
      
      .icon-button {
        width: 28px;
        height: 28px;
        border: none;
        background: none;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        
        .icon {
          width: 16px;
          height: 16px;
          color: var(--b3-theme-background);
          fill: var(--b3-theme-background);
        }
        
        &:hover {
          background-color: var(--b3-list-hover);
          border-radius: 4px;
        }
      }
    }
  }
  
  .stats-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    
    .calendar-container {
      background-color: var(--b3-theme-background);
      padding: 16px 16px 8px 16px;
      border-radius: 24px;
      box-shadow: rgba(0, 0, 0, 0.06) 0px 1px 5px 0px;
      
      .calendar-controls {
        margin-bottom: 16px;
        padding: 8px;
        background: var(--b3-list-background);
        border-radius: 4px;
        
        .calendar-navigation {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          width: 100%;
          
          .nav-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            
            &:hover {
              background-color: var(--b3-list-hover);
            }
            
            &:active {
              background-color: var(--b3-list-hover);
            }
          }
          
          .current-period {
            text-align: center;
            font-size: 14px;
            flex: 1;
            font-weight: 600;
          }
        }
      }
    }
    
    .calendar-view {
      flex: 1;
      margin-bottom: 20px;
      
      .month-view {
        .weekdays-header {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          text-align: center;
          font-weight: bold;
          margin-bottom: 8px;
          color: var(--b3-theme-on-surface);
          gap: 8px;
          font-size: 12px;
        }
        
        .month-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 14px;
          
          .day {
            position: relative;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 30%;
            background: var(--b3-list-background);
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            
            &.not-current-month:not(.completed) {
              color: var(--b3-theme-on-background);
            }
            
            &.not-current-month {
              opacity: 0.3;
            }
            
            .day-number {
              font-size: 14px;
            }
            
            .mood-emoji-large {
              display: flex;
              align-items: center;
              justify-content: center;
              width: 70%;
              height: 70%;
              
              svg {
                width: 100%;
                height: 100%;
              }
            }
          }
        }
      }
    }
    .mood-list-container {
      margin-top: 20px;
      background: var(--b3-list-background);
      border-radius: 8px;
      
      .mood-list-title {
        margin: 0 0 12px 0;
        font-size: 14px;
        font-weight: bold;
        color: var(--b3-theme-on-surface);
      }
      
      .mood-list {
        display: flex;
        flex-direction: column;
      }
      
      .mood-list-item {
        display: flex;
        align-items: flex-start;
        padding: 16px 0;
        background: var(--b3-theme-background);
        border-radius: 6px;
        position: relative;
        
        &::before {
          content: '';
          position: absolute;
          top: 0;
          left: 7px;
          height: 100%;
          width: 2px;
          background: radial-gradient(circle at center, var(--b3-theme-on-background) 1px, transparent 1px);
          background-size: 2px 5px;
          background-repeat: repeat-y;
          opacity: 0.3;
        }
        
        .mood-list-date {
          font-size: 14px;
          font-weight: bold;
          color: var(--b3-theme-on-background);
          min-width: 30px;
          position: relative;
          z-index: 1;
          background: var(--b3-theme-background);
        }
        
        .mood-list-emoji {
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          
          svg {
            width: 100%;
            height: 100%;
          }
        }
        
        .mood-list-content {
          flex: 1;
          display: flex;
          flex-direction: row;
          gap: 8px;
          background-color: var(--b3-list-hover);
          border-radius: 12px;
          margin-top: -8px;
          padding: 8px;
        }
        
        .mood-list-note {
          flex: 1;
          font-size: 13px;
          color: var(--b3-theme-on-surface);
          word-break: break-word;
        }
      }
    }
    
    .mood-stats-container {
      margin-bottom: 20px;
      background: var(--b3-theme-background);
      border-radius: 16px;
      padding: 16px 0;
      
      .mood-stats-chart {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        height: 150px;
        padding: 10px 0;
        
        .mood-stat-item {
          display: flex;
          flex-direction: column;
          align-items: center;
          flex: 1;
          
          .mood-stat-emoji {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            
            svg {
              width: 100%;
              height: 100%;
            }
          }
          
          .mood-stat-count {
            font-size: 12px;
            font-weight: bold;
            color: var(--b3-theme-on-surface);
            margin-bottom: 4px;
          }
          
          .mood-stat-bar-container {
            width: 30px;
            height: 100px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 4px;
            position: relative;
            
            .mood-stat-bar {
              width: 100%;
              border-radius: 10px;
              position: absolute;
              bottom: 0;
              transition: height 0.5s ease;
            }
            
            .mood-stat-bar-excited {
              background-color: #fdd07d;
            }
            
            .mood-stat-bar-happy {
              background-color: #8aae97;
            }
            
            .mood-stat-bar-calm {
              background-color: #89b0bc;
            }
            
            .mood-stat-bar-sad {
              background-color: #f192c9;
            }
            
            .mood-stat-bar-angry {
              background-color: #fc8f7b;
            }
          }
        }
      }
    }
  }
}

/* è‡ªå®šä¹‰æç¤ºæ¡†æ ·å¼ */
.custom-tooltip {
  position: fixed;
  background-color: var(--b3-theme-background);
  color: var(--b3-theme-on-background);
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 14px;
  max-width: 300px;
  word-wrap: break-word;
  z-index: 1000;
  pointer-events: none;
  backdrop-filter: blur(4px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

</style>